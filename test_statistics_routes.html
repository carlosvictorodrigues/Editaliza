<!DOCTYPE html>
<html>
<head>
    <title>Test Statistics Routes - Phase 6</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .route { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .method { color: #28a745; font-weight: bold; }
        .path { color: #007bff; font-family: monospace; }
        .description { color: #6c757d; margin-top: 5px; }
        .critical { color: #dc3545; font-weight: bold; }
        h1 { color: #007bff; }
        h2 { color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 5px; }
        .test-btn { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px; }
        .test-btn:hover { background: #0056b3; }
        #results { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h1>üìä Phase 6: Statistics Routes - Migration Verification</h1>
    
    <h2>üîç Migrated Statistics Routes</h2>
    
    <div class="route">
        <div><span class="method">GET</span> <span class="path">/api/plans/:planId/statistics</span></div>
        <div class="description">Complex statistics with CTE and recursive queries for study streaks</div>
        <div class="critical">‚ö†Ô∏è CRITICAL: Contains recursive CTE - DO NOT SIMPLIFY</div>
        <button class="test-btn" onclick="testRoute('/api/plans/1/statistics')">Test Route</button>
    </div>
    
    <div class="route">
        <div><span class="method">GET</span> <span class="path">/api/plans/:planId/detailed_progress</span></div>
        <div class="description">Complex detailed progress analytics with time breakdowns</div>
        <div class="critical">‚ö†Ô∏è CRITICAL: Contains complex JOINs and aggregations - preserve exactly</div>
        <button class="test-btn" onclick="testRoute('/api/plans/1/detailed_progress')">Test Route</button>
    </div>
    
    <div class="route">
        <div><span class="method">GET</span> <span class="path">/api/plans/:planId/share-progress</span></div>
        <div class="description">Statistics for sharing progress with gamification</div>
        <button class="test-btn" onclick="testRoute('/api/plans/1/share-progress')">Test Route</button>
    </div>
    
    <div class="route">
        <div><span class="method">GET</span> <span class="path">/api/plans/:planId/goal_progress</span></div>
        <div class="description">Get daily and weekly question goal progress statistics</div>
        <button class="test-btn" onclick="testRoute('/api/plans/1/goal_progress')">Test Route</button>
    </div>
    
    <div class="route">
        <div><span class="method">GET</span> <span class="path">/api/plans/:planId/question_radar</span></div>
        <div class="description">Question radar - identify weak points with complex query</div>
        <div class="critical">‚ö†Ô∏è CRITICAL: Contains complex JOIN and HAVING - preserve exactly</div>
        <button class="test-btn" onclick="testRoute('/api/plans/1/question_radar')">Test Route</button>
    </div>
    
    <h2>üîß System Metrics Route</h2>
    
    <div class="route">
        <div><span class="method">GET</span> <span class="path">/metrics</span></div>
        <div class="description">System metrics endpoint (protected)</div>
        <button class="test-btn" onclick="testRoute('/metrics')">Test Route</button>
    </div>
    
    <h2>üìã Migration Summary</h2>
    <ul>
        <li>‚úÖ <strong>Complex CTE Queries:</strong> Recursive query for study streaks preserved character-by-character</li>
        <li>‚úÖ <strong>Complex JOINs:</strong> Multi-table joins with aggregations preserved</li>
        <li>‚úÖ <strong>Performance Queries:</strong> All GROUP BY, HAVING, ORDER BY clauses maintained</li>
        <li>‚úÖ <strong>Analytics Logic:</strong> Activity breakdown calculations preserved</li>
        <li>‚úÖ <strong>Date Calculations:</strong> Brazilian timezone calculations maintained</li>
        <li>‚úÖ <strong>Gamification Logic:</strong> Level and achievement calculations preserved</li>
    </ul>
    
    <h2>üß™ Quick Route Tests</h2>
    <p><em>Note: These tests will fail without authentication, but they verify route structure</em></p>
    <button class="test-btn" onclick="testAllRoutes()">Test All Routes</button>
    <button class="test-btn" onclick="clearResults()">Clear Results</button>
    
    <div id="results"></div>

    <script>
        function testRoute(path) {
            const baseUrl = window.location.origin;
            const fullUrl = baseUrl + path;
            
            fetch(fullUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                const status = response.status;
                const statusText = response.statusText;
                
                let message = '';
                let className = '';
                
                if (status === 401) {
                    message = '‚úÖ Route structure OK (' + status + ' - Authentication required as expected)';
                    className = 'success';
                } else if (status === 404) {
                    message = '‚ùå Route not found (' + status + ' - Check route registration)';
                    className = 'error';
                } else if (status >= 200 && status < 300) {
                    message = '‚úÖ Route accessible (' + status + ')';
                    className = 'success';
                } else {
                    message = '‚ö†Ô∏è Unexpected status (' + status + ' - ' + statusText + ')';
                    className = 'error';
                }
                
                addResult(path + ': ' + message, className);
            })
            .catch(error => {
                addResult(path + ': ‚ùå Connection error - ' + error.message, 'error');
            });
        }
        
        function testAllRoutes() {
            var routes = [
                '/api/plans/1/statistics',
                '/api/plans/1/detailed_progress', 
                '/api/plans/1/share-progress',
                '/api/plans/1/goal_progress',
                '/api/plans/1/question_radar',
                '/metrics'
            ];
            
            clearResults();
            addResult('üß™ Testing all statistics routes...', '');
            
            for(var i = 0; i < routes.length; i++) {
                (function(route, index) {
                    setTimeout(function() { testRoute(route); }, index * 200);
                })(routes[i], i);
            }
        }
        
        function addResult(message, className) {
            var results = document.getElementById('results');
            var div = document.createElement('div');
            div.className = className;
            div.textContent = message;
            results.appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        // Show current server info
        window.onload = function() {
            addResult('üåê Testing against: ' + window.location.origin, '');
            addResult('üìÖ Test date: ' + new Date().toLocaleString(), '');
            addResult('üí° Note: Routes should return 401 (Authentication Required) which indicates proper setup', '');
        }
    </script>
</body>
</html>
