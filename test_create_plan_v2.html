<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Teste Criar Plano - V2</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { margin: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #output { margin-top: 20px; border: 1px solid #ccc; padding: 10px; min-height: 200px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Teste de Cria√ß√£o de Plano - V2</h1>
    
    <div>
        <h3>Credenciais de Teste:</h3>
        <input type="email" id="email" placeholder="Email" value="p@p.com">
        <input type="password" id="password" placeholder="Senha" value="123456">
    </div>
    
    <button id="login">1. Fazer Login</button>
    <button id="verify">2. Verificar Token</button>
    <button id="create">3. Criar Plano</button>
    <button id="list">4. Listar Planos</button>
    <button id="clear">Limpar</button>
    
    <div id="output"></div>

    <script>
        let token = localStorage.getItem('editaliza_token');
        const output = document.getElementById('output');
        
        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            output.innerHTML += `<p class="${type}">[${time}] ${msg}</p>`;
            output.scrollTop = output.scrollHeight;
            console.log(msg);
        }
        
        if (token) {
            log(`Token existente encontrado: ${token.substring(0, 30)}...`, 'info');
        }

        document.getElementById('clear').addEventListener('click', () => {
            output.innerHTML = '';
        });

        document.getElementById('login').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            log(`üì§ Tentando login com: ${email}`, 'info');
            
            try {
                const res = await fetch('http://localhost:3000/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if (res.ok && data.token) {
                    token = data.token;
                    localStorage.setItem('editaliza_token', token);
                    log(`‚úÖ Login OK!`, 'success');
                    log(`Token: ${token.substring(0, 30)}...`, 'info');
                    log(`User ID: ${data.user?.id || 'N/A'}`, 'info');
                } else {
                    log(`‚ùå Login falhou: ${JSON.stringify(data)}`, 'error');
                }
            } catch (err) {
                log(`‚ùå Erro no login: ${err.message}`, 'error');
            }
        });

        document.getElementById('verify').addEventListener('click', () => {
            if (!token) {
                log('‚ùå Nenhum token dispon√≠vel', 'error');
                return;
            }
            
            // Decodificar JWT (parte payload)
            try {
                const parts = token.split('.');
                const payload = JSON.parse(atob(parts[1]));
                log(`üìã Token Payload:`, 'info');
                log(`- ID: ${payload.id}`, 'info');
                log(`- Email: ${payload.email}`, 'info');
                log(`- Emitido: ${new Date(payload.iat * 1000).toLocaleString()}`, 'info');
                log(`- Expira: ${new Date(payload.exp * 1000).toLocaleString()}`, 'info');
                
                const now = Date.now() / 1000;
                if (payload.exp < now) {
                    log(`‚ö†Ô∏è TOKEN EXPIRADO!`, 'error');
                } else {
                    log(`‚úÖ Token v√°lido por mais ${Math.round((payload.exp - now) / 60)} minutos`, 'success');
                }
            } catch (err) {
                log(`‚ùå Erro ao decodificar token: ${err.message}`, 'error');
            }
        });

        document.getElementById('create').addEventListener('click', async () => {
            if (!token) {
                log('‚ùå Fa√ßa login primeiro!', 'error');
                return;
            }
            
            const planName = `Teste ${new Date().toLocaleTimeString()}`;
            const examDate = new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0];
            
            log(`üì§ Criando plano: "${planName}"`, 'info');
            log(`Data da prova: ${examDate}`, 'info');
            
            try {
                const res = await fetch('http://localhost:3000/api/plans', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        plan_name: planName,
                        exam_date: examDate
                    })
                });
                
                log(`üì• Response: ${res.status} ${res.statusText}`, res.ok ? 'success' : 'error');
                
                const data = await res.json();
                
                if (res.ok) {
                    log(`‚úÖ Plano criado com sucesso!`, 'success');
                    log(`ID do novo plano: ${data.newPlanId}`, 'info');
                } else {
                    log(`‚ùå Erro: ${JSON.stringify(data)}`, 'error');
                    
                    if (res.status === 401) {
                        log('‚ö†Ô∏è Status 401 - Isso causa logout no app!', 'error');
                        log('Poss√≠veis causas:', 'info');
                        log('1. Token expirado', 'info');
                        log('2. JWT_SECRET diferente', 'info');
                        log('3. Token malformado', 'info');
                    }
                }
            } catch (err) {
                log(`‚ùå Erro na requisi√ß√£o: ${err.message}`, 'error');
            }
        });

        document.getElementById('list').addEventListener('click', async () => {
            if (!token) {
                log('‚ùå Fa√ßa login primeiro!', 'error');
                return;
            }
            
            log(`üì§ Listando planos...`, 'info');
            
            try {
                const res = await fetch('http://localhost:3000/api/plans', {
                    headers: { 
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                log(`üì• Response: ${res.status} ${res.statusText}`, res.ok ? 'success' : 'error');
                
                const data = await res.json();
                
                if (res.ok) {
                    if (Array.isArray(data)) {
                        log(`‚úÖ ${data.length} planos encontrados:`, 'success');
                        data.forEach(plan => {
                            log(`- [${plan.id}] ${plan.plan_name} (Prova: ${plan.exam_date})`, 'info');
                        });
                    } else {
                        log(`Resposta inesperada: ${JSON.stringify(data)}`, 'error');
                    }
                } else {
                    log(`‚ùå Erro: ${JSON.stringify(data)}`, 'error');
                }
            } catch (err) {
                log(`‚ùå Erro na requisi√ß√£o: ${err.message}`, 'error');
            }
        });
    </script>
</body>
</html>