# üß™ GUIA DE TESTES - INTEGRA√á√ÉO DO SISTEMA MODULAR\n\n## üìã OVERVIEW\n\nEste guia fornece scripts e procedimentos para testar a integra√ß√£o do sistema modular e garantir que todas as funcionalidades estejam operando corretamente.\n\n## üöÄ PREPARA√á√ÉO PARA TESTES\n\n### 1. Instalar depend√™ncias (se necess√°rio)\n```bash\nnpm install winston winston-daily-rotate-file xss\n```\n\n### 2. Criar diret√≥rios necess√°rios\n```bash\nmkdir -p logs\nmkdir -p uploads\nmkdir -p backups\n```\n\n### 3. Configurar vari√°veis de ambiente\n```bash\n# Criar .env.test\ncp .env.example .env.test\n\n# Configurar para testes\necho \"NODE_ENV=development\" >> .env.test\necho \"LOG_LEVEL=debug\" >> .env.test\necho \"LOG_SQL=true\" >> .env.test\n```\n\n## üîß SCRIPTS DE TESTE\n\n### Script 1: Teste de Configura√ß√£o\n```bash\n# Criar arquivo de teste\ncat > test_config.js << 'EOF'\nconst appConfig = require('./src/config/app.config');\n\nconsole.log('üîß Testando configura√ß√£o...');\nconsole.log('Environment:', appConfig.environment.NODE_ENV);\nconsole.log('Features:', Object.keys(appConfig.features).filter(f => appConfig.features[f]));\nconsole.log('JWT Config:', {\n    algorithm: appConfig.security.jwt.algorithm,\n    expiresIn: appConfig.security.jwt.expiresIn\n});\nconsole.log('‚úÖ Configura√ß√£o carregada com sucesso!');\nEOF\n\n# Executar teste\nnode test_config.js\n```\n\n### Script 2: Teste do Sistema de Logging\n```bash\n# Criar arquivo de teste\ncat > test_logging.js << 'EOF'\nconst { createLogger, authLogger, systemLogger } = require('./src/utils/logger');\n\nconsole.log('üìù Testando sistema de logging...');\n\n// Teste de logger b√°sico\nconst logger = createLogger('test');\nlogger.info('Teste de log info');\nlogger.warn('Teste de log warning');\nlogger.error('Teste de log error');\nlogger.debug('Teste de log debug');\n\n// Teste de loggers especializados\nauthLogger.info('Teste de auth logger');\nsystemLogger.info('Teste de system logger');\n\n// Teste de performance\nconst timer = logger.timer('operacao_teste');\nsetTimeout(() => {\n    timer.end({ resultado: 'sucesso' });\n}, 100);\n\n// Teste de logging de seguran√ßa\nlogger.security('teste_evento_seguranca', {\n    ip: '127.0.0.1',\n    userId: 123\n});\n\nconsole.log('‚úÖ Sistema de logging testado!');\nconsole.log('üìÅ Verifique os logs em: ./logs/');\nEOF\n\n# Executar teste\nnode test_logging.js\n\n# Verificar logs gerados\nls -la logs/\ntail -n 10 logs/app-$(date +%Y-%m-%d).log\n```\n\n### Script 3: Teste do Middleware de Valida√ß√£o\n```bash\n# Criar arquivo de teste\ncat > test_validation.js << 'EOF'\nconst express = require('express');\nconst request = require('supertest');\nconst { sanitizeMiddleware, validators, handleValidationErrors } = require('./src/middleware/validation.middleware');\n\nconst app = express();\napp.use(express.json());\napp.use(sanitizeMiddleware);\n\n// Rota de teste com valida√ß√£o\napp.post('/test', \n    [\n        validators.email('email'),\n        validators.password('password'),\n        validators.name('name', { required: false })\n    ],\n    handleValidationErrors,\n    (req, res) => {\n        res.json({ success: true, data: req.validatedData });\n    }\n);\n\n// Rota para testar sanitiza√ß√£o\napp.post('/test-sanitize', (req, res) => {\n    res.json({ received: req.body });\n});\n\n// Executar testes\nasync function runTests() {\n    console.log('üõ°Ô∏è  Testando middleware de valida√ß√£o...');\n    \n    // Teste 1: Dados v√°lidos\n    console.log('\\n1. Testando dados v√°lidos:');\n    const validResponse = await request(app)\n        .post('/test')\n        .send({\n            email: 'test@example.com',\n            password: 'Test123!@#',\n            name: 'Jo√£o Silva'\n        });\n    console.log('Status:', validResponse.status);\n    console.log('Response:', validResponse.body);\n    \n    // Teste 2: Dados inv√°lidos\n    console.log('\\n2. Testando dados inv√°lidos:');\n    const invalidResponse = await request(app)\n        .post('/test')\n        .send({\n            email: 'email-inv√°lido',\n            password: '123', // muito curta\n            name: '<script>alert(1)</script>' // XSS attempt\n        });\n    console.log('Status:', invalidResponse.status);\n    console.log('Errors:', invalidResponse.body.details);\n    \n    // Teste 3: Sanitiza√ß√£o XSS\n    console.log('\\n3. Testando sanitiza√ß√£o XSS:');\n    const xssResponse = await request(app)\n        .post('/test-sanitize')\n        .send({\n            malicious: '<script>alert(\"XSS\")</script>',\n            sqlInjection: \"'; DROP TABLE users; --\",\n            normal: 'texto normal'\n        });\n    console.log('Sanitized:', xssResponse.body.received);\n    \n    console.log('\\n‚úÖ Testes de valida√ß√£o conclu√≠dos!');\n}\n\nrunTests().catch(console.error);\nEOF\n\n# Executar teste (precisa do supertest)\nnpm install --save-dev supertest\nnode test_validation.js\n```\n\n### Script 4: Teste do Sistema de Autentica√ß√£o\n```bash\n# Criar arquivo de teste\ncat > test_auth.js << 'EOF'\nconst { \n    generateToken, \n    validateToken, \n    createSession,\n    tokenBlacklist,\n    sessionManager\n} = require('./src/middleware/auth.middleware');\n\nasync function testAuth() {\n    console.log('üîê Testando sistema de autentica√ß√£o...');\n    \n    // Teste 1: Gera√ß√£o de token\n    console.log('\\n1. Testando gera√ß√£o de token:');\n    const payload = {\n        id: 123,\n        email: 'test@example.com',\n        role: 'user',\n        sessionId: 'test-session'\n    };\n    \n    const token = generateToken(payload);\n    console.log('Token gerado:', token.substring(0, 50) + '...');\n    \n    // Teste 2: Valida√ß√£o de token\n    console.log('\\n2. Testando valida√ß√£o de token:');\n    try {\n        const decoded = await validateToken(token);\n        console.log('Token v√°lido! Payload:', decoded);\n    } catch (error) {\n        console.log('Erro na valida√ß√£o:', error.message);\n    }\n    \n    // Teste 3: Blacklist de tokens\n    console.log('\\n3. Testando blacklist:');\n    console.log('Token blacklisted?', tokenBlacklist.isBlacklisted(token));\n    \n    // Adicionar √† blacklist\n    const decoded = JSON.parse(Buffer.from(token.split('.')[1], 'base64').toString());\n    tokenBlacklist.add(token, decoded.exp);\n    console.log('Token ap√≥s blacklist:', tokenBlacklist.isBlacklisted(token));\n    \n    // Teste 4: Gerenciamento de sess√µes\n    console.log('\\n4. Testando sess√µes:');\n    const sessionId = createSession(123);\n    console.log('Sess√£o criada:', sessionId);\n    console.log('Sess√£o v√°lida?', sessionManager.isValidSession(123, sessionId));\n    console.log('Sess√µes ativas para usu√°rio 123:', sessionManager.getSessionCount(123));\n    \n    console.log('\\n‚úÖ Testes de autentica√ß√£o conclu√≠dos!');\n}\n\ntestAuth().catch(console.error);\nEOF\n\n# Executar teste\nnode test_auth.js\n```\n\n## üåê TESTES DE API\n\n### 1. Teste de Health Check\n```bash\n# Iniciar servidor em uma janela\nnpm run dev\n\n# Em outra janela, testar health check\ncurl -s http://localhost:3000/health | jq .\n\n# Ou se n√£o tiver jq:\ncurl http://localhost:3000/health\n```\n\n### 2. Teste das Rotas de Autentica√ß√£o\n```bash\n# Teste 1: Obter token CSRF\necho \"üî∞ Testando CSRF token...\"\ncsrf_response=$(curl -s http://localhost:3000/api/auth/csrf-token)\necho $csrf_response\n\n# Teste 2: Tentar registro (vai falhar sem DB, mas deve validar input)\necho \"\\nüìù Testando registro...\"\ncurl -X POST http://localhost:3000/api/auth/register \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"email\": \"test@example.com\",\n    \"password\": \"Test123!@#\",\n    \"confirmPassword\": \"Test123!@#\",\n    \"name\": \"Jo√£o Teste\",\n    \"acceptTerms\": true\n  }'\n\n# Teste 3: Tentar login\necho \"\\nüîë Testando login...\"\ncurl -X POST http://localhost:3000/api/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"email\": \"test@example.com\",\n    \"password\": \"Test123!@#\"\n  }'\n\n# Teste 4: Testar valida√ß√£o com dados inv√°lidos\necho \"\\n‚ùå Testando dados inv√°lidos...\"\ncurl -X POST http://localhost:3000/api/auth/register \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"email\": \"email-inv√°lido\",\n    \"password\": \"123\",\n    \"name\": \"<script>alert(1)</script>\"\n  }'\n```\n\n### 3. Teste de Rate Limiting\n```bash\n# Script para testar rate limiting\necho \"üö¶ Testando rate limiting...\"\n\nfor i in {1..10}; do\n  echo \"Tentativa $i:\"\n  response=$(curl -s -o /dev/null -w \"%{http_code}\" \\\n    -X POST http://localhost:3000/api/auth/login \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\"email\":\"test\",\"password\":\"test\"}')\n  \n  echo \"Status: $response\"\n  \n  if [ \"$response\" = \"429\" ]; then\n    echo \"‚úÖ Rate limiting funcionando!\"\n    break\n  fi\n  \n  sleep 1\ndone\n```\n\n## üìä MONITORAMENTO DE LOGS\n\n### 1. Monitorar logs em tempo real\n```bash\n# Em uma janela separada\ntail -f logs/app-$(date +%Y-%m-%d).log\n\n# Filtrar apenas erros\ntail -f logs/error-$(date +%Y-%m-%d).log\n\n# Filtrar logs de seguran√ßa\ntail -f logs/app-$(date +%Y-%m-%d).log | grep -i security\n```\n\n### 2. An√°lise de logs\n```bash\n# Contar tipos de log por n√≠vel\ngrep -o '\"level\":\"[^\"]*\"' logs/app-$(date +%Y-%m-%d).log | sort | uniq -c\n\n# Ver logs de autentica√ß√£o\ngrep -i 'auth' logs/app-$(date +%Y-%m-%d).log\n\n# Ver tentativas de ataques detectados\ngrep -i 'malicious\\|security\\|blacklist' logs/app-$(date +%Y-%m-%d).log\n```\n\n## üß™ TESTES DE CARGA\n\n### 1. Teste b√°sico com curl\n```bash\n# Criar script de carga\ncat > load_test.sh << 'EOF'\n#!/bin/bash\necho \"üîÑ Executando teste de carga...\"\n\nfor i in {1..100}; do\n  curl -s http://localhost:3000/health > /dev/null &\n  \n  if [ $((i % 10)) -eq 0 ]; then\n    echo \"Requisi√ß√µes enviadas: $i\"\n  fi\ndone\n\nwait\necho \"‚úÖ Teste de carga conclu√≠do!\"\nEOF\n\nchmod +x load_test.sh\n./load_test.sh\n```\n\n### 2. Verificar performance nos logs\n```bash\n# Ver requisi√ß√µes lentas\ngrep -i 'performance\\|slow' logs/app-$(date +%Y-%m-%d).log\n\n# Estat√≠sticas de resposta\ngrep 'HTTP Request' logs/app-$(date +%Y-%m-%d).log | \\\n  grep -o 'duration\":\"[^\"]*' | \\\n  cut -d'\"' -f3 | \\\n  sort -n\n```\n\n## ‚úÖ CHECKLIST DE VALIDA√á√ÉO\n\n### Funcionalidades B√°sicas:\n- [ ] Configura√ß√£o carrega sem erros\n- [ ] Logs s√£o gerados corretamente\n- [ ] Sanitiza√ß√£o funciona (XSS blocked)\n- [ ] Valida√ß√£o rejeita dados inv√°lidos\n- [ ] Health check responde\n- [ ] Rate limiting ativa ap√≥s limite\n\n### Seguran√ßa:\n- [ ] Tokens JWT s√£o gerados/validados\n- [ ] Blacklist de tokens funciona\n- [ ] Sess√µes s√£o gerenciadas\n- [ ] Padr√µes maliciosos s√£o detectados\n- [ ] IPs maliciosos s√£o bloqueados\n- [ ] Headers de seguran√ßa presentes\n\n### Performance:\n- [ ] Logs n√£o impactam performance\n- [ ] Middleware n√£o adiciona lat√™ncia significativa\n- [ ] Rate limiting n√£o bloqueia users leg√≠timos\n- [ ] Rota√ß√£o de logs funciona\n\n### Integra√ß√£o:\n- [ ] C√≥digo existente continua funcionando\n- [ ] Rotas antigas ainda respondem\n- [ ] Middleware existente n√£o conflita\n- [ ] Banco de dados conecta normalmente\n\n## üö® TROUBLESHOOTING\n\n### Problemas Comuns:\n\n1. **\"Cannot find module 'winston'\"**\n   ```bash\n   npm install winston winston-daily-rotate-file\n   ```\n\n2. **\"Permission denied\" nos logs**\n   ```bash\n   chmod 755 logs/\n   chown -R $USER:$USER logs/\n   ```\n\n3. **\"JWT_SECRET is required\"**\n   ```bash\n   echo \"JWT_SECRET=$(openssl rand -base64 64)\" >> .env\n   echo \"SESSION_SECRET=$(openssl rand -base64 64)\" >> .env\n   ```\n\n4. **Rate limiting muito agressivo**\n   ```bash\n   # Ajustar no app.config.js ou via env\n   echo \"RATE_LIMIT_MAX=1000\" >> .env\n   ```\n\n5. **Logs muito verbosos**\n   ```bash\n   echo \"LOG_LEVEL=warn\" >> .env\n   echo \"LOG_SQL=false\" >> .env\n   ```\n\n### Comandos de Diagn√≥stico:\n```bash\n# Verificar se servidor est√° rodando\nlsof -i :3000\n\n# Verificar uso de mem√≥ria\nps aux | grep node\n\n# Verificar logs de erro do sistema\njournalctl -u your-app-name --since \"1 hour ago\"\n\n# Testar conectividade\ntelnet localhost 3000\n```\n\n## üìà M√âTRICAS DE SUCESSO\n\n### Ap√≥s a integra√ß√£o bem-sucedida, voc√™ deve ver:\n\n1. **Logs estruturados** em `./logs/`\n2. **Performance similar** ao sistema anterior\n3. **Todas as rotas funcionando** (antigas e novas)\n4. **Detec√ß√£o de ataques** nos logs\n5. **Rate limiting ativo** mas n√£o invasivo\n6. **Health checks OK**\n7. **Zero downtime** durante a migra√ß√£o\n\n---\n\n**üí° DICA**: Execute os testes em ambiente de desenvolvimento primeiro, depois em staging, e s√≥ ent√£o em produ√ß√£o!\n\n**‚ö†Ô∏è IMPORTANTE**: Mantenha backups do c√≥digo antes de aplicar qualquer mudan√ßa!"