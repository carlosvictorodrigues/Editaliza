<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes do Plano - Editaliza</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/footer.css" rel="stylesheet">
    <!-- SCRIPTS CENTRALIZADOS -->
    <script src="js/app.js"></script>
    <script src="js/components.js"></script>
    <!-- Config do Tailwind para reconhecer as cores customizadas -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'editaliza-blue': '#0528f2',
                        'editaliza-green': '#1ad937',
                        'editaliza-black': '#0d0d0d',
                        'editaliza-gray': '#969696',
                    }
                }
            }
        }
    </script>
    <style>
        .tooltip { 
            position: relative; 
            display: inline-flex; 
            align-items: center;
            margin-left: 8px;
        }
        .tooltip .tooltiptext {
            visibility: hidden; 
            width: 250px; 
            background-color: #1e293b; /* slate-800 */
            color: #fff; 
            text-align: center;
            border-radius: 6px; 
            padding: 8px; 
            position: absolute; 
            z-index: 10;
            bottom: 140%; 
            left: 50%; 
            margin-left: -125px; /* Metade da largura */
            opacity: 0; 
            transition: opacity 0.3s;
            font-size: 0.75rem; 
            line-height: 1.25;
            font-weight: 400;
        }
        .tooltip:hover .tooltiptext { 
            visibility: visible; 
            opacity: 1; 
        }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-header.open + .accordion-content {
             /* A altura ser√° definida via JS para garantir a anima√ß√£o correta */
        }
        .accordion-header.open svg { transform: rotate(180deg); }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: all 0.3s ease; }
        .historic-date-input { display: none; }
        .topic-item.show-date .historic-date-input { display: block; }
        
        /* Estilos para o guia e progress indicators */
        .step-highlight {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }
        
        .template-discipline-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .goal-preset {
            transition: all 0.2s ease;
        }
        
        .goal-preset:hover {
            transform: translateY(-1px);
        }
        
        @keyframes pulse-blue {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        }
        
        .pulse-blue {
            animation: pulse-blue 2s infinite;
        }
        
        /* Melhorias visuais para os indicadores de progresso */
        #progress-indicator {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* Anima√ß√µes suaves para elementos do guia */
        .guide-element {
            transition: all 0.3s ease;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">
    <!-- NAVEGA√á√ÉO PRINCIPAL (GERADA PELO JS) -->
    <div id="main-nav-container"></div>

    <!-- Modal para Edi√ß√£o/Exclus√£o -->
    <div id="editModal" class="modal-overlay hidden fixed inset-0 bg-editaliza-black bg-opacity-70 z-30 flex items-center justify-center p-4 opacity-0">
        <div class="modal-container bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg transform scale-95">
            <h2 id="editModalTitle" class="text-2xl font-bold text-editaliza-black"></h2>
            <div id="editModalBody" class="mt-4"></div>
        </div>
    </div>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl">
        <!-- CABE√áALHO DO PLANO (GERADO PELO JS) -->
        <div id="plan-header-container"></div>
        
        <!-- Welcome Message Aprimorado -->
        <div id="welcome-message" class="hidden bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 text-gray-800 p-6 rounded-xl mb-8 shadow-lg">
            <div class="flex items-start space-x-4">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <span class="text-2xl">üéâ</span>
                    </div>
                </div>
                <div class="flex-grow">
                    <h3 class="text-xl font-bold text-green-800 mb-2">Parab√©ns! Seu plano foi criado com sucesso!</h3>
                    <p class="text-gray-700 mb-4">Agora vamos configurar seu plano passo a passo. N√£o se preocupe, vou te guiar em cada etapa.</p>
                    
                    <!-- Progress Steps -->
                    <div class="bg-white rounded-lg p-4 border border-green-200">
                        <h4 class="font-semibold text-gray-700 mb-3">Pr√≥ximos passos:</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center text-gray-600">
                                <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold mr-3">1</span>
                                Adicione suas disciplinas e t√≥picos
                            </div>
                            <div class="flex items-center text-gray-500">
                                <span class="w-6 h-6 bg-gray-100 text-gray-400 rounded-full flex items-center justify-center text-xs font-bold mr-3">2</span>
                                Configure seus hor√°rios de estudo
                            </div>
                            <div class="flex items-center text-gray-500">
                                <span class="w-6 h-6 bg-gray-100 text-gray-400 rounded-full flex items-center justify-center text-xs font-bold mr-3">3</span>
                                Defina suas metas de quest√µes
                            </div>
                            <div class="flex items-center text-gray-500">
                                <span class="w-6 h-6 bg-gray-100 text-gray-400 rounded-full flex items-center justify-center text-xs font-bold mr-3">4</span>
                                Gerar seu cronograma personalizado
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex items-center justify-between">
                        <button id="startGuideBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            üöÄ Iniciar Tour Guiado
                        </button>
                        <button id="skipGuideBtn" class="text-gray-500 hover:text-gray-700 text-sm underline">
                            Pular e configurar sozinho
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Guia de Progresso Fixo -->
        <div id="progress-indicator" class="hidden sticky top-4 z-20 bg-white border border-gray-200 rounded-lg shadow-lg p-4 mb-6">
            <div class="flex items-center justify-between text-sm">
                <span class="font-medium text-gray-700">Progresso da Configura√ß√£o:</span>
                <span id="progress-text" class="text-blue-600 font-bold">0/4 completo</span>
            </div>
            <div class="mt-2 bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                 <div class="content-card" id="step-1-content">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                            <span class="text-2xl mr-3">üìö</span>Conte√∫do Program√°tico
                        </h2>
                        <div class="hidden" id="step-1-indicator">
                            <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Passo 1/4</span>
                        </div>
                    </div>
                    
                    <!-- Dicas para Primeira Vez -->
                    <div id="first-time-tips" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start space-x-3">
                            <span class="text-2xl">üí°</span>
                            <div>
                                <h3 class="font-semibold text-yellow-800 mb-2">Primeira vez configurando? Aqui est√£o algumas dicas!</h3>
                                <ul class="text-sm text-yellow-700 space-y-1">
                                    <li>‚Ä¢ <strong>Disciplinas:</strong> Adicione as mat√©rias do seu edital (ex: Direito Constitucional, Matem√°tica)</li>
                                    <li>‚Ä¢ <strong>Prioridade:</strong> 5 = muito importante, 1 = menos importante</li>
                                    <li>‚Ä¢ <strong>T√≥picos:</strong> Divida cada disciplina em assuntos menores para melhor controle</li>
                                    <li>‚Ä¢ <strong>J√° estudou?</strong> Marque os t√≥picos j√° vistos para ajustar o cronograma</li>
                                </ul>
                                <div class="mt-3">
                                    <button id="showExampleBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium underline">
                                        üëÅÔ∏è Ver exemplo pr√°tico
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Exemplo Pr√°tico Modal -->
                    <div id="exampleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-96 overflow-y-auto">
                            <div class="p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-gray-800">Exemplo: Direito Constitucional</h3>
                                    <button id="closeExampleBtn" class="text-gray-400 hover:text-gray-600">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="text-sm text-gray-700">
                                    <p class="mb-3"><strong>Disciplina:</strong> Direito Constitucional | <strong>Prioridade:</strong> 5 (muito importante)</p>
                                    <p class="mb-2"><strong>T√≥picos sugeridos:</strong></p>
                                    <div class="bg-gray-50 p-3 rounded-lg text-xs">
                                        1. Princ√≠pios Fundamentais (Art. 1¬∫ ao 4¬∫)<br>
                                        2. Direitos e Garantias Fundamentais<br>
                                        3. Organiza√ß√£o do Estado<br>
                                        4. Poder Legislativo<br>
                                        5. Poder Executivo<br>
                                        6. Poder Judici√°rio<br>
                                        7. Controle de Constitucionalidade
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-slate-50 to-blue-50 p-6 rounded-xl border border-blue-200 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">üéØ Adicionar Disciplina e T√≥picos</h3>
                            <button id="loadTemplateBtn" class="text-blue-600 hover:bg-blue-100 px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                                üóÇÔ∏è Usar Template
                            </button>
                        </div>
                        
                        <!-- Templates de Disciplinas -->
                        <div id="disciplineTemplates" class="hidden mb-4 p-4 bg-white rounded-lg border">
                            <h4 class="font-medium text-gray-700 mb-3">Templates Populares:</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <button class="template-discipline-btn text-left p-2 hover:bg-gray-50 rounded border" data-name="Direito Constitucional" data-priority="5" data-topics="1. Princ√≠pios Fundamentais (Art. 1¬∫ ao 4¬∫)
2. Direitos e Garantias Fundamentais
3. Organiza√ß√£o do Estado
4. Poder Legislativo
5. Poder Executivo
6. Poder Judici√°rio
7. Controle de Constitucionalidade">
                                    <div class="font-medium text-gray-700">Direito Constitucional</div>
                                    <div class="text-xs text-gray-500">7 t√≥picos principais</div>
                                </button>
                                <button class="template-discipline-btn text-left p-2 hover:bg-gray-50 rounded border" data-name="Matem√°tica" data-priority="4" data-topics="1. Aritm√©tica e Conjuntos
2. √Ålgebra e Fun√ß√µes
3. Geometria Plana
4. Geometria Espacial
5. Trigonometria
6. An√°lise Combinat√≥ria
7. Probabilidade e Estat√≠stica">
                                    <div class="font-medium text-gray-700">Matem√°tica</div>
                                    <div class="text-xs text-gray-500">7 t√≥picos essenciais</div>
                                </button>
                                <button class="template-discipline-btn text-left p-2 hover:bg-gray-50 rounded border" data-name="Portugu√™s" data-priority="5" data-topics="1. Ortografia e Acentua√ß√£o
2. Morfologia e Classes de Palavras
3. Sintaxe do Per√≠odo Simples
4. Sintaxe do Per√≠odo Composto
5. Concordancia Nominal e Verbal
6. Reg√™ncia e Crase
7. Interpreta√ß√£o de Textos">
                                    <div class="font-medium text-gray-700">L√≠ngua Portuguesa</div>
                                    <div class="text-xs text-gray-500">7 t√≥picos fundamentais</div>
                                </button>
                                <button class="template-discipline-btn text-left p-2 hover:bg-gray-50 rounded border" data-name="Inform√°tica" data-priority="3" data-topics="1. Conceitos de Hardware e Software
2. Sistemas Operacionais
3. Microsoft Office (Word, Excel, PowerPoint)
4. Internet e Seguran√ßa
5. Banco de Dados B√°sicos">
                                    <div class="font-medium text-gray-700">Inform√°tica</div>
                                    <div class="text-xs text-gray-500">5 t√≥picos essenciais</div>
                                </button>
                            </div>
                        </div>
                        
                        <form id="newContentForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="md:col-span-2">
                                    <label for="subject_name" class="block text-sm font-medium text-gray-700 mb-1">
                                        Nome da Disciplina <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="subject_name" class="form-input" placeholder="Ex: Direito Constitucional" required>
                                    <p class="text-xs text-gray-500 mt-1">üìù Use o nome exato do edital</p>
                                </div>
                                <div>
                                    <label for="priority_weight" class="block text-sm font-medium text-gray-700 mb-1">
                                        Prioridade
                                        <span class="tooltip">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <span class="tooltiptext">5 = Prioridade m√°xima (maior peso no cronograma)<br>1 = Prioridade m√≠nima</span>
                                        </span>
                                    </label>
                                    <select id="priority_weight" class="form-input" required>
                                        <option value="5">üî¥ 5 - Muito Importante</option>
                                        <option value="4">üü† 4 - Importante</option>
                                        <option value="3" selected>üü° 3 - M√©dio</option>
                                        <option value="2">üü¢ 2 - Baixo</option>
                                        <option value="1">‚ö™ 1 - Muito Baixo</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label for="topics_list" class="block text-sm font-medium text-gray-700 mb-1">
                                    T√≥picos da Disciplina
                                    <span class="tooltip">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        <span class="tooltiptext">Divida a disciplina em t√≥picos menores.<br>Um t√≥pico por linha.<br>Exemplo: "1. Princ√≠pios Fundamentais"</span>
                                    </span>
                                </label>
                                <textarea id="topics_list" class="form-input" rows="6" placeholder="1. Princ√≠pios Fundamentais
2. Direitos e Garantias Fundamentais
3. Organiza√ß√£o do Estado
4. Poder Legislativo
..."></textarea>
                                <div class="flex items-center justify-between mt-2">
                                    <p class="text-xs text-gray-500">üìù Um t√≥pico por linha | Deixe em branco para adicionar depois</p>
                                    <span id="topicCount" class="text-xs text-blue-600 font-medium">0 t√≥picos</span>
                                </div>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button type="submit" class="btn-primary py-3 flex-grow">
                                    <span class="flex items-center justify-center">
                                        <span class="mr-2">‚ûï</span>
                                        Adicionar Disciplina
                                    </span>
                                </button>
                                <button type="button" id="previewBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-3 rounded-lg font-medium transition-colors">
                                    üëÅÔ∏è Preview
                                </button>
                            </div>
                        </form>
                    </div>

                    <div id="batch-save-container" class="hidden sticky top-2 z-10 mb-4">
                        <button id="batch-save-topics-btn" class="w-full btn-primary py-3 px-4 text-lg font-bold shadow-lg animate-pulse">
                            Salvar Altera√ß√µes nos T√≥picos
                        </button>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-700 mt-8 mb-2">Disciplinas Cadastradas</h3>
                    <p class="text-sm text-gray-500 mb-4">
                        Marque os t√≥picos que voc√™ j√° estudou e informe a data de conclus√£o para que o sistema ajuste seu cronograma e estat√≠sticas. Lembre-se de salvar o progresso para cada disciplina.
                    </p>
                    <div id="subjectsContainer" class="space-y-4"></div>
                 </div>
            </div>

            <div class="lg:col-span-1 space-y-8">
                <div class="content-card" id="step-2-content">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">Configura√ß√µes Gerais</h2>
                        <div class="hidden" id="step-2-indicator">
                            <span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Passo 2/4</span>
                        </div>
                    </div>
                    <form id="generalSettingsForm" class="space-y-6">
                        <div>
                            <h3 class="font-semibold text-gray-600 border-b pb-2 mb-3">Estrutura de Estudo</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-700 flex items-center">
                                        Horas de estudo por dia
                                        <span class="tooltip">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-editaliza-blue cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                            <span class="tooltiptext">Defina suas horas dispon√≠veis. S√°bados s√£o priorizados para revis√µes e domingos para reda√ß√£o/descanso.</span>
                                        </span>
                                    </label>
                                    <div id="hours-grid" class="grid grid-cols-4 gap-2 text-center mt-2"></div>
                                </div>
                                <div>
                                    <label for="session_duration" class="text-sm font-medium text-gray-700 flex items-center">
                                        Dura√ß√£o da Sess√£o (minutos)
                                        <span class="tooltip">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-editaliza-blue cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                            <span class="tooltiptext">Recomendamos 50 min para foco total (T√©cnica Pomodoro), seguido por um descanso de 10 min.</span>
                                        </span>
                                    </label>
                                    <input type="number" id="session_duration" class="form-input" value="50" min="10">
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-600 border-b pb-2 mb-3">Estrutura de Fim de Semana</h3>
                            <div class="flex items-center p-3 bg-slate-50 rounded-lg border">
                                <input id="has_essay" name="has_essay" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-editaliza-blue focus:ring-editaliza-blue">
                                <label for="has_essay" class="ml-3 block text-sm font-medium text-gray-700">
                                    Incluir Reda√ß√£o aos Domingos
                                    <span class="tooltip">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-editaliza-blue cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        <span class="tooltiptext">Ao marcar, o sistema reservar√° os domingos para sess√µes de reda√ß√£o. Se desmarcado, os domingos ser√£o dias de descanso.</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div id="step-3-content">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold text-gray-600">Metas de Quest√µes</h3>
                                <div class="hidden" id="step-3-indicator">
                                    <span class="bg-orange-100 text-orange-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Passo 3/4</span>
                                </div>
                            </div>
                            <div class="border-b pb-3 mb-3"></div>
                            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                                <div class="flex items-start space-x-2">
                                    <span class="text-blue-600">üéØ</span>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-medium mb-1">Dica de Ouro:</p>
                                        <p>Para concursos: 30-50 quest√µes/dia. Para ENEM: 20-30 quest√µes/dia. Ajuste conforme seu ritmo!</p>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="daily_goal" class="text-sm font-medium text-gray-700 flex items-center">
                                        Meta Di√°ria
                                        <span class="tooltip">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <span class="tooltiptext">N√∫mero de quest√µes que voc√™ pretende resolver por dia. Seja realista!</span>
                                        </span>
                                    </label>
                                    <input type="number" id="daily_goal" class="form-input" value="50" min="0">
                                    <div class="mt-1 flex space-x-2">
                                        <button type="button" class="goal-preset text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded" data-daily="20" data-weekly="140">Iniciante (20/dia)</button>
                                        <button type="button" class="goal-preset text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded" data-daily="40" data-weekly="280">Intermedi√°rio (40/dia)</button>
                                        <button type="button" class="goal-preset text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded" data-daily="60" data-weekly="420">Avan√ßado (60/dia)</button>
                                    </div>
                                </div>
                                <div>
                                    <label for="weekly_goal" class="text-sm font-medium text-gray-700">Meta Semanal</label>
                                    <input type="number" id="weekly_goal" class="form-input" value="300" min="0" readonly>
                                    <p class="text-xs text-gray-500 mt-1">Calculado automaticamente: meta di√°ria √ó 7</p>
                                </div>
                            </div>
                        </div>
                        <div class="pt-4 space-y-3" id="step-4-content">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold text-gray-600">Finalizar Configura√ß√£o</h3>
                                <div class="hidden" id="step-4-indicator">
                                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Passo 4/4</span>
                                </div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg mb-4">
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-600">‚úÖ</span>
                                    <p class="text-sm font-medium text-green-800">Tudo pronto! Agora √© s√≥ gerar seu cronograma personalizado.</p>
                                </div>
                            </div>
                            <div class="bg-red-50 border-2 border-red-200 rounded-xl p-4 mb-4">
                                <div class="flex items-start space-x-3">
                                    <input type="checkbox" id="retaFinalMode" class="w-5 h-5 text-red-600 bg-white border-red-300 rounded focus:ring-red-500 focus:ring-2">
                                    <div>
                                        <label for="retaFinalMode" class="text-lg font-bold text-red-700">üö® Modo Reta Final</label>
                                        <p class="text-sm text-red-600 mt-2">Prioriza mat√©rias mais importantes quando o tempo √© curto. T√≥picos menos relevantes podem ficar de fora.</p>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn-secondary mb-2">Salvar Configura√ß√µes</button>
                            <button id="generateButton" type="button" class="btn-primary group">
                                <span class="flex items-center justify-center">
                                    <span class="mr-2">üöÄ</span>
                                    Gerar Meu Cronograma!
                                    <span class="ml-2 transform group-hover:translate-x-1 transition-transform">‚ú®</span>
                                </span>
                            </button>
                            <p class="text-xs text-center text-gray-500 mt-2">
                                üìä Vou criar um cronograma otimizado baseado em suas configura√ß√µes
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const planId = urlParams.get('id');
        const isNewPlan = urlParams.get('new') === 'true';
        const hasGuide = urlParams.get('guide') === 'true';
        const editModal = document.getElementById('editModal');
        
        let pendingTopicChanges = {};

        // Estado do guia e progresso
        let guideState = {
            isActive: false,
            currentStep: 1,
            completedSteps: [],
            totalSteps: 4
        };
        
        // Atualizar progresso
        function updateProgress() {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressIndicator = document.getElementById('progress-indicator');
            
            if (!progressBar) return; 
            
            let completedCount = 0;
            
            // Verificar disciplinas adicionadas
            if (document.querySelectorAll('#subjectsContainer .accordion-header').length > 0) {
                completedCount++;
                guideState.completedSteps.push(1);
            }
            
            // Verificar configura√ß√µes de hor√°rio
            const hoursInputs = document.querySelectorAll('.hours-input');
            let hasHoursSet = false;
            hoursInputs.forEach(input => {
                if (parseInt(input.value) > 0) hasHoursSet = true;
            });
            if (hasHoursSet) {
                completedCount++;
                guideState.completedSteps.push(2);
            }
            
            // Verificar metas
            const dailyGoal = document.getElementById('daily_goal');
            if (dailyGoal && parseInt(dailyGoal.value) > 0) {
                completedCount++;
                guideState.completedSteps.push(3);
            }
            
            // Se tudo estiver pronto
            if (completedCount >= 3) {
                completedCount = 4;
                guideState.completedSteps.push(4);
            }
            
            const progressPercent = (completedCount / 4) * 100;
            progressBar.style.width = progressPercent + '%';
            progressText.textContent = `${completedCount}/4 completo`;
            
            if (guideState.isActive) {
                progressIndicator.classList.remove('hidden');
            }
        }
        
        // Mostrar indicadores de passo
        function showStepIndicators() {
            const indicators = ['step-1-indicator', 'step-2-indicator', 'step-3-indicator', 'step-4-indicator'];
            indicators.forEach((id, index) => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.remove('hidden');
                }
            });
        }
        
        // Fun√ß√£o para determinar cores dos badges de peso dos t√≥picos
        function getTopicWeightColor(weight) {
            switch (weight) {
                case 5: return 'bg-red-100 text-red-700'; // Muito Alto - Vermelho
                case 4: return 'bg-orange-100 text-orange-700'; // Alto - Laranja  
                case 3: return 'bg-yellow-100 text-yellow-700'; // M√©dio - Amarelo
                case 2: return 'bg-green-100 text-green-700'; // Baixo - Verde
                case 1: return 'bg-gray-100 text-gray-600'; // Muito Baixo - Cinza
                default: return 'bg-yellow-100 text-yellow-700'; // Padr√£o m√©dio
            }
        }

        // Fun√ß√£o para determinar cores dos badges de peso das disciplinas
        function getSubjectWeightColor(weight) {
            switch (weight) {
                case 5: return 'bg-red-100 text-red-800 font-semibold'; // Muito Alto - Vermelho
                case 4: return 'bg-orange-100 text-orange-800 font-semibold'; // Alto - Laranja  
                case 3: return 'bg-yellow-100 text-yellow-800 font-medium'; // M√©dio - Amarelo
                case 2: return 'bg-green-100 text-green-800'; // Baixo - Verde
                case 1: return 'bg-gray-100 text-gray-700'; // Muito Baixo - Cinza
                default: return 'bg-yellow-100 text-yellow-800 font-medium'; // Padr√£o m√©dio
            }
        }

        // Iniciar tour guiado
        function startGuide() {
            guideState.isActive = true;
            showStepIndicators();
            updateProgress();
            
            // Mostrar dicas para primeira vez
            const firstTimeTips = document.getElementById('first-time-tips');
            if (firstTimeTips) {
                firstTimeTips.classList.remove('hidden');
            }
            
            // Scroll suave para o conte√∫do
            document.getElementById('step-1-content').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        function openModal() {
            editModal.classList.remove('hidden');
            setTimeout(() => {
                editModal.classList.remove('opacity-0');
                editModal.querySelector('.modal-container').classList.remove('scale-95');
            }, 10);
        }

        function closeModal() {
            editModal.classList.add('opacity-0');
            editModal.querySelector('.modal-container').classList.add('scale-95');
            setTimeout(() => {
                editModal.classList.add('hidden');
                document.getElementById('editModalBody').innerHTML = '';
            }, 300);
        }
        
        async function initialize() {
            components.renderMainNavigation('dashboard.html');
            if (!planId) { window.location.href = 'dashboard.html'; return; }
            
            if (isNewPlan) { 
                document.getElementById('welcome-message').classList.remove('hidden'); 
                
                // Se veio com guia ativado
                if (hasGuide) {
                    setTimeout(() => {
                        startGuide();
                    }, 1000);
                }
            }
            
            renderHoursInputs();
            app.showSpinner();
            try {
                const plan = await app.apiFetch(`/plans/${planId}`);
                components.renderPlanHeader(planId, plan.plan_name, 'plan_settings.html');
                
                document.getElementById('daily_goal').value = plan.daily_question_goal;
                document.getElementById('weekly_goal').value = plan.weekly_question_goal;
                document.getElementById('session_duration').value = plan.session_duration_minutes;
                document.getElementById('has_essay').checked = !!plan.has_essay;
                
                // Carregar o valor do Modo Reta Final
                const retaFinalCheckbox = document.getElementById('retaFinalMode');
                if (retaFinalCheckbox) {
                    const isRetaFinal = plan.reta_final_mode === 1 || plan.reta_final_mode === true || plan.reta_final_mode === '1';
                    retaFinalCheckbox.checked = isRetaFinal;
                    console.log('üîç Plan_settings - Carregando modo Reta Final:', plan.reta_final_mode, '-> checkbox:', isRetaFinal);
                }

                if (plan.study_hours_per_day) {
                    const hoursInputs = document.querySelectorAll('.hours-input');
                    hoursInputs.forEach(input => {
                        const day = input.dataset.day;
                        if (plan.study_hours_per_day[day] !== undefined) {
                            input.value = plan.study_hours_per_day[day];
                        }
                    });
                }
                await loadSubjects();
            } catch (error) {
                app.showToast('Erro ao carregar dados do plano: ' + error.message, 'error');
            } finally {
                app.hideSpinner();
            }
        }

        function renderHoursInputs() {
            const grid = document.getElementById('hours-grid');
            const days = [{d:1,l:'Seg'}, {d:2,l:'Ter'}, {d:3,l:'Qua'}, {d:4,l:'Qui'}, {d:5,l:'Sex'}, {d:6,l:'S√°b'}, {d:0,l:'Dom'}];
            grid.innerHTML = days.map(day => `
                <div>
                    <label class="text-xs font-medium text-gray-500">${day.l}</label>
                    <input type="number" class="form-input py-2 text-center hours-input" data-day="${day.d}" value="${(day.d >= 1 && day.d <= 5) ? 4 : (day.d === 6 ? 2 : 0)}" min="0" max="24">
                </div>
            `).join('');
        }

        let loadingSubjects = false;
        async function loadSubjects() {
            if (loadingSubjects) {
                console.log('üîÑ LoadSubjects j√° em execu√ß√£o, ignorando...');
                return;
            }
            loadingSubjects = true;
            try {
                const subjectsWithTopics = await app.apiFetch(`/plans/${planId}/subjects_with_topics`);
                const container = document.getElementById('subjectsContainer');
                container.innerHTML = '';

                if (subjectsWithTopics.length === 0) {
                    container.innerHTML = `<div class="text-center p-6 bg-yellow-50 border border-yellow-200 rounded-lg"><p class="text-yellow-800">Nenhuma disciplina cadastrada.</p></div>`;
                    return;
                }

                subjectsWithTopics.forEach(subject => {
                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = 'bg-white rounded-xl border border-gray-200 shadow-sm';
                    subjectDiv.innerHTML = `
                        <div class="accordion-header flex justify-between items-center p-4 cursor-pointer hover:bg-slate-50 rounded-t-xl">
                            <div class="flex-grow">
                                <h3 class="text-lg font-semibold text-gray-800">${subject.subject_name}</h3>
                                <div class="flex items-center mt-1">
                                    <span class="text-sm text-editaliza-gray mr-2">Prioridade:</span>
                                    <span class="text-xs px-2 py-1 rounded-full ${getSubjectWeightColor(subject.priority_weight)}">${subject.priority_weight}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 flex-shrink-0">
                                <button class="edit-subject-btn p-2 rounded-md hover:bg-gray-200" data-subject-id="${subject.id}" data-subject-name="${subject.subject_name}" data-priority="${subject.priority_weight}" title="Editar Disciplina">‚úèÔ∏è</button>
                                <button class="delete-subject-btn p-2 rounded-md hover:bg-gray-200" data-subject-id="${subject.id}" data-subject-name="${subject.subject_name}" title="Apagar Disciplina">üóëÔ∏è</button>
                                <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="p-4">
                                <ul id="topics-for-${subject.id}" class="space-y-2 text-gray-700"></ul>
                            </div>
                             <div class="p-4 mt-4 border-t bg-slate-50 rounded-b-xl">
                                <button class="save-progress-btn w-full bg-editaliza-green hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow" data-subject-id="${subject.id}">
                                    Salvar Progresso da Disciplina
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(subjectDiv);

                    const list = subjectDiv.querySelector(`#topics-for-${subject.id}`);
                    const topics = subject.topics;
                    const todayStr = new Date().toISOString().split('T')[0];

                    list.innerHTML = topics.length > 0
                        ? topics.map(topic => {
                            const isCompleted = topic.status === 'Conclu√≠do';
                            const completionDate = topic.completion_date || todayStr;
                            const showDateClass = isCompleted ? 'show-date' : '';
                            return `
                            <li class="topic-item flex justify-between items-start group p-2 rounded-md hover:bg-gray-50 ${showDateClass}" data-topic-id="${topic.id}">
                                <div class="flex-grow">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-editaliza-blue focus:ring-editaliza-blue topic-checkbox" data-topic-id="${topic.id}" ${isCompleted ? 'checked' : ''}>
                                        <span class="ml-3 topic-description">${topic.description}</span>
                                        <span class="ml-2 text-xs px-2 py-1 rounded-full topic-priority-badge ${getTopicWeightColor(topic.priority_weight || 3)}">P${topic.priority_weight || 3}</span>
                                    </label>
                                    <div class="historic-date-input ml-7 mt-2">
                                        <label class="text-xs text-gray-500">Data de conclus√£o:</label>
                                        <input type="date" value="${completionDate}" class="form-input p-1 max-w-xs" data-topic-id="${topic.id}">
                                    </div>
                                </div>
                                <div class="space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button class="edit-topic-btn p-1 rounded-md hover:bg-gray-200" data-topic-id="${topic.id}" data-description="${topic.description}" data-priority="${topic.priority_weight || 3}">‚úèÔ∏è</button>
                                    <button class="delete-topic-btn p-1 rounded-md hover:bg-gray-200" data-topic-id="${topic.id}" data-description="${topic.description}">üóëÔ∏è</button>
                                </div>
                            </li>`
                        }).join('')
                        : '<li class="text-gray-500 list-none">Nenhum t√≥pico adicionado.</li>';
                });

            } catch (error) {
                app.showToast('Erro ao carregar disciplinas.', 'error');
            } finally {
                loadingSubjects = false;
            }
        }
        
        function getSettingsFromForm() {
            const settings = {
                daily_question_goal: document.getElementById('daily_goal').value,
                weekly_question_goal: document.getElementById('weekly_goal').value,
                session_duration_minutes: document.getElementById('session_duration').value,
                has_essay: document.getElementById('has_essay').checked,
                reta_final_mode: document.getElementById('retaFinalMode').checked,
                study_hours_per_day: {}
            };
            document.querySelectorAll('.hours-input').forEach(input => {
                settings.study_hours_per_day[input.dataset.day] = parseInt(input.value, 10) || 0;
            });
            return settings;
        }

        function showRetaFinalReport(excludedTopics, prioritizedSubjects) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4';
            
            const excludedBySubject = excludedTopics.reduce((acc, topic) => {
                if (!acc[topic.subject_name]) {
                    acc[topic.subject_name] = [];
                }
                acc[topic.subject_name].push(topic.description);
                return acc;
            }, {});
            
            const totalIncluded = (prioritizedSubjects.length > 0) ? 'Calculando...' : 'N/A';
            const totalExcluded = excludedTopics.length;
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-red-700 flex items-center">üéØ Relat√≥rio do Modo Reta Final</h2>
                        <button class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                            <div class="text-2xl font-bold text-green-600">${totalIncluded}</div>
                            <div class="text-sm text-green-700">T√≥picos Priorizados</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                            <div class="text-2xl font-bold text-red-600">${totalExcluded}</div>
                            <div class="text-sm text-red-700">T√≥picos Exclu√≠dos</div>
                        </div>
                    </div>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                        <h3 class="font-semibold text-blue-800 mb-2">üí° Como funciona a prioriza√ß√£o?</h3>
                        <p class="text-sm text-blue-700">O algoritmo usa a f√≥rmula: <strong>(Peso da Disciplina √ó 10) + Peso do Assunto</strong></p>
                        <p class="text-xs text-blue-600 mt-1">Exemplo: Direito Constitucional (peso 5) + Direitos Fundamentais (prioridade 5) = 55 pontos</p>
                    </div>
                    ${prioritizedSubjects.length > 0 ? `
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-green-800 mb-3 flex items-center">‚úÖ Disciplinas Priorizadas</h3>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    ${prioritizedSubjects.map(s => `
                                        <div class="flex items-center justify-between bg-white p-2 rounded border">
                                            <span class="text-sm text-green-800 font-medium">${s.name}</span>
                                            <span class="text-xs bg-green-200 text-green-700 px-2 py-1 rounded">Peso ${s.weight}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    ${totalExcluded > 0 ? `
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-red-800 mb-3 flex items-center">‚ö†Ô∏è T√≥picos Exclu√≠dos por Tempo Limitado</h3>
                            <div class="space-y-3">
                                ${Object.entries(excludedBySubject).map(([subject, topics]) => `
                                    <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                        <h4 class="font-semibold text-red-800 mb-2">${subject} (${topics.length} t√≥picos)</h4>
                                        <div class="max-h-32 overflow-y-auto">
                                            <ul class="space-y-1">
                                                ${topics.map(topic => `<li class="text-sm text-red-700">‚Ä¢ ${topic}</li>`).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
                            <h3 class="font-semibold text-yellow-800 mb-2">üìù Estrat√©gias de Estudo</h3>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                <li>‚Ä¢ <strong>Prioridade m√°xima:</strong> Foque nos t√≥picos do cronograma</li>
                                <li>‚Ä¢ <strong>Tempo extra:</strong> Estude os exclu√≠dos nas disciplinas mais importantes</li>
                                <li>‚Ä¢ <strong>Revis√£o r√°pida:</strong> Fa√ßa leitura din√¢mica dos t√≥picos exclu√≠dos</li>
                                <li>‚Ä¢ <strong>Quest√µes:</strong> Resolva quest√µes dos t√≥picos exclu√≠dos se sobrar tempo</li>
                            </ul>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 mb-4">
                            <button id="exportExclusionsCsv" class="btn-secondary text-sm px-4 py-2">üìÑ Exportar Lista (CSV)</button>
                            <button id="viewOnSchedule" class="bg-blue-500 hover:bg-blue-600 text-white text-sm px-4 py-2 rounded-lg transition-colors">üìÖ Ver no Cronograma</button>
                        </div>
                    ` : ''}
                    <div class="text-center">
                        <button id="closeModal" class="btn-primary px-6 py-2">Entendi, Fechar</button>
                    </div>
                </div>`;
                
            const closeBtn = modal.querySelector('#closeModal');
            const xBtn = modal.querySelector('button');
            const exportBtn = modal.querySelector('#exportExclusionsCsv');
            const viewBtn = modal.querySelector('#viewOnSchedule');
            const closeModal = () => modal.remove();
            closeBtn?.addEventListener('click', closeModal);
            xBtn?.addEventListener('click', closeModal);
            if (exportBtn) {
                exportBtn.addEventListener('click', () => exportExclusionsAsCsv(excludedTopics));
            }
            if (viewBtn) {
                viewBtn.addEventListener('click', () => window.open(`cronograma.html?id=${planId}`, '_blank'));
            }
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            document.body.appendChild(modal);
        }
        
        function exportExclusionsAsCsv(excludedTopics) {
            let csvContent = 'Disciplina,T√≥pico,Motivo\n';
            excludedTopics.forEach(topic => {
                csvContent += `"${topic.subject_name}","${topic.description}","Tempo insuficiente - Modo Reta Final"\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `topicos_excluidos_reta_final_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            app.showToast('üìÑ Lista exportada com sucesso!', 'success');
        }
        
        function handleEditSubject(id, name, priority) {
            document.getElementById('editModalTitle').textContent = 'Editar Disciplina';
            document.getElementById('editModalBody').innerHTML = `<form id="editSubjectForm" data-id="${id}" class="space-y-4"><div><label for="edit_subject_name" class="block text-sm font-medium text-gray-700">Nome</label><input type="text" id="edit_subject_name" value="${name}" class="form-input" required></div><div><label for="edit_priority_weight" class="block text-sm font-medium text-gray-700">Prioridade</label><input type="number" id="edit_priority_weight" value="${priority}" min="1" max="5" class="form-input" required></div><div class="flex justify-end space-x-3 pt-4"><button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 btn-cancel">Cancelar</button><button type="submit" class="btn-primary py-2 px-4 text-sm">Salvar</button></div></form>`;
            openModal();
            document.getElementById('editSubjectForm').addEventListener('submit', submitEditSubject);
        }

        function handleDeleteSubject(id, name) {
            document.getElementById('editModalTitle').textContent = 'Apagar Disciplina';
            document.getElementById('editModalBody').innerHTML = `<p>Voc√™ tem certeza que deseja apagar a disciplina "<strong>${name}</strong>"?</p><p class="mt-2 text-sm text-red-600">Aten√ß√£o: Todos os t√≥picos e o progresso associado ser√£o permanentemente removidos.</p><div class="flex justify-end space-x-3 pt-4 mt-4"><button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 btn-cancel">Cancelar</button><button id="confirmDeleteSubject" data-id="${id}" class="btn-danger px-4 py-2 text-sm">Sim, Apagar</button></div>`;
            openModal();
            document.getElementById('confirmDeleteSubject').addEventListener('click', submitDeleteSubject);
        }

        function handleEditTopic(id, description, priority = 3) {
            originalTopicState = { id, description, priority };
            document.getElementById('editModalTitle').textContent = 'Editar T√≥pico';
            const modalBody = document.getElementById('editModalBody');
            modalBody.innerHTML = `
                <form id="editTopicForm" data-id="${id}" class="space-y-4">
                    <div>
                        <label for="edit_topic_description" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
                        <textarea id="edit_topic_description" class="form-input" rows="4" required>${description}</textarea>
                    </div>
                    <div>
                        <label for="edit_topic_priority" class="block text-sm font-medium text-gray-700">Peso do Assunto</label>
                        <select id="edit_topic_priority" class="form-input" required>
                            <option value="1" ${priority == 1 ? 'selected' : ''}>1 - Muito Baixa</option>
                            <option value="2" ${priority == 2 ? 'selected' : ''}>2 - Baixa</option>
                            <option value="3" ${priority == 3 ? 'selected' : ''}>3 - M√©dia</option>
                            <option value="4" ${priority == 4 ? 'selected' : ''}>4 - Alta</option>
                            <option value="5" ${priority == 5 ? 'selected' : ''}>5 - Muito Alta</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Define o peso espec√≠fico deste assunto dentro da disciplina (1-5)</p>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="cancelEditTopic" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>
                        <button type="submit" class="btn-primary py-2 px-4 text-sm">Salvar</button>
                    </div>
                </form>
            `;
            openModal();

            // Conectar o formul√°rio com a fun√ß√£o submitEditTopic
            const form = modalBody.querySelector('#editTopicForm');
            form.addEventListener('submit', submitEditTopic);

            modalBody.querySelector('#cancelEditTopic').addEventListener('click', () => {
                originalTopicState = null;
                closeModal();
            });
        }

        function handleDeleteTopic(id, description) {
            document.getElementById('editModalTitle').textContent = 'Apagar T√≥pico';
            document.getElementById('editModalBody').innerHTML = `<p>Voc√™ tem certeza que deseja apagar o t√≥pico "<strong>${description}</strong>"?</p><div class="flex justify-end space-x-3 pt-4 mt-4"><button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 btn-cancel">Cancelar</button><button id="confirmDeleteTopic" data-id="${id}" class="btn-danger px-4 py-2 text-sm">Sim, Apagar</button></div>`;
            openModal();
            document.getElementById('confirmDeleteTopic').addEventListener('click', submitDeleteTopic);
        }
        
        function updatePendingChange(topicId, newDescription, newPriority) {
            pendingTopicChanges[topicId] = {
                id: topicId,
                description: newDescription,
                priority_weight: newPriority
            };

            const topicElement = document.querySelector(`.topic-item[data-topic-id="${topicId}"]`);
            if (topicElement) {
                topicElement.style.backgroundColor = '#fef9c3'; // yellow-100
                topicElement.querySelector('.topic-description').textContent = newDescription;
                const badge = topicElement.querySelector('.topic-priority-badge');
                badge.textContent = `P${newPriority}`;
                badge.className = `ml-2 text-xs px-2 py-1 rounded-full topic-priority-badge ${getTopicWeightColor(newPriority)}`;
            }

            document.getElementById('batch-save-container').classList.remove('hidden');
        }

        async function submitPendingTopicChanges() {
            const changes = Object.values(pendingTopicChanges);
            if (changes.length === 0) {
                app.showToast('Nenhuma altera√ß√£o para salvar.', 'info');
                return;
            }

            app.showSpinner();
            try {
                await app.apiFetch('/topics/batch_update_details', {
                    method: 'PATCH',
                    body: JSON.stringify({ topics: changes })
                });
                app.showToast('Todas as altera√ß√µes nos t√≥picos foram salvas!', 'success');
                
                Object.keys(pendingTopicChanges).forEach(topicId => {
                    const topicElement = document.querySelector(`.topic-item[data-topic-id="${topicId}"]`);
                    if (topicElement) {
                        topicElement.style.backgroundColor = '';
                    }
                });

                pendingTopicChanges = {};
                document.getElementById('batch-save-container').classList.add('hidden');

            } catch (error) {
                app.showToast(error.message, 'error');
            } finally {
                app.hideSpinner();
            }
        }

        async function submitApiRequestWrapper(url, method, body, successMessage, reloadSubjects = true) {
            app.showSpinner();
            try {
                const data = await app.apiFetch(url, { method, body: body ? JSON.stringify(body) : undefined });
                app.showToast(successMessage || data.message, 'success');
                closeModal();
                if (reloadSubjects) {
                    await loadSubjects();
                }
                const generateButton = document.getElementById('generateButton');
                if (generateButton) {
                    generateButton.disabled = false;
                }
            } catch (error) {
                app.showToast(error.message, 'error');
            } finally {
                app.hideSpinner();
            }
        }

        async function submitEditSubject(event) {
            event.preventDefault();
            const id = event.target.dataset.id;
            const body = { subject_name: document.getElementById('edit_subject_name').value, priority_weight: document.getElementById('edit_priority_weight').value };
            await submitApiRequestWrapper(`/subjects/${id}`, 'PATCH', body, 'Disciplina atualizada!');
        }

        async function submitDeleteSubject(event) {
            await submitApiRequestWrapper(`/subjects/${event.target.dataset.id}`, 'DELETE', null, 'Disciplina apagada!');
        }

        async function submitEditTopic(event) {
            event.preventDefault();
            const id = event.target.dataset.id;
            const body = {
                description: document.getElementById('edit_topic_description').value,
                priority_weight: parseInt(document.getElementById('edit_topic_priority').value)
            };
            await submitApiRequestWrapper(`/topics/${id}`, 'PATCH', body, 'T√≥pico atualizado!', false);

            // Atualizar o DOM diretamente para evitar recarregar toda a lista
            const topicItem = document.querySelector(`.topic-item[data-topic-id="${id}"]`);
            if (topicItem) {
                const descSpan = topicItem.querySelector('.topic-description');
                if (descSpan) descSpan.textContent = body.description;
                
                const weightSpan = topicItem.querySelector('.topic-priority-badge');
                if (weightSpan) {
                    weightSpan.textContent = `P${body.priority_weight}`;
                    weightSpan.className = `ml-2 text-xs px-2 py-1 rounded-full ${getTopicWeightColor(body.priority_weight)}`;
                }

                // Atualizar os dados do bot√£o de edi√ß√£o
                const editBtn = topicItem.querySelector('.edit-topic-btn');
                if (editBtn) {
                    editBtn.dataset.description = body.description;
                    editBtn.dataset.priority = body.priority_weight;
                }
            }
        }

        async function submitDeleteTopic(event) {
            await submitApiRequestWrapper(`/topics/${event.target.dataset.id}`, 'DELETE', null, 'T√≥pico apagado!');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initialize();
            
            const batchSaveBtn = document.getElementById('batch-save-topics-btn');
            if(batchSaveBtn) {
                batchSaveBtn.addEventListener('click', submitPendingTopicChanges);
            }

            const generateButton = document.getElementById('generateButton');
            const generalSettingsForm = document.getElementById('generalSettingsForm');
            const newContentForm = document.getElementById('newContentForm');
            
            generateButton.disabled = true;
            
            const enableGenerateButton = () => { generateButton.disabled = false; };
            
            generalSettingsForm.addEventListener('input', enableGenerateButton);
            newContentForm.addEventListener('submit', enableGenerateButton);

            document.getElementById('subjectsContainer').addEventListener('change', (event) => {
                if (event.target.classList.contains('topic-checkbox')) {
                    const topicItem = event.target.closest('.topic-item');
                    if (topicItem) {
                        topicItem.classList.toggle('show-date', event.target.checked);
                        const accordionContent = topicItem.closest('.accordion-content');
                        const accordionHeader = accordionContent.previousElementSibling;
                        if (accordionHeader.classList.contains('open')) {
                           accordionContent.style.maxHeight = accordionContent.scrollHeight + "px";
                        }
                    }
                }
            });

            newContentForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const form = event.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                
                if (submitBtn.disabled) return;
                submitBtn.disabled = true;
                const originalBtnText = submitBtn.textContent;
                submitBtn.textContent = 'Adicionando...';
                
                const body = { subject_name: document.getElementById('subject_name').value, priority_weight: document.getElementById('priority_weight').value, topics_list: document.getElementById('topics_list').value };
                app.showSpinner();
                try {
                    const data = await app.apiFetch(`/plans/${planId}/subjects_with_topics`, { method: 'POST', body: JSON.stringify(body) });
                    app.showToast(data.message, 'success');
                    form.reset();
                    await loadSubjects();
                } catch (error) {
                    app.showToast(error.message, 'error');
                } finally {
                    app.hideSpinner();
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            });

            document.getElementById('subjectsContainer').addEventListener('click', async (event) => {
                const button = event.target.closest('button');
                
                if (!button) {
                    const header = event.target.closest('.accordion-header');
                    if (header) {
                        const content = header.nextElementSibling;
                        header.classList.toggle('open');
                        content.style.maxHeight = header.classList.contains('open') ? content.scrollHeight + "px" : null;
                    }
                    return;
                }

                if (button.classList.contains('save-progress-btn')) {
                    event.preventDefault();
                    
                    if (button.disabled) return;
                    button.disabled = true;
                    const originalText = button.textContent;
                    button.textContent = 'Salvando...';
                    
                    const subjectId = button.dataset.subjectId;
                    const topicsList = document.getElementById(`topics-for-${subjectId}`);
                    const topicsToUpdate = Array.from(topicsList.querySelectorAll('.topic-item')).map(item => {
                        const checkbox = item.querySelector('.topic-checkbox');
                        const dateInput = item.querySelector('.historic-date-input input');
                        return {
                            id: checkbox.dataset.topicId,
                            status: checkbox.checked ? 'Conclu√≠do' : 'Pendente',
                            completion_date: checkbox.checked ? dateInput.value : null
                        };
                    });

                    app.showSpinner();
                    try {
                        await app.apiFetch('/topics/batch_update', {
                            method: 'PATCH',
                            body: JSON.stringify({ topics: topicsToUpdate })
                        });

                        app.showToast('Progresso salvo com sucesso!', 'success');
                        enableGenerateButton();
                    } catch (error) {
                        app.showToast(error.message, 'error');
                    } finally {
                        app.hideSpinner();
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                } else if (button.classList.contains('edit-subject-btn')) {
                    handleEditSubject(button.dataset.subjectId, button.dataset.subjectName, button.dataset.priority);
                } else if (button.classList.contains('delete-subject-btn')) {
                    handleDeleteSubject(button.dataset.subjectId, button.dataset.subjectName);
                } else if (button.classList.contains('edit-topic-btn')) {
                    handleEditTopic(button.dataset.topicId, button.dataset.description, button.dataset.priority);
                } else if (button.classList.contains('delete-topic-btn')) {
                    handleDeleteTopic(button.dataset.topicId, button.dataset.description);
                }
            });

            generalSettingsForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                app.showSpinner();
                try {
                    const settings = getSettingsFromForm();
                    await app.apiFetch(`/plans/${planId}/settings`, {
                        method: 'PATCH',
                        body: JSON.stringify(settings)
                    });
                    app.showToast("Configura√ß√µes salvas com sucesso!", 'success');
                } catch (error) {
                    app.showToast(error.message, 'error');
                } finally {
                    app.hideSpinner();
                }
            });

            generateButton.addEventListener('click', async (event) => {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = 'Gerando...';
                app.showSpinner();
                
                try {
                    const settings = getSettingsFromForm();
                    const result = await app.apiFetch(`/plans/${planId}/generate`, {
                        method: 'POST',
                        body: JSON.stringify(settings)
                    });

                    if (result.retaFinal && result.retaFinal.excludedTopics.length > 0) {
                        showRetaFinalReport(result.retaFinal.excludedTopics, result.retaFinal.prioritizedSubjects || []);
                    }
                    app.showToast(result.message, 'success');
                    app.invalidatePlanCache(planId);
                } catch (error) {
                    app.showToast(error.message, 'error');
                } finally {
                    app.hideSpinner();
                    btn.textContent = 'Gerar/Atualizar Cronograma';
                }
            });
            
            editModal.addEventListener('click', (event) => {
                if (event.target === editModal || event.target.closest('.btn-cancel')) {
                    closeModal();
                }
            });
            
            const startGuideBtn = document.getElementById('startGuideBtn');
            const skipGuideBtn = document.getElementById('skipGuideBtn');
            
            if (startGuideBtn) {
                startGuideBtn.addEventListener('click', () => {
                    document.getElementById('welcome-message').classList.add('hidden');
                    startGuide();
                });
            }
            
            if (skipGuideBtn) {
                skipGuideBtn.addEventListener('click', () => {
                    document.getElementById('welcome-message').classList.add('hidden');
                });
            }
            
            const loadTemplateBtn = document.getElementById('loadTemplateBtn');
            const disciplineTemplates = document.getElementById('disciplineTemplates');
            
            if (loadTemplateBtn) {
                loadTemplateBtn.addEventListener('click', () => {
                    disciplineTemplates.classList.toggle('hidden');
                });
            }
            
            document.querySelectorAll('.template-discipline-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const name = this.dataset.name;
                    const priority = this.dataset.priority;
                    const topics = this.dataset.topics;
                    
                    document.getElementById('subject_name').value = name;
                    document.getElementById('priority_weight').value = priority;
                    document.getElementById('topics_list').value = topics;
                    
                    this.classList.add('bg-blue-100', 'border-blue-300');
                    setTimeout(() => {
                        this.classList.remove('bg-blue-100', 'border-blue-300');
                    }, 1000);
                    
                    disciplineTemplates.classList.add('hidden');
                    updateTopicCounter();
                });
            });
            
            function updateTopicCounter() {
                const topicsTextarea = document.getElementById('topics_list');
                const topicCounter = document.getElementById('topicCount');
                
                if (topicsTextarea && topicCounter) {
                    const lines = topicsTextarea.value.split('\n').filter(line => line.trim().length > 0);
                    topicCounter.textContent = `${lines.length} t√≥picos`;
                }
            }
            
            const topicsTextarea = document.getElementById('topics_list');
            if (topicsTextarea) {
                topicsTextarea.addEventListener('input', updateTopicCounter);
            }
            
            const showExampleBtn = document.getElementById('showExampleBtn');
            const exampleModal = document.getElementById('exampleModal');
            const closeExampleBtn = document.getElementById('closeExampleBtn');
            
            if (showExampleBtn) {
                showExampleBtn.addEventListener('click', () => {
                    exampleModal.classList.remove('hidden');
                });
            }
            
            if (closeExampleBtn) {
                closeExampleBtn.addEventListener('click', () => {
                    exampleModal.classList.add('hidden');
                });
            }
            
            if (exampleModal) {
                exampleModal.addEventListener('click', (e) => {
                    if (e.target === exampleModal) {
                        exampleModal.classList.add('hidden');
                    }
                });
            }
            
            document.querySelectorAll('.goal-preset').forEach(btn => {
                btn.addEventListener('click', function() {
                    const daily = this.dataset.daily;
                    const weekly = this.dataset.weekly;
                    
                    document.getElementById('daily_goal').value = daily;
                    document.getElementById('weekly_goal').value = weekly;
                    
                    this.classList.add('bg-blue-200');
                    setTimeout(() => {
                        this.classList.remove('bg-blue-200');
                    }, 500);
                });
            });
            
            const dailyGoalInput = document.getElementById('daily_goal');
            const weeklyGoalInput = document.getElementById('weekly_goal');
            
            if (dailyGoalInput && weeklyGoalInput) {
                dailyGoalInput.addEventListener('input', function() {
                    const dailyValue = parseInt(this.value) || 0;
                    weeklyGoalInput.value = dailyValue * 7;
                    updateProgress();
                });
            }
            
            let updateProgressTimeout;
            const debouncedUpdateProgress = () => {
                clearTimeout(updateProgressTimeout);
                updateProgressTimeout = setTimeout(updateProgress, 300);
            };
            
            document.addEventListener('change', debouncedUpdateProgress);
            document.addEventListener('input', debouncedUpdateProgress);
            
            setTimeout(updateProgress, 1000);
        });
    </script>
    
    <!-- Script do rodap√© modular -->
    <script src="js/footer.js"></script>
    <!-- O rodap√© ser√° inserido automaticamente aqui pelo footer.js -->
</body>
</html>