<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes do Plano - Editaliza</title>
    <!-- Favicon and Web App Icons - Enhanced for better browser compatibility -->
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png?v=4">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png?v=4">
    <link rel="icon" type="image/png" sizes="48x48" href="favicon-48x48.png?v=4">
    <link rel="shortcut icon" href="favicon.ico?v=4">
    <link rel="icon" type="image/x-icon" href="favicon.ico?v=4">
    <link rel="icon" type="image/svg+xml" href="favicon.svg?v=4">
    <meta name="theme-color" content="#0528f2">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/design-tokens.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/footer.css" rel="stylesheet">
    <!-- Theme system removed - light mode only -->
    <!-- SCRIPTS CENTRALIZADOS -->
    <script src="js/app.js"></script>
    <script src="js/components.js"></script>
    <!-- Config do Tailwind para reconhecer as cores customizadas -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'editaliza-blue': '#0528f2',
                        'editaliza-green': '#1ad937',
                        'editaliza-black': '#0d0d0d',
                        'editaliza-gray': '#969696',
                    }
                }
            }
        }
    </script>
    <style>
        .tooltip { 
            position: relative; 
            display: inline-flex; 
            align-items: center;
            margin-left: 8px;
        }
        .tooltip .tooltiptext {
            visibility: hidden; 
            width: 250px; 
            background-color: #1e293b; /* slate-800 */
            color: #fff; 
            text-align: center;
            border-radius: 6px; 
            padding: 8px; 
            position: absolute; 
            z-index: 10;
            bottom: 140%; 
            left: 50%; 
            margin-left: -125px; /* Metade da largura */
            opacity: 0; 
            transition: opacity 0.3s;
            font-size: 0.75rem; 
            line-height: 1.25;
            font-weight: 400;
        }
        .tooltip:hover .tooltiptext { 
            visibility: visible; 
            opacity: 1; 
        }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-header.open + .accordion-content {
             /* A altura ser√° definida via JS para garantir a anima√ß√£o correta */
        }
        .accordion-header.open svg { transform: rotate(180deg); }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: all 0.3s ease; }
        .historic-date-input { display: none; }
        .topic-item.show-date .historic-date-input { display: block; }
        
        /* Estilos para edi√ß√£o inline */
        .topic-row {
            display: grid;
            grid-template-columns: 40px 1fr 120px 80px;
            gap: 12px;
            align-items: start;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .topic-row:hover {
            background-color: #f8fafc;
        }
        
        .topic-row.modified {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        
        .topic-name-input {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s ease;
        }
        
        .topic-name-input:focus {
            outline: none;
            border-color: #0528f2;
            box-shadow: 0 0 0 3px rgba(5, 40, 242, 0.1);
        }
        
        .topic-name-input.modified {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
        
        .priority-select {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            font-size: 12px;
            background: white;
        }
        
        .priority-select:focus {
            outline: none;
            border-color: #0528f2;
        }
        
        .priority-select.modified {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
        
        .topic-actions {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .delete-topic-btn {
            padding: 6px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: #ef4444;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .delete-topic-btn:hover {
            background-color: #fef2f2;
        }
        
        .changes-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #f59e0b;
        }
        
        @media (max-width: 768px) {
            .topic-row {
                grid-template-columns: 30px 1fr;
                gap: 8px;
                padding: 16px 12px;
            }
            
            .topic-weight-mobile,
            .topic-actions-mobile {
                grid-column: 1 / -1;
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 8px;
                padding-top: 8px;
                border-top: 1px solid #e5e7eb;
            }
            
            .topic-name-input {
                font-size: 16px; /* Evita zoom em iOS */
            }
            
            .priority-select {
                font-size: 16px; /* Evita zoom em iOS */
            }
        }
        
        /* Estilos para o guia e progress indicators */
        .step-highlight {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }
        
        .template-discipline-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .goal-preset {
            transition: all 0.2s ease;
        }
        
        .goal-preset:hover {
            transform: translateY(-1px);
        }
        
        @keyframes pulse-blue {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        }
        
        .pulse-blue {
            animation: pulse-blue 2s infinite;
        }
        
        /* Melhorias visuais para os indicadores de progresso */
        #progress-indicator {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* Anima√ß√µes suaves para elementos do guia */
        .guide-element {
            transition: all 0.3s ease;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">
    <!-- Container de Toast para Notifica√ß√µes -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3"></div>

    <!-- NAVEGA√á√ÉO PRINCIPAL (GERADA PELO JS) -->
    <div id="main-nav-container"></div>

    <!-- Modal para Edi√ß√£o/Exclus√£o -->
    <div id="editModal" class="modal-overlay hidden fixed inset-0 bg-editaliza-black bg-opacity-70 z-30 flex items-center justify-center p-4 opacity-0">
        <div class="modal-container bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg transform scale-95">
            <h2 id="editModalTitle" class="text-2xl font-bold text-editaliza-black"></h2>
            <div id="editModalBody" class="mt-4"></div>
        </div>
    </div>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl">
        <!-- CABE√áALHO DO PLANO (GERADO PELO JS) -->
        <div id="plan-header-container"></div>
        
        <!-- Welcome Message Aprimorado -->
        <div id="welcome-message" class="hidden bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 text-gray-800 p-6 rounded-xl mb-8 shadow-lg">
            <div class="flex items-start space-x-4">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <span class="text-2xl">üéâ</span>
                    </div>
                </div>
                <div class="flex-grow">
                    <h3 class="text-xl font-bold text-green-800 mb-2">Parab√©ns! Seu plano foi criado com sucesso!</h3>
                    <p class="text-gray-700 mb-4">Agora vamos configurar seu plano passo a passo. N√£o se preocupe, vou te guiar em cada etapa.</p>
                    
                    <!-- Progress Steps -->
                    <div class="bg-white rounded-lg p-4 border border-green-200">
                        <h4 class="font-semibold text-gray-700 mb-3">Pr√≥ximos passos:</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center text-gray-600">
                                <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold mr-3">1</span>
                                Adicione suas disciplinas e t√≥picos
                            </div>
                            <div class="flex items-center text-gray-500">
                                <span class="w-6 h-6 bg-gray-100 text-gray-400 rounded-full flex items-center justify-center text-xs font-bold mr-3">2</span>
                                Configure seus hor√°rios de estudo
                            </div>
                            <div class="flex items-center text-gray-500">
                                <span class="w-6 h-6 bg-gray-100 text-gray-400 rounded-full flex items-center justify-center text-xs font-bold mr-3">3</span>
                                Defina suas metas de quest√µes
                            </div>
                            <div class="flex items-center text-gray-500">
                                <span class="w-6 h-6 bg-gray-100 text-gray-400 rounded-full flex items-center justify-center text-xs font-bold mr-3">4</span>
                                Gerar seu cronograma personalizado
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex items-center justify-between">
                        <button id="startGuideBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            üöÄ Iniciar Tour Guiado
                        </button>
                        <button id="skipGuideBtn" class="text-gray-500 hover:text-gray-700 text-sm underline">
                            Pular e configurar sozinho
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Guia de Progresso Fixo -->
        <div id="progress-indicator" class="hidden sticky top-4 z-20 bg-white border border-gray-200 rounded-lg shadow-lg p-4 mb-6">
            <div class="flex items-center justify-between text-sm">
                <span class="font-medium text-gray-700">Progresso da Configura√ß√£o:</span>
                <span id="progress-text" class="text-blue-600 font-bold">0/4 completo</span>
            </div>
            <div class="mt-2 bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                 <div class="content-card" id="step-1-content">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                            <span class="text-2xl mr-3">üìö</span>Conte√∫do Program√°tico
                        </h2>
                        <div class="hidden" id="step-1-indicator">
                            <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Passo 1/4</span>
                        </div>
                    </div>
                    
                    <!-- Dicas para Primeira Vez -->
                    <div id="first-time-tips" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start space-x-3">
                            <span class="text-2xl">üí°</span>
                            <div>
                                <h3 class="font-semibold text-yellow-800 mb-2">Primeira vez configurando? Aqui est√£o algumas dicas!</h3>
                                <ul class="text-sm text-yellow-700 space-y-1">
                                    <li>‚Ä¢ <strong>Disciplinas:</strong> Adicione as mat√©rias do seu edital (ex: Direito Constitucional, Matem√°tica)</li>
                                    <li>‚Ä¢ <strong>Prioridade:</strong> 5 = muito importante, 1 = menos importante</li>
                                    <li>‚Ä¢ <strong>T√≥picos:</strong> Divida cada disciplina em assuntos menores para melhor controle</li>
                                    <li>‚Ä¢ <strong>J√° estudou?</strong> Marque os t√≥picos j√° vistos para ajustar o cronograma</li>
                                </ul>
                                <div class="mt-3">
                                    <button id="showExampleBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium underline">
                                        üëÅÔ∏è Ver exemplo pr√°tico
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Exemplo Pr√°tico Modal -->
                    <div id="exampleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-96 overflow-y-auto">
                            <div class="p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-gray-800">Exemplo: Direito Constitucional</h3>
                                    <button id="closeExampleBtn" class="text-gray-400 hover:text-gray-600">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="text-sm text-gray-700">
                                    <p class="mb-3"><strong>Disciplina:</strong> Direito Constitucional | <strong>Prioridade:</strong> 5 (muito importante)</p>
                                    <p class="mb-2"><strong>T√≥picos sugeridos:</strong></p>
                                    <div class="bg-gray-50 p-3 rounded-lg text-xs">
                                        1. Princ√≠pios Fundamentais (Art. 1¬∫ ao 4¬∫)<br>
                                        2. Direitos e Garantias Fundamentais<br>
                                        3. Organiza√ß√£o do Estado<br>
                                        4. Poder Legislativo<br>
                                        5. Poder Executivo<br>
                                        6. Poder Judici√°rio<br>
                                        7. Controle de Constitucionalidade
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-slate-50 to-blue-50 p-6 rounded-xl border border-blue-200 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">üéØ Adicionar Disciplina e T√≥picos</h3>
                            <button id="loadTemplateBtn" class="text-blue-600 hover:bg-blue-100 px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                                üóÇÔ∏è Usar Template
                            </button>
                        </div>
                        
                        <!-- Templates de Disciplinas -->
                        <div id="disciplineTemplates" class="hidden mb-4 p-4 bg-white rounded-lg border">
                            <h4 class="font-medium text-gray-700 mb-3">Templates Populares:</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <button class="template-discipline-btn text-left p-2 hover:bg-gray-50 rounded border" data-name="Direito Constitucional" data-priority="5" data-topics="1. Princ√≠pios Fundamentais (Art. 1¬∫ ao 4¬∫)
2. Direitos e Garantias Fundamentais
3. Organiza√ß√£o do Estado
4. Poder Legislativo
5. Poder Executivo
6. Poder Judici√°rio
7. Controle de Constitucionalidade">
                                    <div class="font-medium text-gray-700">Direito Constitucional</div>
                                    <div class="text-xs text-gray-500">7 t√≥picos principais</div>
                                </button>
                                <button class="template-discipline-btn text-left p-2 hover:bg-gray-50 rounded border" data-name="Matem√°tica" data-priority="4" data-topics="1. Aritm√©tica e Conjuntos
2. √Ålgebra e Fun√ß√µes
3. Geometria Plana
4. Geometria Espacial
5. Trigonometria
6. An√°lise Combinat√≥ria
7. Probabilidade e Estat√≠stica">
                                    <div class="font-medium text-gray-700">Matem√°tica</div>
                                    <div class="text-xs text-gray-500">7 t√≥picos essenciais</div>
                                </button>
                                <button class="template-discipline-btn text-left p-2 hover:bg-gray-50 rounded border" data-name="Portugu√™s" data-priority="5" data-topics="1. Ortografia e Acentua√ß√£o
2. Morfologia e Classes de Palavras
3. Sintaxe do Per√≠odo Simples
4. Sintaxe do Per√≠odo Composto
5. Concordancia Nominal e Verbal
6. Reg√™ncia e Crase
7. Interpreta√ß√£o de Textos">
                                    <div class="font-medium text-gray-700">L√≠ngua Portuguesa</div>
                                    <div class="text-xs text-gray-500">7 t√≥picos fundamentais</div>
                                </button>
                                <button class="template-discipline-btn text-left p-2 hover:bg-gray-50 rounded border" data-name="Inform√°tica" data-priority="3" data-topics="1. Conceitos de Hardware e Software
2. Sistemas Operacionais
3. Microsoft Office (Word, Excel, PowerPoint)
4. Internet e Seguran√ßa
5. Banco de Dados B√°sicos">
                                    <div class="font-medium text-gray-700">Inform√°tica</div>
                                    <div class="text-xs text-gray-500">5 t√≥picos essenciais</div>
                                </button>
                            </div>
                        </div>
                        
                        <form id="newContentForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="md:col-span-2">
                                    <label for="subject_name" class="block text-sm font-medium text-gray-700 mb-1">
                                        Nome da Disciplina <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="subject_name" class="form-input" placeholder="Ex: Direito Constitucional" required>
                                    <p class="text-xs text-gray-500 mt-1">üìù Use o nome exato do edital</p>
                                </div>
                                <div>
                                    <label for="priority_weight" class="block text-sm font-medium text-gray-700 mb-1">
                                        Prioridade
                                        <span class="tooltip">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <span class="tooltiptext">5 = Prioridade m√°xima (maior peso no cronograma)<br>1 = Prioridade m√≠nima</span>
                                        </span>
                                    </label>
                                    <select id="priority_weight" class="form-input" required>
                                        <option value="5">üî¥ 5 - Muito Importante</option>
                                        <option value="4">üü† 4 - Importante</option>
                                        <option value="3" selected>üü° 3 - M√©dio</option>
                                        <option value="2">üü¢ 2 - Baixo</option>
                                        <option value="1">‚ö™ 1 - Muito Baixo</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label for="topics_list" class="block text-sm font-medium text-gray-700 mb-1">
                                    T√≥picos da Disciplina
                                    <span class="tooltip">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        <span class="tooltiptext">Divida a disciplina em t√≥picos menores.<br>Um t√≥pico por linha.<br>Exemplo: "1. Princ√≠pios Fundamentais"</span>
                                    </span>
                                </label>
                                <textarea id="topics_list" class="form-input" rows="6" placeholder="1. Princ√≠pios Fundamentais
2. Direitos e Garantias Fundamentais
3. Organiza√ß√£o do Estado
4. Poder Legislativo
..."></textarea>
                                <div class="flex items-center justify-between mt-2">
                                    <p class="text-xs text-gray-500">üìù Um t√≥pico por linha | Deixe em branco para adicionar depois</p>
                                    <span id="topicCount" class="text-xs text-blue-600 font-medium">0 t√≥picos</span>
                                </div>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button type="submit" class="btn-primary py-3 flex-grow">
                                    <span class="flex items-center justify-center">
                                        <span class="mr-2">‚ûï</span>
                                        Adicionar Disciplina
                                    </span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-700 mt-8 mb-2">Disciplinas Cadastradas</h3>
                    <p class="text-sm text-gray-500 mb-4">
                        Configure seus t√≥picos: marque os j√° estudados, ajuste os <strong>pesos</strong> (1=baixa prioridade, 5=alta prioridade), 
                        edite os nomes e informe datas de conclus√£o. O sistema usa essas informa√ß√µes para gerar seu cronograma personalizado.
                        <span class="inline-block mt-1 text-xs">
                            <span class="bg-red-100 text-red-700 px-2 py-1 rounded mr-1">5-Alta</span>
                            <span class="bg-orange-100 text-orange-700 px-2 py-1 rounded mr-1">4-M√©dia+</span>
                            <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded mr-1">3-M√©dia</span>
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded mr-1">2-M√©dia-</span>
                            <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded">1-Baixa</span>
                        </span>
                    </p>
                    <div id="subjectsContainer" class="space-y-4"></div>
                 </div>
            </div>

            <div class="lg:col-span-1 space-y-8">
                <div class="content-card" id="step-2-content">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">Configura√ß√µes Gerais</h2>
                        <div class="hidden" id="step-2-indicator">
                            <span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Passo 2/4</span>
                        </div>
                    </div>
                    <form id="generalSettingsForm" class="space-y-6">
                        <div>
                            <h3 class="font-semibold text-gray-600 border-b pb-2 mb-3">Estrutura de Estudo</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-700 flex items-center">
                                        Horas de estudo por dia
                                        <span class="tooltip">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-editaliza-blue cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                            <span class="tooltiptext">Defina suas horas dispon√≠veis. S√°bados s√£o priorizados para revis√µes e domingos para reda√ß√£o/descanso.</span>
                                        </span>
                                    </label>
                                    <div id="hours-grid" class="grid grid-cols-4 gap-2 text-center mt-2"></div>
                                </div>
                                <div>
                                    <label for="session_duration" class="text-sm font-medium text-gray-700 flex items-center">
                                        Dura√ß√£o da Sess√£o (minutos)
                                        <span class="tooltip">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-editaliza-blue cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                            <span class="tooltiptext">Recomendamos 50 min para foco total (T√©cnica Pomodoro), seguido por um descanso de 10 min.</span>
                                        </span>
                                    </label>
                                    <input type="number" id="session_duration" class="form-input" value="50" min="10">
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-600 border-b pb-2 mb-3">Estrutura de Fim de Semana</h3>
                            <div class="flex items-center p-3 bg-slate-50 rounded-lg border">
                                <input id="has_essay" name="has_essay" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-editaliza-blue focus:ring-editaliza-blue">
                                <label for="has_essay" class="ml-3 block text-sm font-medium text-gray-700">
                                    Incluir Reda√ß√£o aos Domingos
                                    <span class="tooltip">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-editaliza-blue cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        <span class="tooltiptext">Ao marcar, o sistema reservar√° os domingos para sess√µes de reda√ß√£o. Se desmarcado, os domingos ser√£o dias de descanso.</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div id="step-3-content">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold text-gray-600">Metas de Quest√µes</h3>
                                <div class="hidden" id="step-3-indicator">
                                    <span class="bg-orange-100 text-orange-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Passo 3/4</span>
                                </div>
                            </div>
                            <div class="border-b pb-3 mb-3"></div>
                            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                                <div class="flex items-start space-x-2">
                                    <span class="text-blue-600">üéØ</span>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-medium mb-1">Dica de Ouro:</p>
                                        <p>Para concursos: 30-50 quest√µes/dia. Para ENEM: 20-30 quest√µes/dia. Ajuste conforme seu ritmo!</p>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="daily_goal" class="text-sm font-medium text-gray-700 flex items-center">
                                        Meta Di√°ria
                                        <span class="tooltip">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <span class="tooltiptext">N√∫mero de quest√µes que voc√™ pretende resolver por dia. Seja realista!</span>
                                        </span>
                                    </label>
                                    <input type="number" id="daily_goal" class="form-input" value="50" min="0">
                                    <div class="mt-1 flex space-x-2">
                                        <button type="button" class="goal-preset text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded" data-daily="20" data-weekly="140">Iniciante (20/dia)</button>
                                        <button type="button" class="goal-preset text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded" data-daily="40" data-weekly="280">Intermedi√°rio (40/dia)</button>
                                        <button type="button" class="goal-preset text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded" data-daily="60" data-weekly="420">Avan√ßado (60/dia)</button>
                                    </div>
                                </div>
                                <div>
                                    <label for="weekly_goal" class="text-sm font-medium text-gray-700">Meta Semanal</label>
                                    <input type="number" id="weekly_goal" class="form-input" value="300" min="0" readonly>
                                    <p class="text-xs text-gray-500 mt-1">Calculado automaticamente: meta di√°ria √ó 7</p>
                                </div>
                            </div>
                        </div>
                        <div class="pt-4 space-y-3" id="step-4-content">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold text-gray-600">Finalizar Configura√ß√£o</h3>
                                <div class="hidden" id="step-4-indicator">
                                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Passo 4/4</span>
                                </div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg mb-4">
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-600">‚úÖ</span>
                                    <p class="text-sm font-medium text-green-800">Tudo pronto! Agora √© s√≥ gerar seu cronograma personalizado.</p>
                                </div>
                            </div>
                            <div class="bg-red-50 border-2 border-red-200 rounded-xl p-4 mb-4">
                                <div class="flex items-start space-x-3">
                                    <input type="checkbox" id="retaFinalMode" class="w-5 h-5 text-red-600 bg-white border-red-300 rounded focus:ring-red-500 focus:ring-2">
                                    <div>
                                        <label for="retaFinalMode" class="text-lg font-bold text-red-700">üö® Modo Reta Final</label>
                                        <p class="text-sm text-red-600 mt-2">Prioriza mat√©rias mais importantes quando o tempo √© curto. T√≥picos menos relevantes podem ficar de fora.</p>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn-secondary mb-2">Salvar Configura√ß√µes</button>
                            <button id="generateButton" type="button" class="btn-primary group">
                                <span class="flex items-center justify-center">
                                    <span class="mr-2">üöÄ</span>
                                    Gerar Meu Cronograma!
                                    <span class="ml-2 transform group-hover:translate-x-1 transition-transform">‚ú®</span>
                                </span>
                            </button>
                            <p class="text-xs text-center text-gray-500 mt-2">
                                üìä Vou criar um cronograma otimizado baseado em suas configura√ß√µes
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const planId = urlParams.get('id');
        const isNewPlan = urlParams.get('new') === 'true';
        const hasGuide = urlParams.get('guide') === 'true';
        const editModal = document.getElementById('editModal');
        
        // Estado do guia e progresso
        let guideState = {
            isActive: false,
            currentStep: 1,
            completedSteps: [],
            totalSteps: 4
        };
        
        // Atualizar progresso
        function updateProgress() {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressIndicator = document.getElementById('progress-indicator');
            
            if (!progressBar) return;
            
            let completedCount = 0;
            
            // Verificar disciplinas adicionadas
            if (document.querySelectorAll('#subjectsContainer .accordion-header').length > 0) {
                completedCount++;
                guideState.completedSteps.push(1);
            }
            
            // Verificar configura√ß√µes de hor√°rio
            const hoursInputs = document.querySelectorAll('.hours-input');
            let hasHoursSet = false;
            hoursInputs.forEach(input => {
                if (parseInt(input.value) > 0) hasHoursSet = true;
            });
            if (hasHoursSet) {
                completedCount++;
                guideState.completedSteps.push(2);
            }
            
            // Verificar metas
            const dailyGoal = document.getElementById('daily_goal');
            if (dailyGoal && parseInt(dailyGoal.value) > 0) {
                completedCount++;
                guideState.completedSteps.push(3);
            }
            
            // Se tudo estiver pronto
            if (completedCount >= 3) {
                completedCount = 4;
                guideState.completedSteps.push(4);
            }
            
            const progressPercent = (completedCount / 4) * 100;
            progressBar.style.width = progressPercent + '%';
            progressText.textContent = `${completedCount}/4 completo`;
            
            if (guideState.isActive) {
                progressIndicator.classList.remove('hidden');
            }
        }
        
        // Mostrar indicadores de passo
        function showStepIndicators() {
            const indicators = ['step-1-indicator', 'step-2-indicator', 'step-3-indicator', 'step-4-indicator'];
            indicators.forEach((id, index) => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.remove('hidden');
                }
            });
        }
        
        // Fun√ß√£o para determinar cores dos badges de peso dos t√≥picos
        function getTopicWeightColor(weight) {
            switch (weight) {
                case 5: return 'bg-red-100 text-red-700'; // Muito Alto - Vermelho
                case 4: return 'bg-orange-100 text-orange-700'; // Alto - Laranja  
                case 3: return 'bg-yellow-100 text-yellow-700'; // M√©dio - Amarelo
                case 2: return 'bg-green-100 text-green-700'; // Baixo - Verde
                case 1: return 'bg-gray-100 text-gray-600'; // Muito Baixo - Cinza
                default: return 'bg-yellow-100 text-yellow-700'; // Padr√£o m√©dio
            }
        }

        // Fun√ß√£o para determinar cores dos badges de peso das disciplinas
        function getSubjectWeightColor(weight) {
            switch (weight) {
                case 5: return 'bg-red-100 text-red-800 font-semibold'; // Muito Alto - Vermelho
                case 4: return 'bg-orange-100 text-orange-800 font-semibold'; // Alto - Laranja  
                case 3: return 'bg-yellow-100 text-yellow-800 font-medium'; // M√©dio - Amarelo
                case 2: return 'bg-green-100 text-green-800'; // Baixo - Verde
                case 1: return 'bg-gray-100 text-gray-700'; // Muito Baixo - Cinza
                default: return 'bg-yellow-100 text-yellow-800 font-medium'; // Padr√£o m√©dio
            }
        }

        // Iniciar tour guiado
        function startGuide() {
            guideState.isActive = true;
            showStepIndicators();
            updateProgress();
            
            // Mostrar dicas para primeira vez
            const firstTimeTips = document.getElementById('first-time-tips');
            if (firstTimeTips) {
                firstTimeTips.classList.remove('hidden');
            }
            
            // Scroll suave para o conte√∫do
            document.getElementById('step-1-content').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        function openModal() {
            editModal.classList.remove('hidden');
            setTimeout(() => {
                editModal.classList.remove('opacity-0');
                editModal.querySelector('.modal-container').classList.remove('scale-95');
            }, 10);
        }

        function closeModal() {
            editModal.classList.add('opacity-0');
            editModal.querySelector('.modal-container').classList.add('scale-95');
            setTimeout(() => {
                editModal.classList.add('hidden');
                document.getElementById('editModalBody').innerHTML = '';
            }, 300);
        }
        
        async function initialize() {
            components.renderMainNavigation('dashboard.html');
            if (!planId) { window.location.href = 'dashboard.html'; return; }
            
            if (isNewPlan) { 
                document.getElementById('welcome-message').classList.remove('hidden'); 
                
                // Se veio com guia ativado
                if (hasGuide) {
                    setTimeout(() => {
                        startGuide();
                    }, 1000);
                }
            }
            
            renderHoursInputs();
            app.showSpinner();
            try {
                const plan = await app.apiFetch(`/plans/${planId}`);
                components.renderPlanHeader(planId, plan.plan_name, 'plan_settings.html');
                
                document.getElementById('daily_goal').value = plan.daily_question_goal;
                document.getElementById('weekly_goal').value = plan.weekly_question_goal;
                document.getElementById('session_duration').value = plan.session_duration_minutes;
                document.getElementById('has_essay').checked = !!plan.has_essay;
                
                // Carregar o valor do Modo Reta Final
                const retaFinalCheckbox = document.getElementById('retaFinalMode');
                if (retaFinalCheckbox) {
                    const isRetaFinal = plan.reta_final_mode === 1 || plan.reta_final_mode === true || plan.reta_final_mode === '1';
                    retaFinalCheckbox.checked = isRetaFinal;
                    console.log('üîç Plan_settings - Carregando modo Reta Final:', plan.reta_final_mode, '-> checkbox:', isRetaFinal);
                }

                if (plan.study_hours_per_day) {
                    const hoursInputs = document.querySelectorAll('.hours-input');
                    hoursInputs.forEach(input => {
                        const day = input.dataset.day;
                        if (plan.study_hours_per_day[day] !== undefined) {
                            input.value = plan.study_hours_per_day[day];
                        }
                    });
                }
                await loadSubjects();
            } catch (error) {
                app.showToast('Erro ao carregar dados do plano: ' + error.message, 'error');
            } finally {
                app.hideSpinner();
            }
        }

        function renderHoursInputs() {
            const grid = document.getElementById('hours-grid');
            const days = [{d:1,l:'Seg'}, {d:2,l:'Ter'}, {d:3,l:'Qua'}, {d:4,l:'Qui'}, {d:5,l:'Sex'}, {d:6,l:'S√°b'}, {d:0,l:'Dom'}];
            grid.innerHTML = days.map(day => `
                <div>
                    <label class="text-xs font-medium text-gray-500">${day.l}</label>
                    <input type="number" class="form-input py-2 text-center hours-input" data-day="${day.d}" value="${(day.d >= 1 && day.d <= 5) ? 4 : (day.d === 6 ? 2 : 0)}" min="0" max="24">
                </div>
            `).join('');
        }

        let loadingSubjects = false;
        async function loadSubjects() {
            // Evitar m√∫ltiplas chamadas simult√¢neas
            if (loadingSubjects) {
                console.log('üîÑ LoadSubjects j√° em execu√ß√£o, ignorando...');
                return;
            }
            
            loadingSubjects = true;
            try {
                const subjects = await app.apiFetch(`/plans/${planId}/subjects`);
                const container = document.getElementById('subjectsContainer');
                container.innerHTML = '';

                if (subjects.length === 0) {
                    container.innerHTML = `<div class="text-center p-6 bg-yellow-50 border border-yellow-200 rounded-lg"><p class="text-yellow-800">Nenhuma disciplina cadastrada.</p></div>`;
                    return;
                }

                subjects.forEach(subject => {
                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = 'bg-white rounded-xl border border-gray-200 shadow-sm';
                    subjectDiv.innerHTML = `
                        <div class="accordion-header flex justify-between items-center p-4 cursor-pointer hover:bg-slate-50 rounded-t-xl">
                            <div class="flex-grow">
                                <h3 class="text-lg font-semibold text-gray-800">${subject.subject_name}</h3>
                                <div class="flex items-center mt-1">
                                    <span class="text-sm text-editaliza-gray mr-2">Prioridade:</span>
                                    <span class="text-xs px-2 py-1 rounded-full ${getSubjectWeightColor(subject.priority_weight)}">${subject.priority_weight}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 flex-shrink-0">
                                <button class="edit-subject-btn p-2 rounded-md hover:bg-gray-200" data-subject-id="${subject.id}" data-subject-name="${subject.subject_name}" data-priority="${subject.priority_weight}" title="Editar Disciplina">‚úèÔ∏è</button>
                                <button class="delete-subject-btn p-2 rounded-md hover:bg-gray-200" data-subject-id="${subject.id}" data-subject-name="${subject.subject_name}" title="Apagar Disciplina">üóëÔ∏è</button>
                                <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="p-4">
                                <div class="hidden" id="topics-header-${subject.id}" role="table">
                                    <div class="hidden md:grid grid-cols-4 gap-3 text-xs font-medium text-gray-500 mb-3 pb-2 border-b" role="row">
                                        <div role="columnheader">Conclu√≠do</div>
                                        <div role="columnheader">Nome do T√≥pico</div>
                                        <div class="text-center" role="columnheader">Peso</div>
                                        <div class="text-center" role="columnheader">A√ß√µes</div>
                                    </div>
                                    <div class="md:hidden text-xs text-gray-500 mb-3 pb-2 border-b">
                                        <div class="font-medium" role="heading" aria-level="4">T√≥picos da Disciplina</div>
                                        <div class="text-xs text-gray-400 mt-1">Toque nos campos para editar. Use os bot√µes no final para salvar ou cancelar.</div>
                                    </div>
                                </div>
                                <div id="topics-for-${subject.id}" class="space-y-1 text-gray-700"><div class="text-center py-4 text-gray-500">Carregando...</div></div>
                            </div>
                             <div class="p-4 mt-4 border-t bg-slate-50 rounded-b-xl relative">
                                <div id="changes-indicator-${subject.id}" class="changes-indicator hidden"></div>
                                
                                <!-- Bot√µes de a√ß√£o -->
                                <div class="flex flex-col space-y-2">
                                    <button class="save-changes-btn w-full bg-editaliza-green hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow disabled:opacity-50 disabled:cursor-not-allowed" data-subject-id="${subject.id}" disabled>
                                        <span class="flex items-center justify-center">
                                            <span class="mr-2">üíæ</span>
                                            <span class="save-btn-text">Salvar Altera√ß√µes</span>
                                            <span class="changes-count ml-2 hidden bg-white bg-opacity-20 px-2 py-1 rounded-full text-xs"></span>
                                        </span>
                                    </button>
                                    
                                    <button class="cancel-changes-btn hidden w-full bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-colors text-sm" data-subject-id="${subject.id}">
                                        <span class="flex items-center justify-center">
                                            <span class="mr-2">‚Ü∂</span>
                                            Cancelar Altera√ß√µes
                                        </span>
                                    </button>
                                </div>
                                
                                <div class="mt-2 text-xs text-center text-gray-500">
                                    <span class="changes-summary">Nenhuma altera√ß√£o pendente</span>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(subjectDiv);
                });

                // Carregar t√≥picos com delay para evitar muitas requisi√ß√µes simult√¢neas
                for (let i = 0; i < subjects.length; i++) {
                    const subject = subjects[i];
                    // Adicionar delay de 200ms entre cada requisi√ß√£o
                    setTimeout(() => {
                        loadTopicsForSubject(subject.id);
                    }, i * 200);
                }
            } catch (error) {
                app.showToast('Erro ao carregar disciplinas.', 'error');
            } finally {
                loadingSubjects = false;
            }
        }

        // Estado para tracking de mudan√ßas por disciplina
        let subjectChanges = {};
        let originalTopicsData = {};

        async function loadTopicsForSubject(subjectId) {
            const container = document.getElementById(`topics-for-${subjectId}`);
            const header = document.getElementById(`topics-header-${subjectId}`);
            
            try {
                const topics = await app.apiFetch(`/subjects/${subjectId}/topics`);
                const todayStr = new Date().toISOString().split('T')[0];

                // Salvar dados originais para compara√ß√£o
                originalTopicsData[subjectId] = topics.map(topic => ({
                    id: topic.id,
                    description: topic.description,
                    priority_weight: topic.priority_weight || 3,
                    status: topic.status,
                    completion_date: topic.completion_date
                }));

                // Inicializar tracking de mudan√ßas
                subjectChanges[subjectId] = {};

                if (topics.length > 0) {
                    // Mostrar header apenas se houver t√≥picos
                    header.classList.remove('hidden');
                    
                    container.innerHTML = topics.map(topic => {
                        const isCompleted = topic.status === 'Conclu√≠do';
                        const completionDate = topic.completion_date || todayStr;
                        const showDateClass = isCompleted ? 'show-date' : '';
                        
                        return `
                        <div class="topic-item topic-row ${showDateClass}" data-topic-id="${topic.id}">
                            <div class="flex items-center">
                                <input type="checkbox" 
                                       class="h-4 w-4 rounded border-gray-300 text-editaliza-blue focus:ring-editaliza-blue topic-checkbox" 
                                       data-topic-id="${topic.id}" 
                                       data-original-status="${topic.status}"
                                       ${isCompleted ? 'checked' : ''}>
                            </div>
                            
                            <div class="flex flex-col">
                                <input type="text" 
                                       class="topic-name-input" 
                                       data-topic-id="${topic.id}"
                                       data-original-value="${topic.description}"
                                       value="${topic.description}"
                                       placeholder="Nome do t√≥pico"
                                       aria-label="Nome do t√≥pico">
                                <div class="historic-date-input mt-2">
                                    <label class="text-xs text-gray-500 mb-1 block">Data de conclus√£o:</label>
                                    <input type="date" 
                                           value="${completionDate}" 
                                           class="form-input p-2 text-sm completion-date-input" 
                                           data-topic-id="${topic.id}">
                                </div>
                            </div>
                            
                            <div class="hidden md:block">
                                <select class="priority-select" 
                                        data-topic-id="${topic.id}"
                                        data-original-value="${topic.priority_weight || 3}"
                                        aria-label="Peso do t√≥pico">
                                    <option value="1" ${(topic.priority_weight || 3) == 1 ? 'selected' : ''}>1 - Baixa</option>
                                    <option value="2" ${(topic.priority_weight || 3) == 2 ? 'selected' : ''}>2 - M√©dia-</option>
                                    <option value="3" ${(topic.priority_weight || 3) == 3 ? 'selected' : ''}>3 - M√©dia</option>
                                    <option value="4" ${(topic.priority_weight || 3) == 4 ? 'selected' : ''}>4 - M√©dia+</option>
                                    <option value="5" ${(topic.priority_weight || 3) == 5 ? 'selected' : ''}>5 - Alta</option>
                                </select>
                            </div>
                            
                            <div class="topic-actions hidden md:flex">
                                <button class="delete-topic-btn" 
                                        data-topic-id="${topic.id}" 
                                        data-description="${topic.description}"
                                        title="Excluir t√≥pico"
                                        aria-label="Excluir t√≥pico">
                                    üóëÔ∏è
                                </button>
                            </div>
                            
                            <!-- Mobile controls -->
                            <div class="topic-weight-mobile md:hidden">
                                <div class="flex items-center space-x-2">
                                    <label class="text-xs text-gray-500">Peso:</label>
                                    <select class="priority-select flex-1" 
                                            data-topic-id="${topic.id}"
                                            data-original-value="${topic.priority_weight || 3}">
                                        <option value="1" ${(topic.priority_weight || 3) == 1 ? 'selected' : ''}>1</option>
                                        <option value="2" ${(topic.priority_weight || 3) == 2 ? 'selected' : ''}>2</option>
                                        <option value="3" ${(topic.priority_weight || 3) == 3 ? 'selected' : ''}>3</option>
                                        <option value="4" ${(topic.priority_weight || 3) == 4 ? 'selected' : ''}>4</option>
                                        <option value="5" ${(topic.priority_weight || 3) == 5 ? 'selected' : ''}>5</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="topic-actions-mobile md:hidden">
                                <button class="delete-topic-btn text-sm px-3 py-1 rounded bg-red-50 hover:bg-red-100" 
                                        data-topic-id="${topic.id}" 
                                        data-description="${topic.description}">
                                    üóëÔ∏è Excluir
                                </button>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    header.classList.add('hidden');
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum t√≥pico adicionado ainda.</div>';
                }
                
                // Aplicar event listeners para tracking de mudan√ßas
                setupChangeTracking(subjectId);
                
            } catch (error) {
                header.classList.add('hidden');
                container.innerHTML = '<div class="text-center py-8 text-red-500">Erro ao carregar t√≥picos.</div>';
            }
        }

        // Fun√ß√£o para configurar o tracking de mudan√ßas em uma disciplina
        function setupChangeTracking(subjectId) {
            const container = document.getElementById(`topics-for-${subjectId}`);
            if (!container) return;

            // Event listeners para detectar mudan√ßas
            container.addEventListener('input', (e) => trackTopicChange(subjectId, e));
            container.addEventListener('change', (e) => trackTopicChange(subjectId, e));
        }

        // Fun√ß√£o para rastrear mudan√ßas em t√≥picos
        function trackTopicChange(subjectId, event) {
            // PRIMEIRO: Lidar com toggle de data para checkboxes (funciona independente do topicId)
            if (event.target.classList.contains('topic-checkbox')) {
                const topicItemDiv = event.target.closest('.topic-item');
                if (topicItemDiv) {
                    topicItemDiv.classList.toggle('show-date', event.target.checked);
                }
            }
            
            // SEGUNDO: Fazer o tracking de mudan√ßas (precisa do topicId)
            const topicId = event.target.dataset.topicId || event.target.getAttribute('data-topic-id');
            if (!topicId) {
                return; // Sem topicId, n√£o conseguimos fazer tracking, mas o toggle de data j√° funcionou
            }

            const topicItem = document.querySelector(`[data-topic-id="${topicId}"]`);
            if (!topicItem) {
                return;
            }

            // Obter valores atuais
            const checkbox = topicItem.querySelector('.topic-checkbox');
            const nameInput = topicItem.querySelector('.topic-name-input');
            const prioritySelect = topicItem.querySelector('.priority-select');
            const dateInput = topicItem.querySelector('.completion-date-input');

            const currentValues = {
                status: checkbox ? (checkbox.checked ? 'Conclu√≠do' : 'Pendente') : 'Pendente',
                description: nameInput ? nameInput.value : '',
                priority_weight: prioritySelect ? parseInt(prioritySelect.value) : 3,
                completion_date: (checkbox && checkbox.checked && dateInput) ? dateInput.value : null
            };

            // Obter valores originais
            const originalData = originalTopicsData[subjectId]?.find(t => t.id === topicId);
            if (!originalData) return;

            const originalValues = {
                status: originalData.status,
                description: originalData.description,
                priority_weight: originalData.priority_weight,
                completion_date: originalData.completion_date
            };

            // Verificar se houve mudan√ßas
            const hasChanges = (
                currentValues.status !== originalValues.status ||
                currentValues.description !== originalValues.description ||
                currentValues.priority_weight !== originalValues.priority_weight ||
                currentValues.completion_date !== originalValues.completion_date
            );

            // Atualizar tracking de mudan√ßas
            if (hasChanges) {
                subjectChanges[subjectId][topicId] = currentValues;
            } else {
                delete subjectChanges[subjectId][topicId];
            }

            // Atualizar interface visual
            updateTopicVisualState(topicId, hasChanges);
            updateSubjectSaveButton(subjectId);
        }

        // Fun√ß√£o para atualizar estado visual do t√≥pico
        function updateTopicVisualState(topicId, hasChanges) {
            const topicRow = document.querySelector(`[data-topic-id="${topicId}"]`);
            if (!topicRow) return;

            const nameInput = topicRow.querySelector('.topic-name-input');
            const prioritySelect = topicRow.querySelector('.priority-select');

            if (hasChanges) {
                topicRow.classList.add('modified');
                nameInput?.classList.add('modified');
                prioritySelect?.classList.add('modified');
            } else {
                topicRow.classList.remove('modified');
                nameInput?.classList.remove('modified');
                prioritySelect?.classList.remove('modified');
            }
        }

        // Fun√ß√£o para atualizar o bot√£o de salvar da disciplina
        function updateSubjectSaveButton(subjectId) {
            const saveBtn = document.querySelector(`[data-subject-id="${subjectId}"].save-changes-btn`);
            const cancelBtn = document.querySelector(`[data-subject-id="${subjectId}"].cancel-changes-btn`);
            const changesIndicator = document.getElementById(`changes-indicator-${subjectId}`);
            const changesCount = document.querySelector(`[data-subject-id="${subjectId}"] .changes-count`);
            const changesSummary = document.querySelector(`[data-subject-id="${subjectId}"] .changes-summary`);
            const saveBtnText = document.querySelector(`[data-subject-id="${subjectId}"] .save-btn-text`);

            if (!saveBtn) return;

            const changesForSubject = subjectChanges[subjectId] || {};
            const changeCount = Object.keys(changesForSubject).length;
            const hasChanges = changeCount > 0;

            // Atualizar bot√µes
            saveBtn.disabled = !hasChanges;
            
            if (hasChanges) {
                saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                cancelBtn?.classList.remove('hidden');
                changesIndicator?.classList.remove('hidden');
                changesCount?.classList.remove('hidden');
                changesCount.textContent = `${changeCount}`;
                changesSummary.textContent = `${changeCount} altera√ß√£o${changeCount > 1 ? '√µes' : ''} pendente${changeCount > 1 ? 's' : ''}`;
                saveBtnText.textContent = 'Salvar Altera√ß√µes';
            } else {
                saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                cancelBtn?.classList.add('hidden');
                changesIndicator?.classList.add('hidden');
                changesCount?.classList.add('hidden');
                changesSummary.textContent = 'Nenhuma altera√ß√£o pendente';
                saveBtnText.textContent = 'Salvar Altera√ß√µes';
            }
        }

        // Fun√ß√£o para salvar altera√ß√µes em lote
        async function saveSubjectChanges(subjectId) {
            const changesForSubject = subjectChanges[subjectId] || {};
            const topicsToUpdate = Object.entries(changesForSubject).map(([topicId, changes]) => ({
                id: topicId,
                ...changes
            }));

            if (topicsToUpdate.length === 0) {
                app.showToast('Nenhuma altera√ß√£o para salvar.', 'info');
                return;
            }

            const saveBtn = document.querySelector(`[data-subject-id="${subjectId}"].save-changes-btn`);
            const saveBtnText = saveBtn?.querySelector('.save-btn-text');
            
            if (saveBtn) {
                saveBtn.disabled = true;
                const originalText = saveBtnText?.textContent || 'Salvar Altera√ß√µes';
                if (saveBtnText) saveBtnText.textContent = 'Salvando...';

                app.showSpinner();
                try {
                    const response = await app.apiFetch('/topics/batch_update', {
                        method: 'PATCH',
                        body: JSON.stringify({ topics: topicsToUpdate })
                    });

                    app.showToast(`‚úÖ ${topicsToUpdate.length} t√≥pico${topicsToUpdate.length > 1 ? 's' : ''} atualizado${topicsToUpdate.length > 1 ? 's' : ''} com sucesso!`, 'success');
                    
                    // Invalidar cache e limpar mudan√ßas
                    app.invalidatePlanCache(planId);
                    subjectChanges[subjectId] = {};
                    
                    // Recarregar t√≥picos para sincronizar com servidor
                    await loadTopicsForSubject(subjectId);
                    
                } catch (error) {
                    app.showToast(`‚ùå Erro ao salvar: ${error.message}`, 'error');
                } finally {
                    app.hideSpinner();
                    if (saveBtn && saveBtnText) {
                        saveBtn.disabled = false;
                        saveBtnText.textContent = originalText;
                    }
                }
            }
        }

        // Fun√ß√£o para cancelar altera√ß√µes de uma disciplina
        function cancelSubjectChanges(subjectId) {
            // Limpar tracking de mudan√ßas
            subjectChanges[subjectId] = {};
            
            // Restaurar valores originais para todos os t√≥picos
            const originalTopics = originalTopicsData[subjectId] || [];
            
            originalTopics.forEach(topic => {
                const topicRow = document.querySelector(`[data-topic-id="${topic.id}"]`);
                if (!topicRow) return;

                // Restaurar checkbox
                const checkbox = topicRow.querySelector('.topic-checkbox');
                if (checkbox) {
                    checkbox.checked = topic.status === 'Conclu√≠do';
                }

                // Restaurar nome
                const nameInput = topicRow.querySelector('.topic-name-input');
                if (nameInput) {
                    nameInput.value = topic.description;
                }

                // Restaurar prioridade
                const prioritySelects = topicRow.querySelectorAll('.priority-select');
                prioritySelects.forEach(select => {
                    select.value = topic.priority_weight || 3;
                });

                // Restaurar data
                const dateInput = topicRow.querySelector('.completion-date-input');
                if (dateInput) {
                    const todayStr = new Date().toISOString().split('T')[0];
                    dateInput.value = topic.completion_date || todayStr;
                }

                // Restaurar estado visual
                topicRow.classList.remove('modified');
                const nameInputElement = topicRow.querySelector('.topic-name-input');
                const prioritySelectElement = topicRow.querySelector('.priority-select');
                nameInputElement?.classList.remove('modified');
                prioritySelectElement?.classList.remove('modified');

                // Restaurar campo de data
                topicRow.classList.toggle('show-date', topic.status === 'Conclu√≠do');
            });

            // Atualizar bot√µes
            updateSubjectSaveButton(subjectId);
            
            app.showToast('Altera√ß√µes canceladas com sucesso!', 'info');
        }

        // Fun√ß√£o para deletar um t√≥pico
        async function deleteTopic(topicId) {
            app.showSpinner();
            try {
                await app.apiFetch(`/topics/${topicId}`, { method: 'DELETE' });
                app.showToast('T√≥pico exclu√≠do com sucesso!', 'success');
                
                // Recarregar a disciplina que cont√©m este t√≥pico
                const topicElement = document.querySelector(`[data-topic-id="${topicId}"]`);
                if (topicElement) {
                    const container = topicElement.closest('[id^="topics-for-"]');
                    if (container) {
                        const subjectId = container.id.replace('topics-for-', '');
                        await loadTopicsForSubject(subjectId);
                    }
                }
                
                // Invalidar cache do plano
                app.invalidatePlanCache(planId);
                
            } catch (error) {
                app.showToast(`Erro ao excluir t√≥pico: ${error.message}`, 'error');
            } finally {
                app.hideSpinner();
            }
        }
        
        function getSettingsFromForm() {
            const settings = {
                daily_question_goal: document.getElementById('daily_goal').value,
                weekly_question_goal: document.getElementById('weekly_goal').value,
                session_duration_minutes: document.getElementById('session_duration').value,
                has_essay: document.getElementById('has_essay').checked,
                reta_final_mode: document.getElementById('retaFinalMode').checked,
                study_hours_per_day: {}
            };
            document.querySelectorAll('.hours-input').forEach(input => {
                settings.study_hours_per_day[input.dataset.day] = parseInt(input.value, 10) || 0;
            });
            return settings;
        }
        function showRetaFinalReport(excludedTopics, prioritizedSubjects) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4';
            
            // Agrupar t√≥picos exclu√≠dos por disciplina
            const excludedBySubject = excludedTopics.reduce((acc, topic) => {
                if (!acc[topic.subject_name]) {
                    acc[topic.subject_name] = [];
                }
                acc[topic.subject_name].push(topic.description);
                return acc;
            }, {});
            
            const totalIncluded = (prioritizedSubjects.length > 0) ? 'Calculando...' : 'N/A';
            const totalExcluded = excludedTopics.length;
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-red-700 flex items-center">
                            üéØ Relat√≥rio do Modo Reta Final
                        </h2>
                        <button class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                    </div>
                    
                    <!-- Resumo Estat√≠stico -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                            <div class="text-2xl font-bold text-green-600">${totalIncluded}</div>
                            <div class="text-sm text-green-700">T√≥picos Priorizados</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                            <div class="text-2xl font-bold text-red-600">${totalExcluded}</div>
                            <div class="text-sm text-red-700">T√≥picos Exclu√≠dos</div>
                        </div>
                    </div>
                    
                    <!-- Alerta Informativo -->
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                        <h3 class="font-semibold text-blue-800 mb-2">üí° Como funciona a prioriza√ß√£o?</h3>
                        <p class="text-sm text-blue-700">O algoritmo usa a f√≥rmula: <strong>(Peso da Disciplina √ó 10) + Peso do Assunto</strong></p>
                        <p class="text-xs text-blue-600 mt-1">Exemplo: Direito Constitucional (peso 5) + Direitos Fundamentais (prioridade 5) = 55 pontos</p>
                    </div>
                    
                    ${prioritizedSubjects.length > 0 ? `
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-green-800 mb-3 flex items-center">
                                ‚úÖ Disciplinas Priorizadas
                            </h3>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    ${prioritizedSubjects.map(s => `
                                        <div class="flex items-center justify-between bg-white p-2 rounded border">
                                            <span class="text-sm text-green-800 font-medium">${s.name}</span>
                                            <span class="text-xs bg-green-200 text-green-700 px-2 py-1 rounded">Peso ${s.weight}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${totalExcluded > 0 ? `
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-red-800 mb-3 flex items-center">
                                ‚ö†Ô∏è T√≥picos Exclu√≠dos por Tempo Limitado
                            </h3>
                            <div class="space-y-3">
                                ${Object.entries(excludedBySubject).map(([subject, topics]) => `
                                    <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                        <h4 class="font-semibold text-red-800 mb-2">${subject} (${topics.length} t√≥picos)</h4>
                                        <div class="max-h-32 overflow-y-auto">
                                            <ul class="space-y-1">
                                                ${topics.map(topic => `<li class="text-sm text-red-700">‚Ä¢ ${topic}</li>`).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Dicas de Otimiza√ß√£o -->
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
                            <h3 class="font-semibold text-yellow-800 mb-2">üìù Estrat√©gias de Estudo</h3>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                <li>‚Ä¢ <strong>Prioridade m√°xima:</strong> Foque nos t√≥picos do cronograma</li>
                                <li>‚Ä¢ <strong>Tempo extra:</strong> Estude os exclu√≠dos nas disciplinas mais importantes</li>
                                <li>‚Ä¢ <strong>Revis√£o r√°pida:</strong> Fa√ßa leitura din√¢mica dos t√≥picos exclu√≠dos</li>
                                <li>‚Ä¢ <strong>Quest√µes:</strong> Resolva quest√µes dos t√≥picos exclu√≠dos se sobrar tempo</li>
                            </ul>
                        </div>
                        
                        <!-- Bot√µes de A√ß√£o -->
                        <div class="flex flex-col sm:flex-row gap-3 mb-4">
                            <button id="exportExclusionsCsv" class="btn-secondary text-sm px-4 py-2">
                                üìÑ Exportar Lista (CSV)
                            </button>
                            <button id="viewOnSchedule" class="bg-blue-500 hover:bg-blue-600 text-white text-sm px-4 py-2 rounded-lg transition-colors">
                                üìÖ Ver no Cronograma
                            </button>
                        </div>
                    ` : ''}
                    
                    <div class="text-center">
                        <button id="closeModal" class="btn-primary px-6 py-2">Entendi, Fechar</button>
                    </div>
                </div>`;
                
            // Event listeners
            const closeBtn = modal.querySelector('#closeModal');
            const xBtn = modal.querySelector('button');
            const exportBtn = modal.querySelector('#exportExclusionsCsv');
            const viewBtn = modal.querySelector('#viewOnSchedule');
            
            const closeModal = () => modal.remove();
            
            closeBtn?.addEventListener('click', closeModal);
            xBtn?.addEventListener('click', closeModal);
            
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    exportExclusionsAsCsv(excludedTopics);
                });
            }
            
            if (viewBtn) {
                viewBtn.addEventListener('click', () => {
                    window.open(`cronograma.html?id=${planId}`, '_blank');
                });
            }
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            document.body.appendChild(modal);
        }
        
        function exportExclusionsAsCsv(excludedTopics) {
            let csvContent = 'Disciplina,T√≥pico,Motivo\n';
            
            excludedTopics.forEach(topic => {
                csvContent += `"${topic.subject_name}","${topic.description}","Tempo insuficiente - Modo Reta Final"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `topicos_excluidos_reta_final_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            app.showToast('üìÑ Lista exportada com sucesso!', 'success');
        }
        
        function handleEditSubject(id, name, priority) {
            document.getElementById('editModalTitle').textContent = 'Editar Disciplina';
            document.getElementById('editModalBody').innerHTML = `<form id="editSubjectForm" data-id="${id}" class="space-y-4"><div><label for="edit_subject_name" class="block text-sm font-medium text-gray-700">Nome</label><input type="text" id="edit_subject_name" value="${name}" class="form-input" required></div><div><label for="edit_priority_weight" class="block text-sm font-medium text-gray-700">Prioridade</label><input type="number" id="edit_priority_weight" value="${priority}" min="1" max="5" class="form-input" required></div><div class="flex justify-end space-x-3 pt-4"><button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 btn-cancel">Cancelar</button><button type="submit" class="btn-primary py-2 px-4 text-sm">Salvar</button></div></form>`;
            openModal();
            document.getElementById('editSubjectForm').addEventListener('submit', submitEditSubject);
        }

        function handleDeleteSubject(id, name) {
            document.getElementById('editModalTitle').textContent = 'Apagar Disciplina';
            document.getElementById('editModalBody').innerHTML = `<p>Voc√™ tem certeza que deseja apagar a disciplina "<strong>${name}</strong>"?</p><p class="mt-2 text-sm text-red-600">Aten√ß√£o: Todos os t√≥picos e o progresso associado ser√£o permanentemente removidos.</p><div class="flex justify-end space-x-3 pt-4 mt-4"><button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 btn-cancel">Cancelar</button><button id="confirmDeleteSubject" data-id="${id}" class="btn-danger px-4 py-2 text-sm">Sim, Apagar</button></div>`;
            openModal();
            document.getElementById('confirmDeleteSubject').addEventListener('click', submitDeleteSubject);
        }

        function handleEditTopic(id, description, priority = 3) {
            document.getElementById('editModalTitle').textContent = 'Editar T√≥pico';
            document.getElementById('editModalBody').innerHTML = `<form id="editTopicForm" data-id="${id}" class="space-y-4">
                <div>
                    <label for="edit_topic_description" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
                    <textarea id="edit_topic_description" class="form-input" rows="4" required>${description}</textarea>
                </div>
                <div>
                    <label for="edit_topic_priority" class="block text-sm font-medium text-gray-700">Peso do Assunto</label>
                    <select id="edit_topic_priority" class="form-input" required>
                        <option value="1" ${priority == 1 ? 'selected' : ''}>1 - Muito Baixa</option>
                        <option value="2" ${priority == 2 ? 'selected' : ''}>2 - Baixa</option>
                        <option value="3" ${priority == 3 ? 'selected' : ''}>3 - M√©dia</option>
                        <option value="4" ${priority == 4 ? 'selected' : ''}>4 - Alta</option>
                        <option value="5" ${priority == 5 ? 'selected' : ''}>5 - Muito Alta</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Define o peso espec√≠fico deste assunto dentro da disciplina (1-5)</p>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 btn-cancel">Cancelar</button>
                    <button type="submit" class="btn-primary py-2 px-4 text-sm">Salvar</button>
                </div>
            </form>`;
            openModal();
            document.getElementById('editTopicForm').addEventListener('submit', submitEditTopic);
        }

        function handleDeleteTopic(id, description) {
            document.getElementById('editModalTitle').textContent = 'Apagar T√≥pico';
            document.getElementById('editModalBody').innerHTML = `<p>Voc√™ tem certeza que deseja apagar o t√≥pico "<strong>${description}</strong>"?</p><div class="flex justify-end space-x-3 pt-4 mt-4"><button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 btn-cancel">Cancelar</button><button id="confirmDeleteTopic" data-id="${id}" class="btn-danger px-4 py-2 text-sm">Sim, Apagar</button></div>`;
            openModal();
            document.getElementById('confirmDeleteTopic').addEventListener('click', submitDeleteTopic);
        }
        
        async function submitApiRequestWrapper(url, method, body, successMessage) {
            app.showSpinner();
            try {
                const data = await app.apiFetch(url, { method, body: body ? JSON.stringify(body) : undefined });
                app.showToast(successMessage || data.message, 'success');
                closeModal();
                await loadSubjects();
                document.getElementById('generateButton').disabled = false;
            } catch (error) {
                app.showToast(error.message, 'error');
            } finally {
                app.hideSpinner();
            }
        }

        async function submitEditSubject(event) {
            event.preventDefault();
            const id = event.target.dataset.id;
            const body = { subject_name: document.getElementById('edit_subject_name').value, priority_weight: document.getElementById('edit_priority_weight').value };
            await submitApiRequestWrapper(`/subjects/${id}`, 'PATCH', body, 'Disciplina atualizada!');
        }
        async function submitDeleteSubject(event) {
            await submitApiRequestWrapper(`/subjects/${event.target.dataset.id}`, 'DELETE', null, 'Disciplina apagada!');
        }
        async function submitEditTopic(event) {
            event.preventDefault();
            const id = event.target.dataset.id;
            const body = { 
                description: document.getElementById('edit_topic_description').value,
                priority_weight: parseInt(document.getElementById('edit_topic_priority').value)
            };
            await submitApiRequestWrapper(`/topics/${id}`, 'PATCH', body, 'T√≥pico atualizado!');
        }
        async function submitDeleteTopic(event) {
            await submitApiRequestWrapper(`/plans/topics/${event.target.dataset.id}`, 'DELETE', null, 'T√≥pico apagado!');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initialize();
            
            const generateButton = document.getElementById('generateButton');
            const generalSettingsForm = document.getElementById('generalSettingsForm');
            const newContentForm = document.getElementById('newContentForm');
            
            generateButton.disabled = true;
            
            const enableGenerateButton = () => { generateButton.disabled = false; };
            
            generalSettingsForm.addEventListener('input', enableGenerateButton);
            newContentForm.addEventListener('submit', enableGenerateButton);

            // Event listener removido - agora integrado no sistema de tracking de mudan√ßas

            newContentForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const form = event.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                
                // Evitar submiss√µes m√∫ltiplas
                if (submitBtn.disabled) return;
                submitBtn.disabled = true;
                const originalBtnText = submitBtn.textContent;
                submitBtn.textContent = 'Adicionando...';
                
                const body = { subject_name: document.getElementById('subject_name').value, priority_weight: document.getElementById('priority_weight').value, topics_list: document.getElementById('topics_list').value };
                app.showSpinner();
                try {
                    const data = await app.apiFetch(`/plans/${planId}/subjects_with_topics`, { method: 'POST', body: JSON.stringify(body) });
                    app.showToast(data.message, 'success');
                    form.reset();
                    await loadSubjects();
                } catch (error) {
                    app.showToast(error.message, 'error');
                } finally {
                    app.hideSpinner();
                    // Restaurar bot√£o
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            });

            document.getElementById('subjectsContainer').addEventListener('click', async (event) => {
                const button = event.target.closest('button');
                
                if (!button) {
                    const header = event.target.closest('.accordion-header');
                    if (header) {
                        const content = header.nextElementSibling;
                        header.classList.toggle('open');
                        content.style.maxHeight = header.classList.contains('open') ? content.scrollHeight + "px" : null;
                    }
                    return;
                }

                if (button.classList.contains('save-changes-btn')) {
                    event.preventDefault();
                    
                    // Evitar cliques m√∫ltiplos
                    if (button.disabled) return;
                    
                    const subjectId = button.dataset.subjectId;
                    await saveSubjectChanges(subjectId);
                    enableGenerateButton();
                } else if (button.classList.contains('cancel-changes-btn')) {
                    event.preventDefault();
                    
                    const subjectId = button.dataset.subjectId;
                    if (confirm('Tem certeza que deseja cancelar todas as altera√ß√µes? Esta a√ß√£o n√£o pode ser desfeita.')) {
                        cancelSubjectChanges(subjectId);
                    }
                } else if (button.classList.contains('edit-subject-btn')) {
                    handleEditSubject(button.dataset.subjectId, button.dataset.subjectName, button.dataset.priority);
                } else if (button.classList.contains('delete-subject-btn')) {
                    handleDeleteSubject(button.dataset.subjectId, button.dataset.subjectName);
                } else if (button.classList.contains('delete-topic-btn')) {
                    // Nova confirma√ß√£o simplificada para exclus√£o de t√≥picos
                    const topicId = button.dataset.topicId;
                    const description = button.dataset.description;
                    
                    if (confirm(`Tem certeza que deseja excluir o t√≥pico "${description}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
                        await deleteTopic(topicId);
                    }
                }
            });

            generalSettingsForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                app.showSpinner();
                try {
                    const settings = getSettingsFromForm();
                    await app.apiFetch(`/plans/${planId}/settings`, {
                        method: 'PATCH',
                        body: JSON.stringify(settings)
                    });
                    app.showToast("Configura√ß√µes salvas com sucesso!", 'success');
                } catch (error) {
                    app.showToast(error.message, 'error');
                } finally {
                    app.hideSpinner();
                }
            });

            generateButton.addEventListener('click', async (event) => {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = 'Gerando...';
                app.showSpinner();
                
                try {
                    const settings = getSettingsFromForm();
                    const result = await app.apiFetch(`/plans/${planId}/generate`, {
                        method: 'POST',
                        body: JSON.stringify(settings)
                    });

                    if (result.retaFinal && result.retaFinal.excludedTopics.length > 0) {
                        showRetaFinalReport(result.retaFinal.excludedTopics, result.retaFinal.prioritizedSubjects || []);
                    }
                    app.showToast(result.message, 'success');
                    app.invalidatePlanCache(planId);
                } catch (error) {
                    app.showToast(error.message, 'error');
                } finally {
                    app.hideSpinner();
                    btn.textContent = 'Gerar/Atualizar Cronograma';
                }
            });
            
            editModal.addEventListener('click', (event) => {
                if (event.target === editModal || event.target.closest('.btn-cancel')) {
                    closeModal();
                }
            });
            
            // Event Listeners para novas funcionalidades
            
            // Bot√µes do welcome message
            const startGuideBtn = document.getElementById('startGuideBtn');
            const skipGuideBtn = document.getElementById('skipGuideBtn');
            
            if (startGuideBtn) {
                startGuideBtn.addEventListener('click', () => {
                    document.getElementById('welcome-message').classList.add('hidden');
                    startGuide();
                });
            }
            
            if (skipGuideBtn) {
                skipGuideBtn.addEventListener('click', () => {
                    document.getElementById('welcome-message').classList.add('hidden');
                });
            }
            
            // Templates de disciplinas
            const loadTemplateBtn = document.getElementById('loadTemplateBtn');
            const disciplineTemplates = document.getElementById('disciplineTemplates');
            
            if (loadTemplateBtn) {
                loadTemplateBtn.addEventListener('click', () => {
                    disciplineTemplates.classList.toggle('hidden');
                });
            }
            
            // Event listener para templates de disciplina
            document.querySelectorAll('.template-discipline-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const name = this.dataset.name;
                    const priority = this.dataset.priority;
                    const topics = this.dataset.topics;
                    
                    document.getElementById('subject_name').value = name;
                    document.getElementById('priority_weight').value = priority;
                    document.getElementById('topics_list').value = topics;
                    
                    // Feedback visual
                    this.classList.add('bg-blue-100', 'border-blue-300');
                    setTimeout(() => {
                        this.classList.remove('bg-blue-100', 'border-blue-300');
                    }, 1000);
                    
                    // Fechar templates
                    disciplineTemplates.classList.add('hidden');
                    
                    // Atualizar contador de t√≥picos
                    updateTopicCounter();
                });
            });
            
            // Contador de t√≥picos
            function updateTopicCounter() {
                const topicsTextarea = document.getElementById('topics_list');
                const topicCounter = document.getElementById('topicCount');
                
                if (topicsTextarea && topicCounter) {
                    const lines = topicsTextarea.value.split('\n').filter(line => line.trim().length > 0);
                    topicCounter.textContent = `${lines.length} t√≥picos`;
                }
            }
            
            // Event listener para atualizar contador
            const topicsTextarea = document.getElementById('topics_list');
            if (topicsTextarea) {
                topicsTextarea.addEventListener('input', updateTopicCounter);
            }
            
            // Bot√£o de exemplo
            const showExampleBtn = document.getElementById('showExampleBtn');
            const exampleModal = document.getElementById('exampleModal');
            const closeExampleBtn = document.getElementById('closeExampleBtn');
            
            if (showExampleBtn) {
                showExampleBtn.addEventListener('click', () => {
                    exampleModal.classList.remove('hidden');
                });
            }
            
            if (closeExampleBtn) {
                closeExampleBtn.addEventListener('click', () => {
                    exampleModal.classList.add('hidden');
                });
            }
            
            // Fechar modal clicando fora
            if (exampleModal) {
                exampleModal.addEventListener('click', (e) => {
                    if (e.target === exampleModal) {
                        exampleModal.classList.add('hidden');
                    }
                });
            }
            
            // Presets de metas
            document.querySelectorAll('.goal-preset').forEach(btn => {
                btn.addEventListener('click', function() {
                    const daily = this.dataset.daily;
                    const weekly = this.dataset.weekly;
                    
                    document.getElementById('daily_goal').value = daily;
                    document.getElementById('weekly_goal').value = weekly;
                    
                    // Feedback visual
                    this.classList.add('bg-blue-200');
                    setTimeout(() => {
                        this.classList.remove('bg-blue-200');
                    }, 500);
                });
            });
            
            // Atualizar meta semanal automaticamente
            const dailyGoalInput = document.getElementById('daily_goal');
            const weeklyGoalInput = document.getElementById('weekly_goal');
            
            if (dailyGoalInput && weeklyGoalInput) {
                dailyGoalInput.addEventListener('input', function() {
                    const dailyValue = parseInt(this.value) || 0;
                    weeklyGoalInput.value = dailyValue * 7;
                    updateProgress();
                });
            }
            
            // Debounce para updateProgress para evitar chamadas excessivas
            let updateProgressTimeout;
            const debouncedUpdateProgress = () => {
                clearTimeout(updateProgressTimeout);
                updateProgressTimeout = setTimeout(updateProgress, 300);
            };
            
            // Atualizar progresso quando houver mudan√ßas (com debounce)
            document.addEventListener('change', debouncedUpdateProgress);
            document.addEventListener('input', debouncedUpdateProgress);
            
            // Atualizar progresso inicial
            setTimeout(updateProgress, 1000);
        });
    </script>
    
    <!-- Script do rodap√© modular -->
    <script src="js/footer.js"></script>
    <!-- O rodap√© ser√° inserido automaticamente aqui pelo footer.js -->
</body>
</html>