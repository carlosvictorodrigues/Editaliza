/**
 * Teste de Sistema de Gamifica√ß√£o - Vers√£o Corrigida
 * Baseado no test-plataforma-completo.js que funciona
 */

const axios = require('axios');
const colors = require('colors');

const API_BASE_URL = 'http://localhost:3000/api';

// Dados do teste
const timestamp = Date.now();
const testUser = {
    name: `Gamification Test ${timestamp}`,
    email: `gamification.${timestamp}@editaliza.com`,
    password: 'Test@123456'
};

let authToken = null;
let userId = null;
let planId = null;

async function makeRequest(method, endpoint, data = null, includeAuth = true) {
    const config = {
        method,
        url: `${API_BASE_URL}${endpoint}`,
        headers: {
            'Content-Type': 'application/json'
        }
    };

    if (authToken && includeAuth) {
        config.headers.Authorization = `Bearer ${authToken}`;
    }

    if (data) {
        config.data = data;
    }

    try {
        const response = await axios(config);
        return { success: true, data: response.data, status: response.status };
    } catch (error) {
        return { 
            success: false, 
            error: error.response?.data || error.message, 
            status: error.response?.status 
        };
    }
}

async function testarGamificacao() {
    console.log('\n================================='.cyan);
    console.log('üéÆ TESTE DE GAMIFICA√á√ÉO'.cyan.bold);
    console.log('=================================\n'.cyan);

    try {
        // ========== 1. REGISTRO ==========
        console.log('1Ô∏è‚É£ REGISTRO DO USU√ÅRIO'.yellow.bold);
        console.log('-'.repeat(40));
        
        const registerResult = await makeRequest('POST', '/auth/register', testUser, false);
        
        if (!registerResult.success) {
            throw new Error(`Erro no registro: ${JSON.stringify(registerResult.error)}`);
        }
        
        authToken = registerResult.data.token;
        userId = registerResult.data.user?.id || registerResult.data.userId;
        
        console.log('‚úÖ Usu√°rio registrado com sucesso'.green);
        console.log(`   Email: ${testUser.email}`.gray);
        console.log(`   User ID: ${userId}`.gray);
        
        // ========== 2. VERIFICAR PERFIL INICIAL ==========
        console.log('\n2Ô∏è‚É£ PERFIL DE GAMIFICA√á√ÉO INICIAL'.yellow.bold);
        console.log('-'.repeat(40));
        
        const initialProfile = await makeRequest('GET', '/gamification/profile');
        
        if (initialProfile.success) {
            console.log('üìä Estado Inicial:'.cyan);
            console.log(`   XP: ${initialProfile.data.xp}`.gray);
            console.log(`   N√≠vel: ${initialProfile.data.level}`.gray);
            console.log(`   Streak: ${initialProfile.data.current_streak} dias`.gray);
            console.log(`   Conquistas: ${initialProfile.data.achievements?.length || 0}`.gray);
        } else {
            console.log('‚ö†Ô∏è Perfil n√£o encontrado (ser√° criado automaticamente)'.yellow);
        }
        
        // ========== 3. CRIAR PLANO DE ESTUDOS ==========
        console.log('\n3Ô∏è‚É£ CRIA√á√ÉO DO PLANO DE ESTUDOS'.yellow.bold);
        console.log('-'.repeat(40));
        
        const examDate = new Date('2025-11-21'); // Data real da prova TJPE
        
        const planData = {
            plan_name: 'Teste Gamifica√ß√£o - TJPE 2025',
            exam_date: examDate.toISOString().split('T')[0],
            daily_question_goal: 20,
            weekly_question_goal: 120,
            session_duration_minutes: 45
        };
        
        const planResult = await makeRequest('POST', '/plans', planData);
        
        if (!planResult.success) {
            throw new Error(`Erro ao criar plano: ${JSON.stringify(planResult.error)}`);
        }
        
        planId = planResult.data.planId;
        console.log('‚úÖ Plano criado com sucesso'.green);
        console.log(`   ID do Plano: ${planId}`.gray);
        console.log(`   Nome: ${planData.plan_name}`.gray);
        
        // ========== 4. ADICIONAR DISCIPLINAS E T√ìPICOS ==========
        console.log('\n4Ô∏è‚É£ ADICIONANDO DISCIPLINAS E T√ìPICOS'.yellow.bold);
        console.log('-'.repeat(40));
        
        const disciplinas = [
            { 
                nome: 'Direito Administrativo', 
                peso: 5,
                topicos: [
                    { nome: 'Princ√≠pios do Direito Administrativo', peso: 5 },
                    { nome: 'Atos administrativos', peso: 5 },
                    { nome: 'Licita√ß√£o - conceito e princ√≠pios', peso: 5 }
                ]
            },
            { 
                nome: 'Portugu√™s', 
                peso: 4,
                topicos: [
                    { nome: 'Compreens√£o e interpreta√ß√£o de textos', peso: 5 },
                    { nome: 'Ortografia, acentua√ß√£o e pontua√ß√£o', peso: 4 }
                ]
            }
        ];
        
        for (const disc of disciplinas) {
            const subjectResult = await makeRequest('POST', `/subjects`, {
                subject_name: disc.nome,
                weight: disc.peso,
                priority_weight: disc.peso,
                study_plan_id: planId
            });
            
            if (!subjectResult.success) {
                console.log(`   ‚ö†Ô∏è Erro ao criar ${disc.nome}: ${subjectResult.error}`.yellow);
                continue;
            }
            
            const subjectId = subjectResult.data.subject.id;
            console.log(`   ‚úÖ ${disc.nome} criada (ID: ${subjectId})`.green);
            
            // Adicionar t√≥picos
            for (const topico of disc.topicos) {
                const topicResult = await makeRequest('POST', `/subjects/${subjectId}/topics`, {
                    topic_name: topico.nome,
                    topic_description: `Descri√ß√£o: ${topico.nome}`,
                    weight: topico.peso,
                    priority_weight: topico.peso,
                    subject_id: subjectId
                });
                
                if (topicResult.success) {
                    console.log(`      + ${topico.nome}`.gray);
                }
            }
        }
        
        // ========== 5. GERAR CRONOGRAMA ==========
        console.log('\n5Ô∏è‚É£ GERANDO CRONOGRAMA DE ESTUDOS'.yellow.bold);
        console.log('-'.repeat(40));
        
        const scheduleData = {
            start_date: new Date().toISOString().split('T')[0],
            exam_date: examDate.toISOString().split('T')[0],
            study_hours_per_day: {
                'Seg': 4,
                'Ter': 4,
                'Qua': 4,
                'Qui': 4,
                'Sex': 4,
                'Sab': 2,
                'Dom': 2
            }
        };
        
        const scheduleResult = await makeRequest('POST', `/plans/${planId}/generate`, scheduleData);
        
        if (!scheduleResult.success) {
            console.log('‚ö†Ô∏è Aviso ao gerar cronograma:'.yellow, scheduleResult.error);
        } else {
            console.log('‚úÖ Cronograma gerado com sucesso'.green);
        }
        
        // ========== 6. BUSCAR SESS√ïES ==========
        console.log('\n6Ô∏è‚É£ BUSCANDO SESS√ïES DE ESTUDO'.yellow.bold);
        console.log('-'.repeat(40));
        
        const sessionsResult = await makeRequest('GET', `/plans/${planId}/sessions`);
        
        if (!sessionsResult.success || !sessionsResult.data.sessions?.length) {
            throw new Error('Nenhuma sess√£o encontrada');
        }
        
        const sessions = sessionsResult.data.sessions;
        console.log(`‚úÖ ${sessions.length} sess√µes encontradas`.green);
        
        // ========== 7. COMPLETAR PRIMEIRA SESS√ÉO ==========
        console.log('\n7Ô∏è‚É£ COMPLETANDO PRIMEIRA SESS√ÉO'.yellow.bold);
        console.log('-'.repeat(40));
        
        const firstSession = sessions[0];
        console.log(`   Sess√£o ID: ${firstSession.id}`.gray);
        console.log(`   T√≥pico: ${firstSession.topic_name || 'N/A'}`.gray);
        
        // Marcar como conclu√≠da
        const completeResult = await makeRequest('PATCH', `/sessions/${firstSession.id}`, {
            status: 'Conclu√≠do',
            questions_solved: 15,
            notes: 'Sess√£o completada com sucesso - teste de gamifica√ß√£o'
        });
        
        if (!completeResult.success) {
            console.log('‚ö†Ô∏è Aviso ao completar sess√£o:'.yellow, completeResult.error);
        } else {
            console.log('‚úÖ Sess√£o marcada como conclu√≠da'.green);
        }
        
        // Registrar tempo de estudo
        const timeResult = await makeRequest('POST', `/sessions/${firstSession.id}/time`, {
            time_seconds: 2700 // 45 minutos
        });
        
        if (timeResult.success) {
            console.log('‚úÖ Tempo de estudo registrado: 45 minutos'.green);
        }
        
        // ========== 8. AGUARDAR PROCESSAMENTO ==========
        console.log('\n‚è≥ Aguardando processamento da gamifica√ß√£o...'.yellow);
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // ========== 9. VERIFICAR PERFIL ATUALIZADO ==========
        console.log('\n9Ô∏è‚É£ PERFIL DE GAMIFICA√á√ÉO ATUALIZADO'.yellow.bold);
        console.log('-'.repeat(40));
        
        const finalProfile = await makeRequest('GET', '/gamification/profile');
        
        if (!finalProfile.success) {
            console.log('‚ùå Erro ao buscar perfil final:'.red, finalProfile.error);
        } else {
            const initialXP = initialProfile.data?.xp || 0;
            const finalXP = finalProfile.data.xp;
            const xpGained = finalXP - initialXP;
            
            console.log('\nüìä RESULTADOS DA GAMIFICA√á√ÉO:'.cyan.bold);
            console.log('‚ïê'.repeat(40).cyan);
            
            console.log('\nüìà Progresso de XP:'.yellow);
            console.log(`   Inicial: ${initialXP} XP`.gray);
            console.log(`   Final: ${finalXP} XP`.gray);
            console.log(`   Ganho: ${xpGained > 0 ? '+' : ''}${xpGained} XP ${xpGained > 0 ? '‚ú®' : ''}`.green);
            
            console.log('\nüéñÔ∏è N√≠vel:'.yellow);
            console.log(`   N√≠vel Atual: ${finalProfile.data.level}`.gray);
            if (finalProfile.data.level_info) {
                console.log(`   T√≠tulo: ${finalProfile.data.level_info.title}`.cyan);
                if (finalProfile.data.level_info.phrase) {
                    console.log(`   Frase: "${finalProfile.data.level_info.phrase}"`.gray);
                }
            }
            
            console.log('\nüî• Streak:'.yellow);
            console.log(`   Dias consecutivos: ${finalProfile.data.current_streak}`.gray);
            console.log(`   Maior streak: ${finalProfile.data.longest_streak}`.gray);
            
            if (finalProfile.data.achievements?.length > 0) {
                console.log('\nüèÜ Conquistas Desbloqueadas:'.yellow);
                finalProfile.data.achievements.forEach(ach => {
                    console.log(`   ‚Ä¢ ${ach.achievement_id}`.gray);
                });
            }
            
            // ========== 10. AN√ÅLISE FINAL ==========
            console.log('\nüìã AN√ÅLISE DO SISTEMA:'.yellow.bold);
            console.log('‚ïê'.repeat(40).cyan);
            
            if (xpGained > 0) {
                console.log('‚úÖ Sistema de XP funcionando corretamente'.green);
                console.log(`   Voc√™ ganhou ${xpGained} XP por completar a sess√£o`.gray);
            } else {
                console.log('‚ùå PROBLEMA DETECTADO: XP n√£o foi atualizado'.red);
                console.log('   Verifique o GamificationService'.gray);
            }
            
            if (finalProfile.data.current_streak > 0) {
                console.log('‚úÖ Sistema de streak funcionando'.green);
            }
            
            console.log('\nüí° Dicas para ganhar mais XP:'.yellow);
            console.log('   ‚Ä¢ Complete mais sess√µes de estudo'.gray);
            console.log('   ‚Ä¢ Resolva quest√µes durante as sess√µes'.gray);
            console.log('   ‚Ä¢ Mantenha uma sequ√™ncia di√°ria de estudos'.gray);
            console.log('   ‚Ä¢ Complete t√≥picos inteiros'.gray);
        }
        
        // ========== 11. COMPLETAR MAIS SESS√ïES (OPCIONAL) ==========
        if (sessions.length > 1) {
            console.log('\nüéØ TESTE ADICIONAL: Completando segunda sess√£o...'.yellow.bold);
            console.log('-'.repeat(40));
            
            const secondSession = sessions[1];
            
            await makeRequest('PATCH', `/sessions/${secondSession.id}`, {
                status: 'Conclu√≠do',
                questions_solved: 20
            });
            
            await makeRequest('POST', `/sessions/${secondSession.id}/time`, {
                time_seconds: 3600 // 1 hora
            });
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const extraProfile = await makeRequest('GET', '/gamification/profile');
            if (extraProfile.success) {
                const extraXP = extraProfile.data.xp - finalProfile.data.xp;
                console.log(`‚úÖ Segunda sess√£o completada: +${extraXP} XP`.green);
                console.log(`   XP Total: ${extraProfile.data.xp}`.gray);
            }
        }
        
    } catch (error) {
        console.error('\n‚ùå ERRO NO TESTE:'.red.bold, error.message);
        if (error.response?.data) {
            console.error('Detalhes do erro:', JSON.stringify(error.response.data, null, 2));
        }
    }
    
    console.log('\n================================='.cyan);
    console.log('üèÅ TESTE FINALIZADO'.cyan.bold);
    console.log('=================================\n'.cyan);
    
    process.exit(0);
}

// Executar teste
console.log('üöÄ Iniciando teste de gamifica√ß√£o...'.cyan);
console.log('   Certifique-se que o servidor est√° rodando na porta 3000'.gray);
console.log('');

testarGamificacao().catch(error => {
    console.error('Erro fatal:', error);
    process.exit(1);
});