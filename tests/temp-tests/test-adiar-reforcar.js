/**
 * Teste dos bot√µes Adiar e Refor√ßar
 * Verifica se os endpoints est√£o funcionando corretamente
 */

const axios = require('axios');
const colors = require('colors');

const API_BASE_URL = 'http://localhost:3000/api';

// Dados do teste
const timestamp = Date.now();
const testUser = {
    name: `Test Adiar Reforcar ${timestamp}`,
    email: `test.adiar.reforcar.${timestamp}@editaliza.com`,
    password: 'Test@123456'
};

let authToken = null;
let userId = null;
let planId = null;
let sessionId = null;

async function makeRequest(method, endpoint, data = null, includeAuth = true) {
    const config = {
        method,
        url: `${API_BASE_URL}${endpoint}`,
        headers: {
            'Content-Type': 'application/json'
        }
    };

    if (authToken && includeAuth) {
        config.headers.Authorization = `Bearer ${authToken}`;
    }

    if (data) {
        config.data = data;
    }

    try {
        const response = await axios(config);
        return { success: true, data: response.data, status: response.status };
    } catch (error) {
        return { 
            success: false, 
            error: error.response?.data || error.message, 
            status: error.response?.status 
        };
    }
}

async function testarBotoesAdiarReforcar() {
    console.log('\n================================='.cyan);
    console.log('üîÑ TESTE DOS BOT√ïES ADIAR E REFOR√áAR'.cyan.bold);
    console.log('=================================\n'.cyan);

    try {
        // ========== 1. SETUP INICIAL ==========
        console.log('1Ô∏è‚É£ SETUP INICIAL'.yellow.bold);
        console.log('-'.repeat(40));
        
        // Registrar usu√°rio
        const registerResult = await makeRequest('POST', '/auth/register', testUser, false);
        if (!registerResult.success) {
            throw new Error(`Erro no registro: ${JSON.stringify(registerResult.error)}`);
        }
        
        authToken = registerResult.data.token;
        userId = registerResult.data.user?.id || registerResult.data.userId;
        console.log('‚úÖ Usu√°rio registrado'.green);
        
        // Criar plano (com exam_date no formato correto)
        const examDate = new Date('2025-11-21');
        const planData = {
            plan_name: 'Teste Bot√µes Adiar/Refor√ßar',
            exam_date: examDate.toISOString().split('T')[0],
            daily_question_goal: 20,
            weekly_question_goal: 120,
            session_duration_minutes: 45
        };
        
        const planResult = await makeRequest('POST', '/plans', planData);
        if (!planResult.success) {
            throw new Error(`Erro ao criar plano: ${JSON.stringify(planResult.error)}`);
        }
        
        planId = planResult.data.planId;
        console.log('‚úÖ Plano criado'.green);
        
        // Adicionar disciplina e t√≥pico
        const subjectResult = await makeRequest('POST', '/subjects', {
            subject_name: 'Teste Disciplina',
            weight: 5,
            priority_weight: 5,
            study_plan_id: planId
        });
        
        if (!subjectResult.success) {
            throw new Error(`Erro ao criar disciplina: ${JSON.stringify(subjectResult.error)}`);
        }
        
        const subjectId = subjectResult.data.subject.id;
        console.log('‚úÖ Disciplina criada'.green);
        
        // Adicionar t√≥pico
        await makeRequest('POST', `/subjects/${subjectId}/topics`, {
            topic_name: 'T√≥pico para Teste',
            topic_description: 'Teste dos bot√µes adiar e refor√ßar',
            weight: 5,
            priority_weight: 5,
            subject_id: subjectId
        });
        
        console.log('‚úÖ T√≥pico criado'.green);
        
        // Gerar cronograma
        const scheduleResult = await makeRequest('POST', `/plans/${planId}/generate`, {
            start_date: new Date().toISOString().split('T')[0],
            exam_date: examDate.toISOString().split('T')[0],
            study_hours_per_day: {
                'Seg': 4,
                'Ter': 4,
                'Qua': 4,
                'Qui': 4,
                'Sex': 4,
                'Sab': 2,
                'Dom': 0
            }
        });
        
        if (!scheduleResult.success) {
            console.log('‚ö†Ô∏è Aviso ao gerar cronograma:'.yellow, scheduleResult.error);
        } else {
            console.log('‚úÖ Cronograma gerado'.green);
        }
        
        // Buscar sess√µes
        const sessionsResult = await makeRequest('GET', `/plans/${planId}/sessions`);
        
        if (!sessionsResult.success) {
            console.log('‚ùå Erro ao buscar sess√µes:'.red, sessionsResult.error);
            throw new Error('Erro ao buscar sess√µes');
        }
        
        const sessions = sessionsResult.data?.sessions || sessionsResult.data || [];
        
        if (sessions.length === 0) {
            console.log('‚ö†Ô∏è Nenhuma sess√£o encontrada ap√≥s gerar cronograma'.yellow);
            throw new Error('Nenhuma sess√£o encontrada');
        }
        sessionId = sessions[0].id;
        console.log(`‚úÖ ${sessions.length} sess√µes encontradas`.green);
        console.log(`   Sess√£o selecionada: ID ${sessionId}`.gray);
        
        // ========== 2. TESTAR BOT√ÉO ADIAR ==========
        console.log('\n2Ô∏è‚É£ TESTANDO BOT√ÉO ADIAR'.yellow.bold);
        console.log('-'.repeat(40));
        
        console.log('üìÖ Adiando sess√£o para amanh√£...');
        
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const postponeResult = await makeRequest('PATCH', `/sessions/${sessionId}/postpone`, {
            new_date: tomorrow.toISOString().split('T')[0],
            reason: 'Teste do bot√£o adiar'
        });
        
        if (postponeResult.success) {
            console.log('‚úÖ SUCESSO: Sess√£o adiada com sucesso!'.green.bold);
            console.log(`   Mensagem: ${postponeResult.data.message || 'Sess√£o reagendada'}`.gray);
            
            // Verificar se a data foi atualizada
            const updatedSession = await makeRequest('GET', `/sessions/${sessionId}`);
            if (updatedSession.success) {
                const newDate = updatedSession.data.session_date;
                console.log(`   Nova data: ${newDate}`.gray);
            }
        } else {
            console.log('‚ùå ERRO: Falha ao adiar sess√£o'.red.bold);
            console.log(`   Erro: ${JSON.stringify(postponeResult.error)}`.red);
            console.log(`   Status HTTP: ${postponeResult.status}`.gray);
        }
        
        // ========== 3. TESTAR BOT√ÉO REFOR√áAR ==========
        console.log('\n3Ô∏è‚É£ TESTANDO BOT√ÉO REFOR√áAR'.yellow.bold);
        console.log('-'.repeat(40));
        
        // Primeiro, marcar a sess√£o como conclu√≠da
        console.log('üìù Marcando sess√£o como conclu√≠da primeiro...');
        await makeRequest('PATCH', `/sessions/${sessionId}`, {
            status: 'Conclu√≠do',
            questions_solved: 10,
            notes: 'Sess√£o completada para teste de refor√ßo'
        });
        console.log('‚úÖ Sess√£o marcada como conclu√≠da'.green);
        
        console.log('üí™ Criando sess√£o de refor√ßo...');
        
        const reinforceResult = await makeRequest('POST', `/sessions/${sessionId}/reinforce`, {
            notes: 'Preciso refor√ßar este conte√∫do'
        });
        
        if (reinforceResult.success) {
            console.log('‚úÖ SUCESSO: Sess√£o de refor√ßo criada!'.green.bold);
            console.log(`   Mensagem: ${reinforceResult.data.message || 'Sess√£o de refor√ßo agendada'}`.gray);
            
            if (reinforceResult.data.newSession) {
                console.log(`   Nova sess√£o ID: ${reinforceResult.data.newSession.id}`.gray);
                console.log(`   Data agendada: ${reinforceResult.data.newSession.session_date}`.gray);
            }
            
            // Verificar se a nova sess√£o foi criada
            const allSessionsAfter = await makeRequest('GET', `/plans/${planId}/sessions`);
            if (allSessionsAfter.success) {
                const newSessionCount = allSessionsAfter.data.sessions.length;
                console.log(`   Total de sess√µes agora: ${newSessionCount} (era ${sessions.length})`.gray);
            }
        } else {
            console.log('‚ùå ERRO: Falha ao criar sess√£o de refor√ßo'.red.bold);
            console.log(`   Erro: ${JSON.stringify(reinforceResult.error)}`.red);
            console.log(`   Status HTTP: ${reinforceResult.status}`.gray);
        }
        
        // ========== 4. RESUMO FINAL ==========
        console.log('\n' + '='.repeat(50));
        console.log('üìã RESUMO DO TESTE'.yellow.bold);
        console.log('='.repeat(50));
        
        const adiarFuncionando = postponeResult.success;
        const reforcarFuncionando = reinforceResult.success;
        
        console.log('\nüîç Status dos Bot√µes:');
        console.log(`   üìÖ ADIAR: ${adiarFuncionando ? '‚úÖ FUNCIONANDO' : '‚ùå COM PROBLEMA'}`.bold);
        console.log(`   üí™ REFOR√áAR: ${reforcarFuncionando ? '‚úÖ FUNCIONANDO' : '‚ùå COM PROBLEMA'}`.bold);
        
        if (adiarFuncionando && reforcarFuncionando) {
            console.log('\nüéâ SUCESSO TOTAL! Ambos os bot√µes est√£o funcionando corretamente!'.green.bold);
        } else if (adiarFuncionando || reforcarFuncionando) {
            console.log('\n‚ö†Ô∏è SUCESSO PARCIAL: Apenas um bot√£o est√° funcionando'.yellow.bold);
        } else {
            console.log('\n‚ùå FALHA: Nenhum dos bot√µes est√° funcionando'.red.bold);
        }
        
        // ========== 5. TESTE ADICIONAL: M√öLTIPLOS ADIAMENTOS ==========
        if (adiarFuncionando) {
            console.log('\n5Ô∏è‚É£ TESTE ADICIONAL: M√öLTIPLOS ADIAMENTOS'.yellow.bold);
            console.log('-'.repeat(40));
            
            // Tentar adiar a mesma sess√£o novamente
            const secondPostpone = await makeRequest('PATCH', `/sessions/${sessionId}/postpone`, {
                new_date: tomorrow.toISOString().split('T')[0],
                reason: 'Segundo adiamento'
            });
            
            if (secondPostpone.success) {
                console.log('‚úÖ Segundo adiamento permitido'.green);
            } else {
                console.log('‚ö†Ô∏è Segundo adiamento bloqueado (pode ser intencional)'.yellow);
                console.log(`   Mensagem: ${JSON.stringify(secondPostpone.error)}`.gray);
            }
        }
        
    } catch (error) {
        console.error('\n‚ùå ERRO FATAL NO TESTE:'.red.bold, error.message);
        if (error.response?.data) {
            console.error('Detalhes do erro:', JSON.stringify(error.response.data, null, 2));
        }
    }
    
    console.log('\n================================='.cyan);
    console.log('üèÅ TESTE FINALIZADO'.cyan.bold);
    console.log('=================================\n'.cyan);
    
    process.exit(0);
}

// Executar teste
console.log('üöÄ Iniciando teste dos bot√µes Adiar e Refor√ßar...'.cyan);
console.log('   Certifique-se que o servidor est√° rodando na porta 3000'.gray);
console.log('');

testarBotoesAdiarReforcar().catch(error => {
    console.error('Erro fatal:', error);
    process.exit(1);
});