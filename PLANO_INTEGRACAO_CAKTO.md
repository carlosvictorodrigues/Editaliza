# üöÄ PLANO DE INTEGRA√á√ÉO CAKTO - EDITALIZA

## üìã Vis√£o Geral

Este plano detalha os **3 passos simples** para ativar completamente o sistema de pagamentos CAKTO no Editaliza, transformando a plataforma em um neg√≥cio monetizado.

### ‚ö° **Tempo Total Estimado: 3-4 horas**
### üéØ **Complexidade: BAIXA** (98% j√° est√° implementado)

---

## üîç **SITUA√á√ÉO ATUAL**

### ‚úÖ **O QUE J√Å FUNCIONA (98% COMPLETO)**
- **Webhook processor completo** com todos os eventos CAKTO
- **Sistema de valida√ß√£o de seguran√ßa** (HMAC, IP, timestamp)
- **Modelos de banco de dados** estruturados
- **Middleware de prote√ß√£o** implementado
- **Sistema de auditoria** funcionando
- **Email service** pronto para confirma√ß√µes
- **Circuit breaker e retry logic** implementados
- **Cache system** para performance

### üî¥ **O QUE EST√Å DESABILITADO**
- **3 tabelas do banco** precisam ser criadas
- **1 coluna** precisa ser adicionada √† tabela subscriptions
- **4 vari√°veis de ambiente** precisam ser configuradas
- **1 linha de c√≥digo** precisa ser descomentada

---

## üéØ **FLUXO IDEAL PLANEJADO**

```mermaid
graph LR
    A[Cliente acessa site] --> B[Escolhe plano]
    B --> C[Redireciona para CAKTO]
    C --> D[Cliente paga]
    D --> E[CAKTO processa]
    E --> F[Webhook disparado]
    F --> G[Sistema recebe]
    G --> H[Usu√°rio criado/atualizado]
    H --> I[Email enviado]
    I --> J[Cliente acessa premium]
```

---

## üìù **PLANO DE A√á√ÉO DETALHADO**

## **FASE 1: PREPARA√á√ÉO DO AMBIENTE (1 hora)**

### **1.1 Migra√ß√£o do Banco de Dados** ‚è±Ô∏è 30 min

#### **Executar script de migra√ß√£o**
```bash
# 1. Backup de seguran√ßa
npm run db:backup

# 2. Executar migra√ß√£o CAKTO
node src/cackto-integration/scripts/migrate-to-cackto.js

# 3. Verificar tabelas criadas
npm run db:status
```

#### **SQL ser√° executado automaticamente:**
```sql
-- Adicionar coluna para transa√ß√µes CAKTO
ALTER TABLE subscriptions ADD COLUMN cackto_transaction_id VARCHAR(255);
CREATE INDEX idx_cackto_transaction_id ON subscriptions(cackto_transaction_id);

-- Criar tabelas espec√≠ficas CAKTO
CREATE TABLE integration_metrics (
    id SERIAL PRIMARY KEY,
    metric_type VARCHAR(100) NOT NULL,
    metric_value DECIMAL(10,2) NOT NULL,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE cackto_cache (
    cache_key VARCHAR(255) PRIMARY KEY,
    cache_value JSONB NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE webhook_events (
    id SERIAL PRIMARY KEY,
    webhook_id VARCHAR(255) UNIQUE NOT NULL,
    event_type VARCHAR(100) NOT NULL,
    status VARCHAR(50) DEFAULT 'pending',
    processing_id UUID,
    raw_payload JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    processed_at TIMESTAMP
);

CREATE TABLE webhook_dead_letter_queue (
    id SERIAL PRIMARY KEY,
    webhook_id VARCHAR(255) NOT NULL,
    event_type VARCHAR(100) NOT NULL,
    error_message TEXT,
    retry_count INTEGER DEFAULT 0,
    raw_payload JSONB NOT NULL,
    processing_id UUID,
    failed_at TIMESTAMP DEFAULT NOW(),
    next_retry_at TIMESTAMP
);
```

### **1.2 Configurar Vari√°veis de Ambiente** ‚è±Ô∏è 10 min

#### **Adicionar no arquivo `.env`:**
```bash
# ===== CONFIGURA√á√ÉO CAKTO =====
CAKTO_API_KEY=sua_api_key_aqui
CAKTO_SECRET_KEY=sua_secret_key_aqui
CAKTO_WEBHOOK_SECRET=sua_webhook_secret_aqui
CAKTO_API_URL=https://api.cakto.com

# IDs dos produtos (configurar ap√≥s criar na CAKTO)
CAKTO_PRODUCT_MENSAL=produto_mensal_id
CAKTO_PRODUCT_SEMESTRAL=produto_semestral_id
CAKTO_PRODUCT_ANUAL=produto_anual_id

# URLs de callback
CAKTO_SUCCESS_URL=https://app.editaliza.com.br/dashboard?payment=success
CAKTO_CANCEL_URL=https://app.editaliza.com.br/plans?payment=cancelled
CAKTO_WEBHOOK_URL=https://app.editaliza.com.br/api/webhooks/cakto
```

### **1.3 Ativar Integra√ß√£o no C√≥digo** ‚è±Ô∏è 5 min

#### **Editar `server.js`** (linha 43):
```javascript
// ANTES (linha 43):
// CACKTO INTEGRATION DISABLED - Causing database errors

// DEPOIS (descomentar as linhas 46-54):
// Importar integra√ß√£o CACKTO
const { 
    CacktoRoutes,
    initialize: initializeCackto,
    checkCacktoSubscription,
    requirePremiumFeature,
    addSubscriptionInfo
} = require('./src/cackto-integration');
```

#### **Descomentar bloco de inicializa√ß√£o** (linhas 484-503):
```javascript
// Inicializar integra√ß√£o CACKTO
(async () => {
    try {
        const result = await initializeCackto({
            enableCache: true,
            enableMetrics: true,
            enableCircuitBreaker: true
        });
        console.log('‚úÖ CACKTO integra√ß√£o inicializada:', result);
    } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o CACKTO:', error.message);
    }
})();
```

### **1.4 Verificar Integra√ß√£o Local** ‚è±Ô∏è 15 min

```bash
# 1. Instalar depend√™ncias (se necess√°rio)
npm install

# 2. Testar conex√£o com banco
npm run db:test-connection

# 3. Iniciar servidor em modo desenvolvimento
npm run dev

# 4. Testar endpoint de webhook
curl -X POST http://localhost:3000/api/webhooks/cakto/health
```

---

## **FASE 2: CONFIGURA√á√ÉO NA CAKTO (1 hora)**

### **2.1 Criar Conta CAKTO** ‚è±Ô∏è 15 min
1. Acessar https://www.cakto.com.br
2. Criar conta business/empresa
3. Completar verifica√ß√£o KYC
4. Obter credenciais de API

### **2.2 Configurar Produtos** ‚è±Ô∏è 20 min

#### **Criar produtos na plataforma CAKTO:**

**Produto 1: Editaliza Premium Mensal**
- Nome: "Editaliza Premium - Mensal"
- Pre√ßo: R$ 29,90/m√™s
- Descri√ß√£o: "Acesso completo √†s funcionalidades premium"
- ID: Copiar para CAKTO_PRODUCT_MENSAL

**Produto 2: Editaliza Premium Semestral**
- Nome: "Editaliza Premium - Semestral"
- Pre√ßo: R$ 149,90/6 meses (50% desconto)
- Descri√ß√£o: "6 meses de acesso premium com desconto"
- ID: Copiar para CAKTO_PRODUCT_SEMESTRAL

**Produto 3: Editaliza Premium Anual**
- Nome: "Editaliza Premium - Anual"
- Pre√ßo: R$ 239,90/ano (67% desconto)
- Descri√ß√£o: "1 ano completo de acesso premium"
- ID: Copiar para CAKTO_PRODUCT_ANUAL

### **2.3 Configurar Webhooks** ‚è±Ô∏è 15 min

#### **Na dashboard da CAKTO:**
1. Acessar se√ß√£o "Desenvolvedor" > "Webhooks"
2. Adicionar novo webhook:
   - **URL**: `https://app.editaliza.com.br/api/webhooks/cakto`
   - **Eventos**: Selecionar todos:
     - ‚úÖ payment.approved
     - ‚úÖ payment.rejected  
     - ‚úÖ payment.cancelled
     - ‚úÖ payment.refunded
     - ‚úÖ subscription.created
     - ‚úÖ subscription.activated
     - ‚úÖ subscription.suspended
     - ‚úÖ subscription.cancelled
     - ‚úÖ subscription.renewed
     - ‚úÖ subscription.expired
     - ‚úÖ chargeback.created
     - ‚úÖ chargeback.resolved

### **2.4 Copiar Credenciais** ‚è±Ô∏è 10 min

#### **Obter da dashboard CAKTO:**
- **API Key**: Para CAKTO_API_KEY
- **Secret Key**: Para CAKTO_SECRET_KEY  
- **Webhook Secret**: Para CAKTO_WEBHOOK_SECRET
- **Product IDs**: Para CAKTO_PRODUCT_*

#### **Atualizar arquivo `.env` com valores reais**

---

## **FASE 3: DEPLOY E TESTES (1-2 horas)**

### **3.1 Deploy para Produ√ß√£o** ‚è±Ô∏è 30 min

```bash
# 1. Commit das mudan√ßas
git add .
git commit -m "feat: ativar integra√ß√£o CAKTO para monetiza√ß√£o"

# 2. Push para reposit√≥rio
git push origin main

# 3. Deploy para DigitalOcean
ssh editaliza "cd /root/editaliza && git pull origin main"
ssh editaliza "cd /root/editaliza && npm install --production"

# 4. Executar migra√ß√£o em produ√ß√£o
ssh editaliza "cd /root/editaliza && node src/cackto-integration/scripts/migrate-to-cackto.js"

# 5. Restart da aplica√ß√£o
ssh editaliza "pm2 restart editaliza-app"

# 6. Verificar logs
ssh editaliza "pm2 logs editaliza-app --lines 50"
```

### **3.2 Testes de Integra√ß√£o** ‚è±Ô∏è 45 min

#### **3.2.1 Teste de Health Check** ‚è±Ô∏è 5 min
```bash
curl https://app.editaliza.com.br/api/webhooks/cakto/health
# Esperado: {"status": "healthy", "timestamp": "..."}
```

#### **3.2.2 Teste de Webhook** ‚è±Ô∏è 15 min
```bash
# Simular webhook de pagamento aprovado
curl -X POST https://app.editaliza.com.br/api/webhooks/cakto \
  -H "Content-Type: application/json" \
  -H "X-Cakto-Signature: [assinatura_calculada]" \
  -d '{
    "event": "payment.approved",
    "data": {
      "id": "test_123",
      "amount": 29.90,
      "customer": {
        "email": "test@editaliza.com.br",
        "name": "Usu√°rio Teste"
      },
      "product": {
        "id": "produto_mensal_id"
      }
    }
  }'
```

#### **3.2.3 Teste de Fluxo Completo** ‚è±Ô∏è 25 min

**Cen√°rio 1: Novo usu√°rio comprando**
1. Acessar site como visitante
2. Clicar em "Assinar Premium"
3. Escolher plano mensal
4. Redirecionar para CAKTO
5. Simular pagamento
6. Verificar recebimento de webhook
7. Confirmar cria√ß√£o de usu√°rio
8. Verificar email de boas-vindas
9. Login e acesso √†s funcionalidades premium

**Cen√°rio 2: Usu√°rio existente upgradando**
1. Login com usu√°rio gratuito
2. Tentar acessar funcionalidade premium
3. Ver tela de upgrade
4. Processar pagamento
5. Verificar ativa√ß√£o imediata

### **3.3 Monitoramento P√≥s-Deploy** ‚è±Ô∏è 15 min

#### **Verificar m√©tricas:**
```bash
# 1. Status da aplica√ß√£o
curl https://app.editaliza.com.br/health

# 2. Logs de webhook
ssh editaliza "tail -f /root/editaliza/logs/webhooks.log"

# 3. M√©tricas de integra√ß√£o
curl https://app.editaliza.com.br/api/webhooks/cakto/stats

# 4. Database health
ssh editaliza "cd /root/editaliza && npm run db:health"
```

---

## **FASE 4: LAN√áAMENTO E OTIMIZA√á√ÉO (Cont√≠nua)**

### **4.1 Soft Launch** üìÖ Primeira semana
- Ativar para 10% dos usu√°rios
- Monitorar m√©tricas de convers√£o
- Ajustar pre√ßos se necess√°rio
- Coletar feedback

### **4.2 Marketing Launch** üìÖ Segunda semana  
- Campanha de email marketing
- Posts em redes sociais
- Influenciadores educacionais
- Content marketing

### **4.3 Otimiza√ß√£o Cont√≠nua** üìÖ Ongoing
- A/B test de pre√ßos
- An√°lise de churn
- Melhorias no onboarding
- Novos planos e features

---

## üîß **TROUBLESHOOTING**

### **Problemas Comuns e Solu√ß√µes**

#### **‚ùå Erro: "tabela integration_metrics n√£o existe"**
```bash
# Solu√ß√£o: executar migra√ß√£o
node src/cackto-integration/scripts/migrate-to-cackto.js
```

#### **‚ùå Webhook retorna 401 Unauthorized**
```bash
# Solu√ß√£o: verificar CAKTO_WEBHOOK_SECRET
# Conferir se secret est√° correto no .env
```

#### **‚ùå Usu√°rio n√£o criado ap√≥s pagamento**
```bash
# Solu√ß√£o: verificar logs
ssh editaliza "tail -f /root/editaliza/logs/error.log"
# Verificar mapeamento de produtos
```

#### **‚ùå Email n√£o enviado**
```bash
# Solu√ß√£o: testar email service
node -e "
  const email = require('./src/services/emailService');
  email.sendWelcomeEmail('test@test.com', 'Test User');
"
```

---

## üìä **M√âTRICAS DE SUCESSO**

### **KPIs para Acompanhar**

#### **T√©cnicos**
- ‚úÖ Webhook success rate > 99%
- ‚úÖ Response time < 200ms
- ‚úÖ Error rate < 0.1%
- ‚úÖ Uptime > 99.9%

#### **Business**
- üí∞ Monthly Recurring Revenue (MRR)
- üìà Conversion rate (free ‚Üí premium)
- ‚è±Ô∏è Time to activation
- üîÑ Churn rate
- üë• Customer Lifetime Value (CLV)

#### **User Experience**
- üòä Payment completion rate
- ‚ö° Onboarding completion
- üìß Email open rates
- üéØ Feature adoption

---

## üöÄ **CRONOGRAMA SUGERIDO**

### **Semana 1: Implementa√ß√£o**
- **Dia 1**: Fase 1 (Prepara√ß√£o do ambiente)
- **Dia 2**: Fase 2 (Configura√ß√£o CAKTO)
- **Dia 3**: Fase 3 (Deploy e testes)
- **Dia 4-5**: Ajustes e otimiza√ß√µes
- **Weekend**: Soft launch para beta testers

### **Semana 2: Lan√ßamento**
- **Dia 8-10**: Marketing campaigns
- **Dia 11-12**: Monitor e adjust
- **Dia 13-14**: Full public launch

### **Semana 3+: Otimiza√ß√£o**
- An√°lise de m√©tricas
- A/B testing
- Feature improvements
- Scale optimization

---

## ‚úÖ **CHECKLIST FINAL**

### **Pr√©-Lan√ßamento**
- [ ] Migra√ß√£o de banco executada
- [ ] Vari√°veis de ambiente configuradas
- [ ] C√≥digo descomentado e testado
- [ ] Produtos criados na CAKTO
- [ ] Webhooks configurados
- [ ] Deploy em produ√ß√£o realizado
- [ ] Testes de integra√ß√£o aprovados
- [ ] Monitoramento ativo
- [ ] Backup de seguran√ßa criado

### **P√≥s-Lan√ßamento**
- [ ] Primeira venda testada
- [ ] Email autom√°tico funcionando
- [ ] Dashboard de m√©tricas acompanhado
- [ ] Feedback de usu√°rios coletado
- [ ] Performance monitorada
- [ ] Planos de marketing ativados

---

## üéØ **PR√ìXIMOS PASSOS RECOMENDADOS**

1. **üìÖ IMEDIATO** (Pr√≥ximas 48h): Executar Fases 1-3
2. **üìà CURTO PRAZO** (2 semanas): Soft launch e otimiza√ß√£o  
3. **üöÄ M√âDIO PRAZO** (1 m√™s): Full launch e scaling
4. **üí° LONGO PRAZO** (3+ meses): Novos produtos e features

---

**üèÜ RESULTADO ESPERADO**: 

Em **3-4 horas de trabalho**, o Editaliza estar√° **100% monetizado** e pronto para gerar receita recorrente atrav√©s de assinaturas premium, com um sistema robusto, seguro e escal√°vel de pagamentos integrado com CAKTO.

O fluxo ser√°: **Cliente paga ‚Üí CAKTO processa ‚Üí Webhook disparado ‚Üí Sistema recebe ‚Üí Conta criada ‚Üí Email enviado ‚Üí Cliente acessa** - exatamente como solicitado!

---

*Plano criado em: 21 de agosto de 2025*  
*Complexidade: BAIXA | Tempo: 3-4 horas | ROI: IMEDIATO*