    <!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Editaliza</title>
    <!-- Favicon and Web App Icons - Enhanced for better browser compatibility -->
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png?v=4">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png?v=4">
    <link rel="icon" type="image/png" sizes="48x48" href="favicon-48x48.png?v=4">
    <link rel="shortcut icon" href="favicon.ico?v=4">
    <link rel="icon" type="image/x-icon" href="favicon.ico?v=4">
    <link rel="icon" type="image/svg+xml" href="favicon.svg?v=4">
    <meta name="theme-color" content="#0528f2">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/footer.css" rel="stylesheet">
    <!-- SCRIPTS CENTRALIZADOS -->
    <script src="js/app.js"></script>
    <script src="js/components.js"></script>
    <script src="js/modules/gamification.js"></script>
    <!-- Config do Tailwind para reconhecer as cores customizadas -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'editaliza-blue': '#0528f2',
                        'editaliza-green': '#1ad937',
                        'editaliza-black': '#0d0d0d',
                        'editaliza-gray': '#969696',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #0528f2;
            box-shadow: 0 0 0 3px rgba(5, 40, 242, 0.1);
        }
        
        .form-input:disabled, .form-input[readonly] {
            background-color: #f8fafc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: white;
            color: #6b7280;
            border: 2px solid #e5e7eb;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            color: #374151;
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        
        .metric-card {
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .plan-card {
            transition: all 0.3s ease;
        }
        
        .plan-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 640px) {
            .grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Social Sharing Enhancements */
        .share-preview-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .share-preview-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .share-template-option {
            transition: all 0.2s ease;
        }
        
        .share-template-option:hover {
            background-color: #f3f4f6;
            transform: translateX(4px);
        }
        
        .share-template-option input:checked + div {
            background-color: #eff6ff;
            border-left: 4px solid #0528f2;
            padding-left: 16px;
        }
        
        .share-button {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .share-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .share-button:active {
            transform: translateY(0);
        }
        
        .share-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .share-button:active::after {
            width: 200px;
            height: 200px;
        }
        
        /* Viral challenge section animation */
        .challenge-section {
            background: linear-gradient(45deg, #fef3c7, #fbbf24);
            border: 2px solid #f59e0b;
            animation: pulse-yellow 2s infinite;
        }
        
        @keyframes pulse-yellow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .share-preview-card {
                padding: 1rem;
            }
            
            .share-stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
            
            .share-button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">
    <!-- Container de Toast para Notifica√ß√µes -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3"></div>

    <!-- NAVEGA√á√ÉO PRINCIPAL -->
    <div id="main-nav-container"></div>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Profile Header -->
        <div class="content-card mb-8">
            <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
                <!-- Profile Avatar -->
                <div class="flex-shrink-0">
                    <div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                        <img id="profilePhoto" src="" alt="Foto do perfil" class="w-full h-full object-cover rounded-full hidden">
                        <svg id="defaultAvatar" class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- Profile Info -->
                <div class="flex-grow text-center md:text-left">
                    <h1 class="text-3xl font-bold text-editaliza-black mb-2">Ol√°, <span id="profileNameDisplay">Concurseiro(a)</span>! üëã</h1>
                    <p class="text-editaliza-gray mb-4">Seu perfil pessoal - gerencie suas informa√ß√µes, prefer√™ncias e conquistas globais</p>
                    
                    <!-- Quick Stats -->
                    <div class="flex flex-wrap gap-4 justify-center md:justify-start">
                        <div class="bg-blue-50 px-3 py-1 rounded-lg border border-blue-200">
                            <span class="text-sm font-medium text-blue-800" id="currentLevelDisplay">Carregando n√≠vel...</span>
                        </div>
                        <div class="bg-green-50 px-3 py-1 rounded-lg border border-green-200">
                            <span class="text-sm font-medium text-green-800" id="studyStreakDisplay">üî• 0 dias</span>
                        </div>
                        <div class="bg-purple-50 px-3 py-1 rounded-lg border border-purple-200">
                            <span class="text-sm font-medium text-purple-800" id="totalXpDisplay">‚ú® 0 XP</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Page Purpose Indicator -->
            <div class="mt-6 pt-4 border-t border-gray-200">
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg border border-blue-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">üè† Voc√™ est√° no seu Perfil</h3>
                            <p class="text-sm text-gray-600">Gerencie informa√ß√µes pessoais, prefer√™ncias e veja estat√≠sticas globais</p>
                        </div>
                        <div class="text-right">
                            <a href="dashboard.html" class="inline-flex items-center px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-lg text-sm font-medium transition-colors">
                                üìä Ver Planos de Estudo
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Achievements Overview -->
        <div id="global-achievements-overview" class="mb-8">
            <!-- Global achievements will be rendered here -->
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Study Overview & Goals -->
            <div class="space-y-6">
                <!-- Global Study Overview -->
                <div class="content-card">
                    <h2 class="text-2xl font-semibold mb-6 text-editaliza-black flex items-center">
                        <span class="text-2xl mr-3">üåü</span>Sua Jornada de Estudos
                    </h2>
                    
                    <!-- Global Study Metrics -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <!-- Total Plans -->
                        <div class="metric-card bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-blue-700">Planos Criados</span>
                                <span class="text-2xl">üìã</span>
                            </div>
                            <p id="totalPlansCount" class="font-bold text-blue-900">0</p>
                            <p class="text-xs text-blue-600 mt-1">total de planos</p>
                        </div>
                        
                        <!-- Global Study Time -->
                        <div class="metric-card bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-xl border border-green-200">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-green-700">Tempo Total</span>
                                <span class="text-2xl">‚è±Ô∏è</span>
                            </div>
                            <p id="globalStudyTime" class="font-bold text-green-900">0h</p>
                            <p class="text-xs text-green-600 mt-1">tempo de estudo</p>
                        </div>
                        
                        <!-- Global Topics Completed -->
                        <div class="metric-card bg-gradient-to-br from-purple-50 to-violet-50 p-4 rounded-xl border border-purple-200">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-purple-700">T√≥picos Estudados</span>
                                <span class="text-2xl">üìö</span>
                            </div>
                            <p id="globalTopicsCount" class="font-bold text-purple-900">0</p>
                            <p class="text-xs text-purple-600 mt-1">em todos os planos</p>
                        </div>
                        
                        <!-- Study Streak -->
                        <div class="metric-card bg-gradient-to-br from-orange-50 to-amber-50 p-4 rounded-xl border border-orange-200">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-orange-700">Sequ√™ncia Atual</span>
                                <span class="text-2xl">üî•</span>
                            </div>
                            <p id="streakDays" class="font-bold text-orange-900">0 dias</p>
                            <p class="text-xs text-orange-600 mt-1">Mantenha o foco!</p>
                        </div>
                    </div>
                    
                    <!-- Quick Access to Plans -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200">
                        <h3 class="text-lg font-semibold text-blue-800 mb-3 flex items-center">
                            <span class="text-xl mr-2">üéØ</span>Seus Planos de Estudo
                        </h3>
                        <div id="userPlansList" class="space-y-2">
                            <!-- Plans list will be generated by JS -->
                        </div>
                        <div class="mt-4 pt-4 border-t border-blue-200">
                            <a href="dashboard.html" class="inline-flex items-center text-blue-700 hover:text-blue-900 font-medium text-sm">
                                <span class="mr-2">‚ûï</span>Criar Novo Plano
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Study Preferences -->
                <div class="content-card">
                    <h2 class="text-2xl font-semibold mb-6 text-editaliza-black flex items-center">
                        <span class="text-2xl mr-3">‚öôÔ∏è</span>Prefer√™ncias de Estudo
                    </h2>
                    
                    <form id="preferencesForm" class="space-y-6">

                        <!-- Study Goals -->
                        <div class="space-y-4">
                            <div>
                                <label for="areaInterest" class="block text-sm font-semibold text-gray-700 mb-2">√Årea de Interesse Principal</label>
                                <select id="areaInterest" name="areaInterest" class="form-input">
                                    <option value="">Selecione uma √°rea</option>
                                    <option value="administrativo">√Årea Administrativa</option>
                                    <option value="fiscal">√Årea Fiscal</option>
                                    <option value="policial">√Årea Policial</option>
                                    <option value="juridica">√Årea Jur√≠dica</option>
                                    <option value="saude">√Årea da Sa√∫de</option>
                                    <option value="educacao">√Årea da Educa√ß√£o</option>
                                    <option value="engenharia">Engenharia</option>
                                    <option value="ti">Tecnologia da Informa√ß√£o</option>
                                    <option value="bancaria">√Årea Banc√°ria</option>
                                    <option value="legislativo">Poder Legislativo</option>
                                    <option value="judiciario">Poder Judici√°rio</option>
                                    <option value="outros">Outras √°reas</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="studyHours" class="block text-sm font-semibold text-gray-700 mb-2">Horas por dia dispon√≠veis</label>
                                    <select id="studyHours" name="studyHours" class="form-input">
                                        <option value="">Selecione</option>
                                        <option value="1-2">1 a 2 horas</option>
                                        <option value="3-4">3 a 4 horas</option>
                                        <option value="5-6">5 a 6 horas</option>
                                        <option value="7-8">7 a 8 horas</option>
                                        <option value="8+">Mais de 8 horas</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="timelineGoal" class="block text-sm font-semibold text-gray-700 mb-2">Meta de aprova√ß√£o</label>
                                    <select id="timelineGoal" name="timelineGoal" class="form-input">
                                        <option value="">Selecione</option>
                                        <option value="6-meses">At√© 6 meses</option>
                                        <option value="1-ano">At√© 1 ano</option>
                                        <option value="2-anos">At√© 2 anos</option>
                                        <option value="3-anos">At√© 3 anos</option>
                                        <option value="sem-pressa">Sem pressa definida</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notification Preferences -->
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-xl mr-2">üîî</span>Notifica√ß√µes
                            </h3>
                            
                            <div class="space-y-3">
                                <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <span class="font-medium text-gray-700">Lembretes de estudo</span>
                                        <p class="text-sm text-gray-500">Receba lembretes quando √© hora de estudar</p>
                                    </div>
                                    <input type="checkbox" id="notifyStudy" class="form-checkbox text-editaliza-blue">
                                </label>
                                
                                <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <span class="font-medium text-gray-700">Conquistas e marcos</span>
                                        <p class="text-sm text-gray-500">Seja notificado sobre suas conquistas</p>
                                    </div>
                                    <input type="checkbox" id="notifyAchievements" class="form-checkbox text-editaliza-blue">
                                </label>
                                
                                <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <span class="font-medium text-gray-700">Novos concursos</span>
                                        <p class="text-sm text-gray-500">Alertas sobre editais na sua √°rea de interesse</p>
                                    </div>
                                    <input type="checkbox" id="notifyConcursos" class="form-checkbox text-editaliza-blue">
                                </label>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Personal Information -->
                <div class="content-card">
                    <h2 class="text-2xl font-semibold mb-6 text-editaliza-black flex items-center">
                        <span class="text-2xl mr-3">üë§</span>Informa√ß√µes Pessoais
                    </h2>
                    
                    <form id="profileForm" class="space-y-4">
                        <div>
                            <label for="name" class="block text-sm font-semibold text-gray-700 mb-2">Nome Completo</label>
                            <input type="text" id="name" name="name" class="form-input" placeholder="Digite seu nome completo">
                        </div>
                        
                        <div>
                            <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">E-mail</label>
                            <input type="email" id="email" name="email" class="form-input bg-gray-50" readonly>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="state" class="block text-sm font-semibold text-gray-700 mb-2">Estado</label>
                                <select id="state" name="state" class="form-input">
                                    <option value="">Selecione</option>
                                    <option value="AC">Acre (AC)</option>
                                    <option value="AL">Alagoas (AL)</option>
                                    <option value="AP">Amap√° (AP)</option>
                                    <option value="AM">Amazonas (AM)</option>
                                    <option value="BA">Bahia (BA)</option>
                                    <option value="CE">Cear√° (CE)</option>
                                    <option value="DF">Distrito Federal (DF)</option>
                                    <option value="ES">Esp√≠rito Santo (ES)</option>
                                    <option value="GO">Goi√°s (GO)</option>
                                    <option value="MA">Maranh√£o (MA)</option>
                                    <option value="MT">Mato Grosso (MT)</option>
                                    <option value="MS">Mato Grosso do Sul (MS)</option>
                                    <option value="MG">Minas Gerais (MG)</option>
                                    <option value="PA">Par√° (PA)</option>
                                    <option value="PB">Para√≠ba (PB)</option>
                                    <option value="PR">Paran√° (PR)</option>
                                    <option value="PE">Pernambuco (PE)</option>
                                    <option value="PI">Piau√≠ (PI)</option>
                                    <option value="RJ">Rio de Janeiro (RJ)</option>
                                    <option value="RN">Rio Grande do Norte (RN)</option>
                                    <option value="RS">Rio Grande do Sul (RS)</option>
                                    <option value="RO">Rond√¥nia (RO)</option>
                                    <option value="RR">Roraima (RR)</option>
                                    <option value="SC">Santa Catarina (SC)</option>
                                    <option value="SP">S√£o Paulo (SP)</option>
                                    <option value="SE">Sergipe (SE)</option>
                                    <option value="TO">Tocantins (TO)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="education" class="block text-sm font-semibold text-gray-700 mb-2">Escolaridade</label>
                                <select id="education" name="education" class="form-input">
                                    <option value="">Selecione</option>
                                    <option value="fundamental">Ensino Fundamental</option>
                                    <option value="medio">Ensino M√©dio</option>
                                    <option value="tecnico">T√©cnico</option>
                                    <option value="superior-incompleto">Superior Incompleto</option>
                                    <option value="superior-completo">Superior Completo</option>
                                    <option value="pos-graduacao">P√≥s-gradua√ß√£o</option>
                                    <option value="mestrado">Mestrado</option>
                                    <option value="doutorado">Doutorado</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Right Column: Achievements & Progress -->
            <div class="space-y-6">
                <!-- Recent Achievements -->
                <div class="content-card">
                    <h2 class="text-2xl font-semibold mb-6 text-editaliza-black flex items-center">
                        <span class="text-2xl mr-3">üèÜ</span>Suas Conquistas
                    </h2>
                    
                    <div id="recentAchievements" class="grid grid-cols-2 gap-4 mb-4">
                        <!-- Achievements will be rendered here -->
                        <div class="bg-gray-50 p-4 rounded-lg text-center">
                            <div class="text-2xl mb-2">üåü</div>
                            <p class="text-sm text-gray-600">Carregando suas conquistas...</p>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button id="viewAllAchievements" class="text-editaliza-blue hover:text-editaliza-blue font-medium text-sm">
                            Ver todas as conquistas ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Progress Tracking -->
                <div class="content-card">
                    <h2 class="text-2xl font-semibold mb-6 text-editaliza-black flex items-center">
                        <span class="text-2xl mr-3">üìà</span>Seu Progresso
                    </h2>
                    
                    <!-- Level Progress -->
                    <div class="bg-gradient-to-r from-orange-50 to-yellow-50 p-4 rounded-xl border border-orange-200 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="font-semibold text-orange-800" id="currentLevelName">Carregando n√≠vel...</h3>
                                <p class="text-sm text-orange-600" id="levelProgress">Progresso para pr√≥ximo n√≠vel</p>
                            </div>
                            <div class="text-3xl" id="levelIcon">üå±</div>
                        </div>
                        
                        <div class="w-full bg-orange-200 rounded-full h-3 mb-2">
                            <div id="levelProgressBar" class="bg-gradient-to-r from-orange-500 to-yellow-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        
                        <p class="text-xs text-orange-600" id="levelProgressText">0 t√≥picos restantes</p>
                    </div>
                    
                    <!-- Study Stats -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <span class="text-sm font-medium text-blue-700">Total de sess√µes</span>
                            <span class="font-bold text-blue-900" id="totalSessions">0</span>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <span class="text-sm font-medium text-green-700">T√≥picos conclu√≠dos</span>
                            <span class="font-bold text-green-900" id="completedTopics">0</span>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                            <span class="text-sm font-medium text-purple-700">Tempo total de estudo</span>
                            <span class="font-bold text-purple-900" id="totalStudyTime">0h</span>
                        </div>
                    </div>
                </div>
                
                <!-- Social Sharing Section -->
                <div class="content-card">
                    <h2 class="text-2xl font-semibold mb-6 text-editaliza-black flex items-center">
                        <span class="text-2xl mr-3">üöÄ</span>Compartilhe Suas Conquistas
                    </h2>
                    
                    <!-- Sharing Preview Card -->
                    <div id="sharePreviewCard" class="share-preview-card bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200 rounded-xl p-6 mb-6 relative overflow-hidden">
                        <!-- Editaliza Branding -->
                        <div class="absolute top-4 right-4 opacity-20">
                            <div class="text-2xl font-bold text-editaliza-blue">Editaliza</div>
                        </div>
                        
                        <!-- Main Achievement Display -->
                        <div class="text-center mb-6">
                            <div id="shareMainIcon" class="text-6xl mb-4">üèÜ</div>
                            <h3 id="shareMainTitle" class="text-2xl font-bold text-gray-800 mb-2">Carregando conquistas...</h3>
                            <p id="shareMainDescription" class="text-gray-600 mb-4">Prepare-se para compartilhar seu progresso!</p>
                            
                            <!-- Key Stats Display -->
                            <div class="share-stats-grid grid grid-cols-2 gap-4 max-w-md mx-auto">
                                <div class="bg-white/70 rounded-lg p-3">
                                    <div class="text-xl font-bold text-editaliza-blue" id="shareStatsLevel">N√≠vel 1</div>
                                    <div class="text-xs text-gray-600">N√≠vel Atual</div>
                                </div>
                                <div class="bg-white/70 rounded-lg p-3">
                                    <div class="text-xl font-bold text-green-600" id="shareStatsStreak">0 dias</div>
                                    <div class="text-xs text-gray-600">Sequ√™ncia</div>
                                </div>
                                <div class="bg-white/70 rounded-lg p-3">
                                    <div class="text-xl font-bold text-purple-600" id="shareStatsXP">0 XP</div>
                                    <div class="text-xs text-gray-600">Experi√™ncia</div>
                                </div>
                                <div class="bg-white/70 rounded-lg p-3">
                                    <div class="text-xl font-bold text-orange-600" id="shareStatsTime">0h</div>
                                    <div class="text-xs text-gray-600">Tempo Total</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Call to Action -->
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-2">üéØ <strong>Conquiste seu futuro no servi√ßo p√∫blico!</strong></p>
                            <p class="text-xs text-editaliza-blue font-medium">üíª Junte-se a mim no editaliza.com.br | @editaliza</p>
                        </div>
                    </div>
                    
                    <!-- Share Template Selector -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Escolha o que compartilhar:</label>
                        <div class="space-y-2">
                            <label class="share-template-option flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors">
                                <input type="radio" name="shareTemplate" value="achievement" class="mr-3 text-editaliza-blue" checked>
                                <div class="flex-grow">
                                    <span class="font-medium text-gray-700">üèÜ Conquista Mais Recente</span>
                                    <p class="text-sm text-gray-500">Sua achievement mais impressionante</p>
                                </div>
                            </label>
                            
                            <label class="share-template-option flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors">
                                <input type="radio" name="shareTemplate" value="streak" class="mr-3 text-editaliza-blue">
                                <div class="flex-grow">
                                    <span class="font-medium text-gray-700">üî• Sequ√™ncia de Estudos</span>
                                    <p class="text-sm text-gray-500">Mostre sua disciplina e consist√™ncia</p>
                                </div>
                            </label>
                            
                            <label class="share-template-option flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors">
                                <input type="radio" name="shareTemplate" value="level" class="mr-3 text-editaliza-blue">
                                <div class="flex-grow">
                                    <span class="font-medium text-gray-700">‚≠ê N√≠vel e XP</span>
                                    <p class="text-sm text-gray-500">Destaque seu progresso e dedica√ß√£o</p>
                                </div>
                            </label>
                            
                            <label class="share-template-option flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors">
                                <input type="radio" name="shareTemplate" value="summary" class="mr-3 text-editaliza-blue">
                                <div class="flex-grow">
                                    <span class="font-medium text-gray-700">üìä Resumo Completo</span>
                                    <p class="text-sm text-gray-500">Todas as suas estat√≠sticas principais</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Share Buttons -->
                    <div class="space-y-3">
                        <button id="shareWhatsApp" class="share-button w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                            </svg>
                            <span>Compartilhar no WhatsApp</span>
                        </button>
                        
                        <button id="shareInstagram" class="share-button w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                            <span>Criar Card para Instagram</span>
                        </button>
                        
                        <button id="downloadShareCard" class="share-button w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <span>Baixar Card como Imagem</span>
                        </button>
                    </div>
                    
                    <!-- Viral Challenge Section -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2">üéØ</span>Desafie um Amigo
                        </h3>
                        <div class="challenge-section bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-sm text-yellow-800 mb-3">
                                <strong>üî• Desafio Editaliza:</strong> Convide um amigo para superarem juntos os estudos para concursos!
                            </p>
                            <button id="shareChallengeBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-colors">
                                Criar Desafio de Estudo
                            </button>
                        </div>
                    </div>
                    
                    <!-- Share Statistics -->
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between text-sm text-gray-600">
                            <span>üìà Compartilhamentos este m√™s:</span>
                            <span id="monthlyShares" class="font-semibold">0</span>
                        </div>
                    </div>
                </div>

                <!-- Account Actions -->
                <div class="content-card">
                    <h2 class="text-2xl font-semibold mb-6 text-editaliza-black flex items-center">
                        <span class="text-2xl mr-3">‚öôÔ∏è</span>Configura√ß√µes da Conta
                    </h2>
                    
                    <div class="space-y-3">
                        <button id="exportData" class="w-full btn-secondary">
                            <span class="text-xl mr-2">üìÅ</span>
                            Exportar Dados
                        </button>
                        
                        <button id="changePassword" class="w-full btn-secondary">
                            <span class="text-xl mr-2">üîí</span>
                            Alterar Senha
                        </button>
                        
                        <a href="dashboard.html" class="w-full btn-primary block text-center">
                            <span class="text-xl mr-2">üè†</span>
                            Ir para Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Save Button -->
        <div class="content-card mt-8">
            <div class="flex flex-col sm:flex-row gap-4">
                <button type="submit" id="saveBtn" form="profileForm" class="btn-primary flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Salvar Prefer√™ncias
                </button>
            </div>
        </div>
    </main>

    <script>
        let originalData = {};
        let globalUserData = null;

        async function initialize() {
            try {
                await components.renderMainNavigation('profile.html');
                await loadProfileData();
                await loadGlobalData();
                setupFormEvents();
                setupQuickActions();
                initializeSocialSharing();
                console.log('‚úÖ Nova p√°gina de perfil inicializada com sucesso!');
            } catch (error) {
                console.error("‚ùå Erro na inicializa√ß√£o da p√°gina de perfil:", error);
                app.showToast('Erro fatal ao carregar a p√°gina. Tente novamente.', 'error');
            }
        }

        async function loadProfileData() {
            try {
                console.log('üì• Carregando dados do perfil...');
                app.showSpinner();
                const profile = await app.apiFetch('/users/profile');
                console.log('üìã Dados do perfil recebidos:', profile);
                
                // Update profile display
                const displayName = profile.name || 'Concurseiro(a)';
                document.getElementById('profileNameDisplay').textContent = displayName;
                
                // Dados pessoais b√°sicos
                document.getElementById('name').value = profile.name || '';
                document.getElementById('email').value = profile.email || '';
                document.getElementById('state').value = profile.state || '';
                document.getElementById('education').value = profile.education || '';
                
                // Study preferences
                document.getElementById('areaInterest').value = profile.area_interest || '';
                document.getElementById('studyHours').value = profile.study_hours || '';
                document.getElementById('timelineGoal').value = profile.timeline_goal || '';
                
                // Notification preferences (default to true)
                document.getElementById('notifyStudy').checked = profile.notify_study !== false;
                document.getElementById('notifyAchievements').checked = profile.notify_achievements !== false;
                document.getElementById('notifyConcursos').checked = profile.notify_concursos !== false;
                
                // Avatar handling (simplified)
                let avatarPath = null;
                if (profile.google_avatar && profile.auth_provider === 'google') {
                    avatarPath = profile.google_avatar;
                } else if (profile.profile_picture) {
                    avatarPath = profile.profile_picture;
                }
                updateProfilePhoto(avatarPath);
                
                // Store original data
                originalData = {
                    name: profile.name || '',
                    state: profile.state || '',
                    education: profile.education || '',
                    area_interest: profile.area_interest || '',
                    study_hours: profile.study_hours || '',
                    timeline_goal: profile.timeline_goal || '',
                    notify_study: profile.notify_study !== false,
                    notify_achievements: profile.notify_achievements !== false,
                    notify_concursos: profile.notify_concursos !== false
                };
                
                console.log('üìù Dados do perfil carregados:', originalData);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do perfil:', error);
                app.showToast('Erro ao carregar dados do perfil.', 'error');
            } finally {
                app.hideSpinner();
            }
        }
        
        async function loadGlobalData() {
            try {
                // Load global user statistics across all plans
                const [plans, profile] = await Promise.all([
                    app.apiFetch('/plans'),
                    app.apiFetch('/users/profile')
                ]);
                
                // Calculate global statistics
                let globalStats = {
                    totalPlans: plans?.length || 0,
                    totalStudyTime: 0,
                    totalTopics: 0,
                    totalSessions: 0,
                    totalXP: 0,
                    highestLevel: 'Iniciante üå±',
                    globalAchievements: []
                };
                
                // Aggregate data from all plans
                if (plans && plans.length > 0) {
                    for (const plan of plans) {
                        try {
                            const planData = await window.app.getGamificationData(plan.id);
                            if (planData) {
                                globalStats.totalStudyTime += planData.totalStudyTime || 0;
                                globalStats.totalTopics += planData.completedTopicsCount || 0;
                                globalStats.totalSessions += planData.totalCompletedSessions || 0;
                                globalStats.totalXP += planData.experiencePoints || 0;
                                
                                // Collect achievements from all plans
                                if (planData.achievements) {
                                    globalStats.globalAchievements.push(...planData.achievements);
                                }
                            }
                        } catch (planError) {
                            console.warn(`Erro ao carregar dados do plano ${plan.id}:`, planError);
                        }
                    }
                    
                    // Get the highest level achieved
                    const activePlan = plans.find(p => p.is_active) || plans[0];
                    if (activePlan) {
                        const activePlanData = await window.app.getGamificationData(activePlan.id);
                        if (activePlanData?.concurseiroLevel) {
                            globalStats.highestLevel = activePlanData.concurseiroLevel;
                        }
                        
                        // Use streak from active plan
                        globalStats.studyStreak = activePlanData?.studyStreak || 0;
                    }
                }
                
                // Update header with global stats
                const levelIcon = globalStats.highestLevel.split(' ').pop() || 'üå±';
                const levelTitle = globalStats.highestLevel.replace(levelIcon, '').trim() || 'Iniciante';
                
                document.getElementById('currentLevelDisplay').textContent = levelTitle + ' ' + levelIcon;
                document.getElementById('studyStreakDisplay').textContent = `üî• ${globalStats.studyStreak || 0} dias`;
                document.getElementById('totalXpDisplay').textContent = `‚ú® ${globalStats.totalXP.toLocaleString()} XP`;
                
                // Update global metrics
                document.getElementById('totalPlansCount').textContent = globalStats.totalPlans;
                document.getElementById('globalStudyTime').textContent = formatStudyTime(globalStats.totalStudyTime);
                document.getElementById('globalTopicsCount').textContent = globalStats.totalTopics;
                document.getElementById('streakDays').textContent = `${globalStats.studyStreak || 0} dias`;
                
                // Render global achievements overview
                renderGlobalAchievementsOverview(globalStats);
                
                // Render user plans list
                renderUserPlansList(plans);
                
                // Render achievements
                renderAchievements(globalStats.globalAchievements);
                
                // Render progress stats
                renderProgressStats(globalStats);
                
                // Load sharing data
                loadSharingData(globalStats);
                
                // Store profile data for sharing
                globalSharingData.profile = profile;
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados globais:', error);
            }
        }
        
        function renderUserPlansList(plans) {
            const container = document.getElementById('userPlansList');
            if (!container) return;
            
            if (!plans || plans.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-blue-600 mb-2">Voc√™ ainda n√£o criou nenhum plano de estudos</p>
                        <a href="dashboard.html" class="text-blue-700 hover:text-blue-900 font-medium">
                            Criar seu primeiro plano ‚Üí
                        </a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = plans.map(plan => {
                const isActive = plan.is_active;
                const examDate = plan.exam_date ? new Date(plan.exam_date + 'T00:00:00').toLocaleDateString('pt-BR') : 'Data n√£o definida';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border ${
                        isActive ? 'border-blue-300 bg-blue-50' : 'border-gray-200'
                    }">
                        <div class="flex-grow">
                            <h4 class="font-semibold text-gray-800 flex items-center">
                                ${isActive ? '<span class="text-green-500 mr-2">‚óè</span>' : ''}
                                ${app.sanitizeHtml(plan.plan_name)}
                            </h4>
                            <p class="text-xs text-gray-600">Prova: ${examDate}</p>
                        </div>
                        <div class="flex gap-2">
                            <a href="plan.html?id=${plan.id}" 
                               class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors">
                                Ver Detalhes
                            </a>
                            <a href="cronograma.html?plan=${plan.id}" 
                               class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors">
                                Estudar
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderGlobalAchievementsOverview(globalStats) {
            const container = document.getElementById('global-achievements-overview');
            if (!container) return;
            
            // Remove duplicates from achievements (same achievement from different plans)
            const uniqueAchievements = globalStats.globalAchievements.reduce((acc, achievement) => {
                if (!acc.find(a => a.title === achievement.title)) {
                    acc.push(achievement);
                }
                return acc;
            }, []);
            
            container.innerHTML = `
                <div class="content-card">
                    <h2 class="text-2xl font-semibold mb-6 text-editaliza-black flex items-center">
                        <span class="text-2xl mr-3">üåü</span>Vis√£o Geral dos Seus Estudos
                    </h2>
                    
                    <!-- Global Stats Cards -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200 text-center">
                            <div class="text-2xl mb-2">üìö</div>
                            <div class="text-2xl font-bold text-blue-800">${globalStats.totalSessions}</div>
                            <div class="text-xs text-blue-600">Sess√µes Completadas</div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border border-green-200 text-center">
                            <div class="text-2xl mb-2">‚è±Ô∏è</div>
                            <div class="text-2xl font-bold text-green-800">${formatStudyTime(globalStats.totalStudyTime)}</div>
                            <div class="text-xs text-green-600">Tempo Total</div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border border-purple-200 text-center">
                            <div class="text-2xl mb-2">‚ú®</div>
                            <div class="text-2xl font-bold text-purple-800">${globalStats.totalXP.toLocaleString()}</div>
                            <div class="text-xs text-purple-600">XP Total</div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-xl border border-yellow-200 text-center">
                            <div class="text-2xl mb-2">üèÜ</div>
                            <div class="text-2xl font-bold text-yellow-800">${uniqueAchievements.length}</div>
                            <div class="text-xs text-yellow-600">Conquistas</div>
                        </div>
                    </div>
                    
                    <!-- Motivation Message -->
                    <div class="bg-gradient-to-r from-editaliza-blue/10 to-purple-100 p-4 rounded-xl border border-editaliza-blue/20">
                        <h3 class="text-lg font-semibold text-editaliza-blue mb-2 flex items-center">
                            <span class="mr-2">üí™</span>Continue Sua Jornada!
                        </h3>
                        <p class="text-editaliza-blue/80 text-sm">
                            Voc√™ j√° completou <strong>${globalStats.totalSessions} sess√µes</strong> de estudo e 
                            acumulou <strong>${globalStats.totalXP.toLocaleString()} XP</strong>. 
                            Cada sess√£o te aproxima mais dos seus objetivos!
                        </p>
                    </div>
                </div>
            `;
        }

        function updateProfilePhoto(path) {
            const profilePhoto = document.getElementById('profilePhoto');
            const defaultAvatar = document.getElementById('defaultAvatar');
            
            if (!profilePhoto || !defaultAvatar) {
                console.error('‚ùå Elementos de foto do perfil n√£o encontrados');
                return;
            }
            
            if (path) {
                if (path.startsWith('https://')) {
                    profilePhoto.src = path;
                } else {
                    const cacheBuster = '?t=' + new Date().getTime();
                    const finalPath = path.startsWith('./') ? path + cacheBuster : './' + path + cacheBuster;
                    profilePhoto.src = finalPath;
                }
                
                profilePhoto.addEventListener('load', () => {
                    profilePhoto.classList.remove('hidden');
                    defaultAvatar.classList.add('hidden');
                }, { once: true });
                
                profilePhoto.addEventListener('error', () => {
                    profilePhoto.classList.add('hidden');
                    defaultAvatar.classList.remove('hidden');
                }, { once: true });
            } else {
                profilePhoto.classList.add('hidden');
                defaultAvatar.classList.remove('hidden');
            }
        }
        
        function renderAchievements(achievements) {
            const container = document.getElementById('recentAchievements');
            if (!container || !achievements || achievements.length === 0) {
                container.innerHTML = `
                    <div class="col-span-2 bg-gray-50 p-4 rounded-lg text-center">
                        <div class="text-2xl mb-2">üéÜ</div>
                        <p class="text-sm text-gray-600">Complete seus primeiros estudos para desbloquear conquistas!</p>
                    </div>
                `;
                return;
            }
            
            const recentAchievements = achievements.slice(0, 4);
            container.innerHTML = recentAchievements.map(achievement => {
                const achievementIcons = {
                    'Primeiro Estudo': 'üåü',
                    'Sequ√™ncia de 3 dias': 'üî•',
                    'Sequ√™ncia de 7 dias': 'üí™',
                    'Primeiro Simulado': 'üéØ',
                    '10 T√≥picos Conclu√≠dos': 'üìö',
                    '50 T√≥picos Conclu√≠dos': 'üèÜ',
                    'default': 'üèÖ'
                };
                
                const icon = achievementIcons[achievement.title] || achievementIcons.default;
                
                return `
                    <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-3 rounded-lg border border-yellow-200 text-center">
                        <div class="text-2xl mb-1">${icon}</div>
                        <p class="text-xs font-semibold text-yellow-800">${achievement.title}</p>
                        <p class="text-xs text-yellow-600 mt-1">${new Date(achievement.achieved_date).toLocaleDateString('pt-BR')}</p>
                    </div>
                `;
            }).join('');
        }
        
        function renderProgressStats(globalStats) {
            if (!globalStats) return;
            
            // Level progress
            const levelIcon = globalStats.highestLevel ? globalStats.highestLevel.split(' ').pop() : 'üå±';
            const levelTitle = globalStats.highestLevel ? globalStats.highestLevel.replace(levelIcon, '').trim() : 'Iniciante';
            
            document.getElementById('currentLevelName').textContent = levelTitle;
            document.getElementById('levelIcon').textContent = levelIcon;
            
            // Global study stats
            document.getElementById('totalSessions').textContent = globalStats.totalSessions || 0;
            document.getElementById('completedTopics').textContent = globalStats.totalTopics || 0;
            document.getElementById('totalStudyTime').textContent = formatStudyTime(globalStats.totalStudyTime || 0);
        }
        
        function formatStudyTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            
            if (hours > 0) {
                return `${hours}h${remainingMinutes > 0 ? ` ${remainingMinutes}min` : ''}`;
            }
            return `${minutes}min`;
        }
        
        function formatStudyTime(minutes) {
            if (!minutes || minutes === 0) return '0h';
            
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            
            if (hours > 0) {
                return `${hours}h${remainingMinutes > 0 ? ` ${remainingMinutes}min` : ''}`;
            }
            return `${minutes}min`;
        }

        function setupQuickActions() {
            // Export Data button
            document.getElementById('exportData')?.addEventListener('click', () => {
                app.showToast('Funcionalidade de exporta√ß√£o em desenvolvimento', 'info');
            });
            
            // Change Password button
            document.getElementById('changePassword')?.addEventListener('click', () => {
                app.showToast('Funcionalidade de altera√ß√£o de senha em desenvolvimento', 'info');
            });
            
            // View All Achievements button
            document.getElementById('viewAllAchievements')?.addEventListener('click', () => {
                // This could open a modal or navigate to achievements page
                if (gamificationData && gamificationData.achievements && gamificationData.achievements.length > 4) {
                    showAllAchievementsModal(gamificationData.achievements);
                } else {
                    app.showToast('Continue estudando para desbloquear mais conquistas!', 'info');
                }
            });
        }
        
        function showAllAchievementsModal(achievements) {
            // Simple modal implementation (you might want to use a more sophisticated modal system)
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">üèÜ Todas as Suas Conquistas</h2>
                            <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            ${achievements.map(achievement => {
                                const achievementIcons = {
                                    'Primeiro Estudo': 'üåü',
                                    'Sequ√™ncia de 3 dias': 'üî•',
                                    'Sequ√™ncia de 7 dias': 'üí™',
                                    'Primeiro Simulado': 'üéØ',
                                    '10 T√≥picos Conclu√≠dos': 'üìö',
                                    '50 T√≥picos Conclu√≠dos': 'üèÜ',
                                    'default': 'üèÖ'
                                };
                                
                                const icon = achievementIcons[achievement.title] || achievementIcons.default;
                                
                                return `
                                    <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-4 rounded-lg border border-yellow-200 text-center">
                                        <div class="text-3xl mb-2">${icon}</div>
                                        <p class="font-semibold text-yellow-800 text-sm mb-1">${achievement.title}</p>
                                        <p class="text-xs text-yellow-600 mb-2">${achievement.description}</p>
                                        <p class="text-xs text-yellow-500">${new Date(achievement.achieved_date).toLocaleDateString('pt-BR')}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelector('#closeModal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        function setupFormEvents() {
            const form = document.getElementById('profileForm');
            const preferencesForm = document.getElementById('preferencesForm');
            const saveBtn = document.getElementById('saveBtn');
            
            // Form fields to monitor
            const formFields = ['name', 'state', 'education', 'areaInterest', 'studyHours', 'timelineGoal'];
            const checkboxFields = ['notifyStudy', 'notifyAchievements', 'notifyConcursos'];
            
            function checkForChanges() {
                let hasChanges = false;
                
                // Check form fields
                formFields.forEach(fieldName => {
                    const element = document.getElementById(fieldName);
                    if (element) {
                        const currentValue = element.value.trim();
                        const originalKey = fieldName === 'areaInterest' ? 'area_interest' :
                                          fieldName === 'studyHours' ? 'study_hours' :
                                          fieldName === 'timelineGoal' ? 'timeline_goal' :
                                          fieldName;
                        const originalValue = originalData[originalKey] || '';
                        if (currentValue !== originalValue) {
                            hasChanges = true;
                        }
                    }
                });
                
                // Check checkbox fields
                checkboxFields.forEach(fieldName => {
                    const element = document.getElementById(fieldName);
                    if (element) {
                        const currentValue = element.checked;
                        const originalKey = fieldName === 'notifyStudy' ? 'notify_study' :
                                          fieldName === 'notifyAchievements' ? 'notify_achievements' :
                                          fieldName === 'notifyConcursos' ? 'notify_concursos' :
                                          fieldName;
                        const originalValue = originalData[originalKey] !== false;
                        if (currentValue !== originalValue) {
                            hasChanges = true;
                        }
                    }
                });
                
                saveBtn.disabled = !hasChanges;
            }
            
            // Add event listeners to all form fields
            [...formFields, ...checkboxFields].forEach(fieldName => {
                const element = document.getElementById(fieldName);
                if (element) {
                    element.addEventListener('input', checkForChanges);
                    element.addEventListener('change', checkForChanges);
                }
            });
            
            // Form submit
            const handleSubmit = async (e) => {
                e.preventDefault();
                await saveProfile();
            };
            
            if (form) form.addEventListener('submit', handleSubmit);
            if (preferencesForm) preferencesForm.addEventListener('submit', handleSubmit);
            
            // Initial check
            checkForChanges();
        }

        async function saveProfile() {
            const saveBtn = document.getElementById('saveBtn');
            
            const cleanValue = (value) => {
                if (typeof value === 'string') {
                    const cleaned = value.trim();
                    return cleaned === '' ? null : cleaned;
                }
                return value || null;
            };
            
            const updateData = {
                name: cleanValue(document.getElementById('name').value),
                state: cleanValue(document.getElementById('state').value),
                education: cleanValue(document.getElementById('education').value),
                area_interest: cleanValue(document.getElementById('areaInterest').value),
                study_hours: cleanValue(document.getElementById('studyHours').value),
                timeline_goal: cleanValue(document.getElementById('timelineGoal').value),
                notify_study: document.getElementById('notifyStudy').checked,
                notify_achievements: document.getElementById('notifyAchievements').checked,
                notify_concursos: document.getElementById('notifyConcursos').checked
            };
            
            // Remove null/undefined fields
            Object.keys(updateData).forEach(key => {
                if (updateData[key] === null || updateData[key] === undefined) {
                    delete updateData[key];
                }
            });

            saveBtn.disabled = true;
            saveBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Salvando...
            `;
            app.showSpinner();

            try {
                const response = await app.apiFetch('/users/profile', {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });
                
                // Update original data
                originalData = { ...originalData, ...updateData };
                
                // Update display name
                if (updateData.name) {
                    document.getElementById('profileNameDisplay').textContent = updateData.name;
                }
                
                // Update avatar in navigation if function exists
                if (typeof app.onUserAvatarUpdated === 'function') {
                    await app.onUserAvatarUpdated();
                }
                
                app.showToast('Prefer√™ncias salvas com sucesso! Sua experi√™ncia foi personalizada.', 'success');
                saveBtn.disabled = true;
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar perfil:', error);
                const errorMessage = error.message || 'Erro ao salvar prefer√™ncias. Tente novamente.';
                app.showToast(errorMessage, 'error');
                saveBtn.disabled = false;
            } finally {
                app.hideSpinner();
                saveBtn.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Salvar Prefer√™ncias
                `;
            }
        }

        // Canvas polyfills for better browser compatibility
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                this.beginPath();
                this.moveTo(x + radius, y);
                this.lineTo(x + width - radius, y);
                this.quadraticCurveTo(x + width, y, x + width, y + radius);
                this.lineTo(x + width, y + height - radius);
                this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                this.lineTo(x + radius, y + height);
                this.quadraticCurveTo(x, y + height, x, y + height - radius);
                this.lineTo(x, y + radius);
                this.quadraticCurveTo(x, y, x + radius, y);
                this.closePath();
            };
        }

        // Social Sharing System
        let globalSharingData = {
            achievements: [],
            stats: {},
            profile: {}
        };

        function initializeSocialSharing() {
            setupShareTemplateSelection();
            setupShareButtons();
            updateSharePreview('achievement');
        }

        function setupShareTemplateSelection() {
            const radioButtons = document.querySelectorAll('input[name="shareTemplate"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    updateSharePreview(e.target.value);
                });
            });
        }

        function updateSharePreview(template) {
            const iconEl = document.getElementById('shareMainIcon');
            const titleEl = document.getElementById('shareMainTitle');
            const descEl = document.getElementById('shareMainDescription');
            
            const levelEl = document.getElementById('shareStatsLevel');
            const streakEl = document.getElementById('shareStatsStreak');
            const xpEl = document.getElementById('shareStatsXP');
            const timeEl = document.getElementById('shareStatsTime');

            // Update stats display with current global data
            if (globalSharingData.stats) {
                const stats = globalSharingData.stats;
                levelEl.textContent = stats.currentLevel || 'N√≠vel 1';
                streakEl.textContent = `${stats.studyStreak || 0} dias`;
                xpEl.textContent = `${(stats.totalXP || 0).toLocaleString()} XP`;
                timeEl.textContent = formatStudyTime(stats.totalStudyTime || 0);
            }

            switch (template) {
                case 'achievement':
                    const latestAchievement = globalSharingData.achievements?.[0];
                    if (latestAchievement) {
                        iconEl.textContent = getAchievementIcon(latestAchievement.title);
                        titleEl.textContent = `üèÜ ${latestAchievement.title}`;
                        descEl.textContent = `Conquista desbloqueada: ${latestAchievement.description}`;
                    } else {
                        iconEl.textContent = 'üåü';
                        titleEl.textContent = 'Primeira Conquista Aguardando!';
                        descEl.textContent = 'Complete seus primeiros estudos para desbloquear achievements!';
                    }
                    break;

                case 'streak':
                    iconEl.textContent = 'üî•';
                    const streak = globalSharingData.stats?.studyStreak || 0;
                    titleEl.textContent = `Sequ√™ncia de ${streak} Dias!`;
                    if (streak > 0) {
                        descEl.textContent = `Disciplina e consist√™ncia em a√ß√£o! ${streak} dias seguidos estudando para meu futuro.`;
                    } else {
                        descEl.textContent = 'Pronto para come√ßar uma nova sequ√™ncia de estudos!';
                    }
                    break;

                case 'level':
                    const level = globalSharingData.stats?.currentLevel || 'Iniciante üå±';
                    const levelIcon = level.split(' ').pop() || 'üå±';
                    iconEl.textContent = levelIcon;
                    titleEl.textContent = `${level}`;
                    const xp = globalSharingData.stats?.totalXP || 0;
                    descEl.textContent = `${xp.toLocaleString()} XP conquistados! Cada ponto me aproxima da aprova√ß√£o.`;
                    break;

                case 'summary':
                    iconEl.textContent = 'üìä';
                    titleEl.textContent = 'Meu Progresso nos Estudos';
                    const sessions = globalSharingData.stats?.totalSessions || 0;
                    const totalTime = formatStudyTime(globalSharingData.stats?.totalStudyTime || 0);
                    descEl.textContent = `${sessions} sess√µes completadas, ${totalTime} investidos no meu futuro!`;
                    break;
            }
        }

        function getAchievementIcon(title) {
            const achievementIcons = {
                'Primeiro Estudo': 'üåü',
                'Sequ√™ncia de 3 dias': 'üî•',
                'Sequ√™ncia de 7 dias': 'üí™',
                'Primeiro Simulado': 'üéØ',
                '10 T√≥picos Conclu√≠dos': 'üìö',
                '50 T√≥picos Conclu√≠dos': 'üèÜ',
                'Primeira Lapada no Edital üìñ': 'üìñ',
                'Maratonista do PDF üèÉ': 'üèÉ',
                'Concurseiro(a) Raiz üå≥': 'üå≥',
                'Doutor(a) Google de Legisla√ß√£o üîé': 'üîé',
                'Guru dos Grifos üñçÔ∏è': 'üñçÔ∏è',
                'Mestre Jedi dos Concursos ‚öîÔ∏è': '‚öîÔ∏è',
                'Chuck Norris dos Editais üí™': 'üí™',
                'Resistente ao Netflix üì∫': 'üì∫',
                'Imune ao Sof√° üõãÔ∏è': 'üõãÔ∏è',
                'Inimigo do Descanso üò§': 'üò§',
                'M√°quina de Aprovar ü§ñ': 'ü§ñ',
                'Cyborg Concurseiro ü¶æ': 'ü¶æ',
                'Viciado(a) em Quest√µes üíä': 'üíä',
                'Bibliotec√°rio(a) Honor√°rio(a) üìö': 'üìö',
                'Rei/Rainha do Resumo üëë': 'üëë',
                'PhD em Perseveran√ßa üéì': 'üéì',
                'Madrugador(a) Insano(a) üåÖ': 'üåÖ',
                'Destruidor(a) de Finais de Semana üéâ': 'üéâ'
            };
            return achievementIcons[title] || 'üèÖ';
        }

        function setupShareButtons() {
            // WhatsApp sharing
            document.getElementById('shareWhatsApp')?.addEventListener('click', () => {
                const message = generateShareMessage();
                const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(url, '_blank');
                trackShare('whatsapp');
            });

            // Instagram sharing (create visual card)
            document.getElementById('shareInstagram')?.addEventListener('click', () => {
                generateInstagramCard();
                trackShare('instagram');
            });

            // Download card
            document.getElementById('downloadShareCard')?.addEventListener('click', () => {
                downloadShareCard();
                trackShare('download');
            });

            // Challenge sharing
            document.getElementById('shareChallengeBtn')?.addEventListener('click', () => {
                shareChallenge();
                trackShare('challenge');
            });
        }

        function generateShareMessage() {
            const template = document.querySelector('input[name="shareTemplate"]:checked')?.value || 'achievement';
            const stats = globalSharingData.stats;
            const userName = globalSharingData.profile?.name || 'Concurseiro(a)';
            
            let message = '';
            
            switch (template) {
                case 'achievement':
                    const achievement = globalSharingData.achievements?.[0];
                    if (achievement) {
                        const icon = getAchievementIcon(achievement.title);
                        message = `üèÜ CONQUISTA DESBLOQUEADA! ${icon}\n\nAcabei de conquistar: "${achievement.title}"\n\nüí™ Cada dia mais perto da aprova√ß√£o!\n\nüéØ Quer se juntar a mim nessa jornada?\nüëâ editaliza.com.br - Seu futuro no servi√ßo p√∫blico come√ßa aqui!\nüì± @editaliza`;
                    } else {
                        message = `üöÄ Comecei minha jornada rumo √† aprova√ß√£o!\n\nüìö Estudando com foco e disciplina no Editaliza\nüí™ Determinado(a) a conquistar meu lugar no servi√ßo p√∫blico!\n\nüéØ Vem comigo nessa miss√£o!\nüëâ editaliza.com.br | @editaliza`;
                    }
                    break;
                    
                case 'streak':
                    const streak = stats?.studyStreak || 0;
                    if (streak > 0) {
                        message = `üî• SEQU√äNCIA √âPICA! ${streak} DIAS CONSECUTIVOS!\n\nüí™ ${streak} dias seguidos estudando sem parar\nüéØ Disciplina e consist√™ncia em a√ß√£o\n‚ö° Cada dia me aproxima mais da aprova√ß√£o!\n\nüöÄ Quer construir sua sequ√™ncia tamb√©m?\nüëâ editaliza.com.br - Transforme sua rotina de estudos!\nüì± @editaliza`;
                    } else {
                        message = `üî• NOVA SEQU√äNCIA COME√áANDO!\n\nüéØ Preparado(a) para conquistar meus objetivos\nüí™ Foco total nos estudos para concursos\nüìö Cada dia conta na jornada rumo √† aprova√ß√£o!\n\nüöÄ Vem comigo nessa!\nüëâ editaliza.com.br | @editaliza`;
                    }
                    break;
                    
                case 'level':
                    const level = stats?.currentLevel || 'Iniciante üå±';
                    const xp = stats?.totalXP || 0;
                    message = `‚≠ê N√çVEL ALCAN√áADO: ${level}\n\n‚ú® ${xp.toLocaleString()} XP conquistados!\nüéØ Cada ponto de experi√™ncia = progresso real\nüí™ Evoluindo constantemente nos estudos\n\nüìà Minha dedica√ß√£o est√° valendo a pena!\nüëâ editaliza.com.br - Gamifique seus estudos!\nüì± @editaliza`;
                    break;
                    
                case 'summary':
                    const sessions = stats?.totalSessions || 0;
                    const totalTime = formatStudyTime(stats?.totalStudyTime || 0);
                    const achievements = globalSharingData.achievements?.length || 0;
                    message = `üìä MEU PROGRESSO NOS ESTUDOS:\n\nüéØ ${sessions} sess√µes completadas\n‚è±Ô∏è ${totalTime} investidos no meu futuro\nüèÜ ${achievements} conquistas desbloqueadas\n${stats?.studyStreak > 0 ? `üî• ${stats.studyStreak} dias de sequ√™ncia\n` : ''}üí™ Cada minuto me aproxima da aprova√ß√£o!\n\nüöÄ Quer acompanhar meu progresso?\nüëâ editaliza.com.br - Seu futuro come√ßa aqui!\nüì± @editaliza`;
                    break;
            }
            
            return message;
        }

        // Browser compatibility polyfill for roundRect
        function ensureRoundRectSupport(ctx) {
            if (!ctx.roundRect) {
                ctx.roundRect = function(x, y, width, height, radius) {
                    if (width < 2 * radius) radius = width / 2;
                    if (height < 2 * radius) radius = height / 2;
                    this.beginPath();
                    this.moveTo(x + radius, y);
                    this.arcTo(x + width, y, x + width, y + height, radius);
                    this.arcTo(x + width, y + height, x, y + height, radius);
                    this.arcTo(x, y + height, x, y, radius);
                    this.arcTo(x, y, x + width, y, radius);
                    this.closePath();
                };
            }
        }
        
        async function generateInstagramCard() {
            try {
                // Create a canvas element for the Instagram card
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Ensure roundRect compatibility
                ensureRoundRectSupport(ctx);
                
                // Perfect Instagram square format (1080x1080)
                canvas.width = 1080;
                canvas.height = 1080;
                
                // MODERN INSTAGRAM BACKGROUND DESIGN
                // Create sophisticated gradient background
                const bgGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                bgGradient.addColorStop(0, '#ffffff');
                bgGradient.addColorStop(0.5, '#f8faff');
                bgGradient.addColorStop(1, '#f0f4ff');
                ctx.fillStyle = bgGradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Subtle geometric pattern overlay for texture
                ctx.globalAlpha = 0.03;
                for (let i = 0; i < 50; i++) {
                    ctx.fillStyle = '#0528f2';
                    ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 2);
                }
                ctx.globalAlpha = 1.0;
                
                // HEADER SECTION WITH LOGO
                // Load and render the actual SVG logo
                await loadAndRenderLogo(ctx, canvas.width);
                
                // MAIN CONTENT AREA
                const template = document.querySelector('input[name="shareTemplate"]:checked')?.value || 'achievement';
                const stats = globalSharingData.stats;
                
                // Content container with modern styling
                const contentY = 300;
                const contentHeight = 500;
                const margin = 60;
                
                // Main content background with subtle shadow
                ctx.shadowColor = 'rgba(5, 40, 242, 0.1)';
                ctx.shadowBlur = 30;
                ctx.shadowOffsetY = 10;
                ctx.fillStyle = '#ffffff';
                ctx.roundRect(margin, contentY, canvas.width - (margin * 2), contentHeight, 24);
                ctx.fill();
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetY = 0;
                
                // Accent border for content area
                const accentGradient = ctx.createLinearGradient(margin, contentY, canvas.width - margin, contentY);
                accentGradient.addColorStop(0, '#0528f2');
                accentGradient.addColorStop(0.5, '#1ad937');
                accentGradient.addColorStop(1, '#0528f2');
                ctx.fillStyle = accentGradient;
                ctx.fillRect(margin, contentY, canvas.width - (margin * 2), 6);
                
                // ACHIEVEMENT ICON SECTION
                const iconY = contentY + 80;
                ctx.textAlign = 'center';
                ctx.font = 'bold 80px "Segoe UI Emoji", Apple Color Emoji, sans-serif';
                const mainIcon = document.getElementById('shareMainIcon')?.textContent || 'üèÜ';
                
                // Icon background circle
                ctx.fillStyle = 'rgba(5, 40, 242, 0.1)';
                ctx.beginPath();
                ctx.arc(canvas.width / 2, iconY, 65, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.fillStyle = '#0528f2';
                ctx.fillText(mainIcon, canvas.width / 2, iconY + 20);
                
                // MAIN TITLE SECTION
                const titleY = iconY + 100;
                ctx.font = 'bold 42px "Inter", "Segoe UI", Arial, sans-serif';
                ctx.fillStyle = '#1a1a1a';
                const mainTitle = document.getElementById('shareMainTitle')?.textContent || 'Nova Conquista!';
                
                // Enhanced word wrap with better spacing
                const words = mainTitle.split(' ');
                const maxWidth = canvas.width - 160;
                let line = '';
                let currentY = titleY;
                let lineCount = 0;
                
                for (let n = 0; n < words.length && lineCount < 3; n++) {
                    const testLine = line + words[n] + ' ';
                    const metrics = ctx.measureText(testLine);
                    
                    if (metrics.width > maxWidth && n > 0) {
                        ctx.fillText(line.trim(), canvas.width / 2, currentY);
                        line = words[n] + ' ';
                        currentY += 50;
                        lineCount++;
                    } else {
                        line = testLine;
                    }
                }
                if (line.trim() && lineCount < 3) {
                    ctx.fillText(line.trim(), canvas.width / 2, currentY);
                }
                
                // STATS SECTION WITH MODERN DESIGN
                const statsY = currentY + 80;
                const level = document.getElementById('shareStatsLevel')?.textContent || '1';
                const streak = document.getElementById('shareStatsStreak')?.textContent || '0';
                const xp = document.getElementById('shareStatsXP')?.textContent || '0';
                const time = document.getElementById('shareStatsTime')?.textContent || '0h';
                
                // Stats container background
                ctx.fillStyle = 'rgba(26, 217, 55, 0.08)';
                ctx.roundRect(margin + 40, statsY - 30, canvas.width - (margin * 2) - 80, 120, 16);
                ctx.fill();
                
                // Stats layout - 2x2 grid
                const statsData = [
                    { label: 'N√≠vel', value: level, icon: '‚≠ê' },
                    { label: 'Sequ√™ncia', value: streak + ' dias', icon: 'üî•' },
                    { label: 'XP Total', value: parseInt(xp).toLocaleString() + ' XP', icon: 'üíé' },
                    { label: 'Tempo', value: time, icon: '‚è±Ô∏è' }
                ];
                
                const statsPerRow = 2;
                const statWidth = (canvas.width - (margin * 2) - 80) / statsPerRow;
                const statHeight = 40;
                
                ctx.textAlign = 'center';
                ctx.font = 'bold 16px "Inter", Arial, sans-serif';
                
                statsData.forEach((stat, index) => {
                    const col = index % statsPerRow;
                    const row = Math.floor(index / statsPerRow);
                    const x = margin + 40 + (col * statWidth) + (statWidth / 2);
                    const y = statsY + (row * statHeight);
                    
                    // Stat icon
                    ctx.font = '20px "Segoe UI Emoji", Apple Color Emoji, sans-serif';
                    ctx.fillStyle = '#0528f2';
                    ctx.fillText(stat.icon, x - 60, y);
                    
                    // Stat label
                    ctx.font = 'bold 14px "Inter", Arial, sans-serif';
                    ctx.fillStyle = '#666';
                    ctx.textAlign = 'left';
                    ctx.fillText(stat.label, x - 40, y - 5);
                    
                    // Stat value
                    ctx.font = 'bold 18px "Inter", Arial, sans-serif';
                    ctx.fillStyle = '#1a1a1a';
                    ctx.fillText(stat.value, x - 40, y + 15);
                });
                
                // CALL TO ACTION SECTION
                ctx.textAlign = 'center';
                ctx.font = 'bold 26px "Inter", Arial, sans-serif';
                
                // CTA background
                const ctaY = statsY + 120;
                const ctaGradient = ctx.createLinearGradient(0, ctaY, 0, ctaY + 40);
                ctaGradient.addColorStop(0, 'rgba(5, 40, 242, 0.1)');
                ctaGradient.addColorStop(1, 'rgba(26, 217, 55, 0.1)');
                ctx.fillStyle = ctaGradient;
                ctx.roundRect(margin + 40, ctaY - 10, canvas.width - (margin * 2) - 80, 60, 12);
                ctx.fill();
                
                ctx.fillStyle = '#0528f2';
                ctx.fillText('üöÄ Conquiste seu futuro!', canvas.width / 2, ctaY + 20);
                
                // FOOTER BRANDING
                ctx.font = 'bold 20px "Inter", Arial, sans-serif';
                ctx.fillStyle = '#1ad937';
                ctx.fillText('editaliza.com.br | @editaliza', canvas.width / 2, ctaY + 55);
                
                // Sophisticated watermark
                ctx.font = '12px "Inter", Arial, sans-serif';
                ctx.fillStyle = 'rgba(26, 26, 26, 0.4)';
                ctx.textAlign = 'right';
                ctx.fillText('‚ú® Criado com Editaliza', canvas.width - 40, canvas.height - 25);
                
                // Convert to blob and open in new tab with better styling
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const newWindow = window.open();
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="pt-BR">
                            <head>
                                <title>Card do Instagram - Editaliza</title>
                                <meta charset="UTF-8">
                                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
                                <style>
                                    * { margin: 0; padding: 0; box-sizing: border-box; }
                                    body { 
                                        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        min-height: 100vh;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        padding: 20px;
                                    }
                                    .container {
                                        background: white;
                                        border-radius: 24px;
                                        padding: 40px;
                                        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
                                        text-align: center;
                                        max-width: 500px;
                                        width: 100%;
                                    }
                                    h1 {
                                        color: #1a1a1a;
                                        font-size: 24px;
                                        font-weight: 700;
                                        margin-bottom: 8px;
                                    }
                                    .subtitle {
                                        color: #666;
                                        font-size: 16px;
                                        margin-bottom: 30px;
                                    }
                                    .card-preview {
                                        width: 100%;
                                        max-width: 400px;
                                        border-radius: 20px;
                                        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
                                        margin-bottom: 30px;
                                        transition: transform 0.3s ease;
                                    }
                                    .card-preview:hover {
                                        transform: scale(1.02);
                                    }
                                    .instructions {
                                        color: #666;
                                        font-size: 14px;
                                        margin-bottom: 25px;
                                        line-height: 1.6;
                                    }
                                    .button-group {
                                        display: flex;
                                        gap: 15px;
                                        justify-content: center;
                                        flex-wrap: wrap;
                                    }
                                    .btn {
                                        padding: 12px 24px;
                                        border: none;
                                        border-radius: 12px;
                                        font-size: 14px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        text-decoration: none;
                                        display: inline-flex;
                                        align-items: center;
                                        gap: 8px;
                                    }
                                    .btn-primary {
                                        background: linear-gradient(135deg, #0528f2, #1ad937);
                                        color: white;
                                    }
                                    .btn-secondary {
                                        background: #f8f9fa;
                                        color: #666;
                                        border: 1px solid #e9ecef;
                                    }
                                    .btn:hover {
                                        transform: translateY(-2px);
                                        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                                    }
                                    @media (max-width: 480px) {
                                        .container { padding: 30px 20px; }
                                        .button-group { flex-direction: column; }
                                        .btn { justify-content: center; }
                                    }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <h1>üéâ Seu Card do Instagram</h1>
                                    <p class="subtitle">Perfeito para compartilhar suas conquistas!</p>
                                    <img src="${url}" class="card-preview" alt="Card do Instagram">
                                    <p class="instructions">
                                        üì± <strong>Para salvar:</strong> Clique com o bot√£o direito na imagem e selecione "Salvar imagem como..."<br>
                                        üì§ <strong>Para compartilhar:</strong> Arraste a imagem diretamente para o Instagram ou Stories
                                    </p>
                                    <div class="button-group">
                                        <a href="${url}" download="editaliza-conquista-${Date.now()}.png" class="btn btn-primary">
                                            üì• Baixar Imagem
                                        </a>
                                        <button onclick="window.close()" class="btn btn-secondary">
                                            ‚úï Fechar
                                        </button>
                                    </div>
                                </div>
                            </body>
                        </html>
                    `);
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar card do Instagram:', error);
                alert('Ops! Houve um erro ao gerar seu card. Tente novamente em alguns segundos.');
            }
        }
        
        // Helper function to load and render the actual SVG logo
        async function loadAndRenderLogo(ctx, canvasWidth) {
            try {
                // Load the SVG logo
                const response = await fetch('./logotipo.svg');
                const svgText = await response.text();
                
                // Create an image from SVG
                const svgBlob = new Blob([svgText], { type: 'image/svg+xml' });
                const svgUrl = URL.createObjectURL(svgBlob);
                
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        // Calculate logo dimensions for perfect fit
                        const logoMaxWidth = canvasWidth * 0.6; // 60% of canvas width
                        const logoMaxHeight = 120;
                        
                        const aspectRatio = img.width / img.height;
                        let logoWidth = logoMaxWidth;
                        let logoHeight = logoWidth / aspectRatio;
                        
                        if (logoHeight > logoMaxHeight) {
                            logoHeight = logoMaxHeight;
                            logoWidth = logoHeight * aspectRatio;
                        }
                        
                        // Position logo in header area
                        const logoX = (canvasWidth - logoWidth) / 2;
                        const logoY = 80;
                        
                        // Draw logo with high quality
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, logoX, logoY, logoWidth, logoHeight);
                        
                        URL.revokeObjectURL(svgUrl);
                        resolve();
                    };
                    img.onerror = () => {
                        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel carregar o logo SVG, usando fallback');
                        URL.revokeObjectURL(svgUrl);
                        renderFallbackLogo(ctx, canvasWidth);
                        resolve();
                    };
                    img.src = svgUrl;
                });
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao carregar logo SVG, usando fallback:', error);
                renderFallbackLogo(ctx, canvasWidth);
            }
        }
        
        // Fallback logo rendering if SVG fails to load
        function renderFallbackLogo(ctx, canvasWidth) {
            // Modern text-based logo as fallback
            ctx.textAlign = 'center';
            ctx.font = 'bold 48px "Inter", Arial, sans-serif';
            
            // Logo background
            const gradient = ctx.createLinearGradient(0, 80, 0, 140);
            gradient.addColorStop(0, '#0528f2');
            gradient.addColorStop(1, '#1ad937');
            ctx.fillStyle = gradient;
            
            // Subtle logo background shape
            ctx.roundRect(canvasWidth/2 - 200, 80, 400, 60, 15);
            ctx.fill();
            
            // Logo text
            ctx.fillStyle = '#ffffff';
            ctx.fillText('EDITALIZA', canvasWidth / 2, 125);
            
            // Tagline
            ctx.font = 'bold 16px "Inter", Arial, sans-serif';
            ctx.fillStyle = '#0528f2';
            ctx.fillText('Gamifique seus estudos', canvasWidth / 2, 160);
        }

        function downloadShareCard() {
            // Professional landscape card for download
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 1200;
            canvas.height = 800;
            
            // Clean white background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Brand accent border (top)
            const accentGradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
            accentGradient.addColorStop(0, '#0528f2');
            accentGradient.addColorStop(0.5, '#1ad937');
            accentGradient.addColorStop(1, '#0528f2');
            ctx.fillStyle = accentGradient;
            ctx.fillRect(0, 0, canvas.width, 6);
            
            // Logo area
            ctx.save();
            ctx.translate(150, 80);
            ctx.scale(0.6, 0.6);
            
            // Logo icon (simplified diamond/badge shape)
            ctx.fillStyle = '#0528f2';
            ctx.beginPath();
            ctx.moveTo(0, -30);
            ctx.lineTo(26, -15);
            ctx.lineTo(26, 15);
            ctx.lineTo(0, 30);
            ctx.lineTo(-26, 15);
            ctx.lineTo(-26, -15);
            ctx.closePath();
            ctx.fill();
            
            // Inner circle
            ctx.fillStyle = '#1ad937';
            ctx.beginPath();
            ctx.arc(0, 0, 12, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.restore();
            
            // EDITALIZA text logo
            ctx.fillStyle = '#0d0d0d';
            ctx.font = 'bold 32px Inter, Arial, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('EDITALIZA', 200, 95);
            
            // Main content area
            const mainIcon = document.getElementById('shareMainIcon').textContent;
            const mainTitle = document.getElementById('shareMainTitle').textContent;
            
            // Achievement icon
            ctx.font = 'bold 64px Inter, Arial, sans-serif';
            ctx.fillStyle = '#0528f2';
            ctx.textAlign = 'center';
            ctx.fillText(mainIcon, canvas.width/2, 200);
            
            // Main title
            ctx.font = 'bold 32px Inter, Arial, sans-serif';
            ctx.fillStyle = '#0d0d0d';
            ctx.fillText(mainTitle, canvas.width/2, 260);
            
            // Stats section
            const level = document.getElementById('shareStatsLevel').textContent;
            const streak = document.getElementById('shareStatsStreak').textContent;
            const xp = document.getElementById('shareStatsXP').textContent;
            const time = document.getElementById('shareStatsTime').textContent;
            
            // Stats background
            ctx.fillStyle = '#f8f9fa';
            ctx.roundRect(150, 320, canvas.width-300, 180, 16);
            ctx.fill();
            
            // Stats layout (2x2 grid)
            ctx.font = 'bold 20px Inter, Arial, sans-serif';
            ctx.fillStyle = '#0528f2';
            ctx.textAlign = 'left';
            
            // Top row
            ctx.fillText('N√≠vel', 200, 360);
            ctx.fillText('Sequ√™ncia', 650, 360);
            
            // Bottom row
            ctx.fillText('XP', 200, 420);
            ctx.fillText('Tempo de Estudo', 650, 420);
            
            // Values
            ctx.font = 'bold 18px Inter, Arial, sans-serif';
            ctx.fillStyle = '#0d0d0d';
            ctx.fillText(level, 200, 385);
            ctx.fillText(streak, 650, 385);
            ctx.fillText(xp, 200, 445);
            ctx.fillText(time, 650, 445);
            
            // Call to action
            ctx.textAlign = 'center';
            ctx.font = 'bold 20px Inter, Arial, sans-serif';
            ctx.fillStyle = '#0528f2';
            ctx.fillText('Conquiste seu futuro no servi√ßo p√∫blico!', canvas.width/2, 580);
            
            ctx.font = '16px Inter, Arial, sans-serif';
            ctx.fillStyle = '#666';
            ctx.fillText('editaliza.com.br | @editaliza', canvas.width/2, 605);
            
            // Watermark
            ctx.font = '12px Inter, Arial, sans-serif';
            ctx.fillStyle = 'rgba(13, 13, 13, 0.3)';
            ctx.textAlign = 'right';
            ctx.fillText('Gerado por Editaliza', canvas.width - 30, canvas.height - 20);
            
            // Download
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `editaliza-conquista-${Date.now()}.png`;
                a.click();
                URL.revokeObjectURL(url);
            });
        }

        function shareChallenge() {
            const stats = globalSharingData.stats;
            const userName = globalSharingData.profile?.name || 'Concurseiro(a)';
            
            const message = `\u{1F3AF} DESAFIO EDITALIZA! \u{1F525}\n\nEu ${userName} te desafio para uma batalha √©pica de estudos!\n\n\u{1F4AA} Meus n√∫meros atuais:\n${stats?.studyStreak > 0 ? `\u{1F525} ${stats.studyStreak} dias de sequ√™ncia\n` : ''}\u{2728} ${(stats?.totalXP || 0).toLocaleString()} XP conquistados\n\u{23F1}\u{FE0F} ${formatStudyTime(stats?.totalStudyTime || 0)} de estudos\n\n\u{1F680} Consegue me superar? Aceita o desafio?\n\n\u{1F449} editaliza.com.br - Gamifique seus estudos e construa seu futuro!\n\u{1F4F1} @editaliza`;
            
            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function trackShare(platform) {
            // Track sharing analytics
            const currentMonth = new Date().getMonth();
            const storageKey = `editaliza_shares_${currentMonth}`;
            
            let monthlyShares = parseInt(localStorage.getItem(storageKey) || '0');
            monthlyShares++;
            localStorage.setItem(storageKey, monthlyShares.toString());
            
            document.getElementById('monthlyShares').textContent = monthlyShares;
            
            // Could also send to analytics endpoint
            console.log(`üìä Share tracked: ${platform}, Monthly total: ${monthlyShares}`);
            
            // Show success toast
            app.showToast(`Compartilhamento criado com sucesso! üöÄ`, 'success');
        }

        function loadSharingData(globalStats) {
            // Store global data for sharing
            globalSharingData.stats = {
                currentLevel: globalStats?.highestLevel || 'Iniciante üå±',
                studyStreak: globalStats?.studyStreak || 0,
                totalXP: globalStats?.totalXP || 0,
                totalStudyTime: globalStats?.totalStudyTime || 0,
                totalSessions: globalStats?.totalSessions || 0
            };
            
            globalSharingData.achievements = globalStats?.globalAchievements || [];
            
            // Sort achievements by date (most recent first)
            globalSharingData.achievements.sort((a, b) => 
                new Date(b.achieved_date) - new Date(a.achieved_date)
            );
            
            // Load monthly shares
            const currentMonth = new Date().getMonth();
            const storageKey = `editaliza_shares_${currentMonth}`;
            const monthlyShares = parseInt(localStorage.getItem(storageKey) || '0');
            document.getElementById('monthlyShares').textContent = monthlyShares;
            
            // Update share preview with loaded data
            updateSharePreview('achievement');
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
    
    <!-- Script do rodap√© modular -->
    <script src="js/footer.js"></script>
    <!-- O rodap√© ser√° inserido automaticamente aqui pelo footer.js -->
</body>
</html>
