<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Editaliza</title>
    
    <!-- Favicon and Web App Icons -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F7FAFC">
    
    <link href="css/tailwind.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/footer.css" rel="stylesheet">
    <link href="css/light-mode-only.css" rel="stylesheet">
    <!-- Theme system completely removed - light mode only -->
    <!-- SCRIPTS CENTRALIZADOS -->
    <script src="js/app.js"></script>
    <script src="js/components.js"></script>
    <script src="js/navigation-init.js"></script>
    <script src="js/modules/contextual-notifications.js" type="module"></script>
    <script src="js/modules/notification-integrations.js" type="module"></script>
    
    <!-- Registro do Service Worker para Notificações Push -->
    <script>
        if ('serviceWorker' in navigator && 'PushManager' in window && location.hostname !== 'localhost' && location.protocol === 'https:') {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {

                })
                .catch(error => {
                    console.error('❌ Erro ao registrar Service Worker:', error);
                });
        }
    </script>
    <!-- Tailwind config removed - using compiled CSS -->
    <!-- Custom colors now available through compiled tailwind.css -->
    <style>
        /* Estilos específicos da página */
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease; }
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Dashboard Cards - Melhor espaçamento e animações sutis */
        .dashboard-card {
            transform: translateY(10px);
            opacity: 0;
            animation: cardFadeIn 0.6s ease-out forwards;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-card:nth-child(1) { animation-delay: 0.1s; }
        .dashboard-card:nth-child(2) { animation-delay: 0.2s; }
        .dashboard-card:nth-child(3) { animation-delay: 0.3s; }
        
        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--editaliza-blue), transparent);
            transition: left 0.6s ease;
        }
        
        .dashboard-card:hover::before {
            left: 100%;
        }
        
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -10px rgba(5, 40, 242, 0.15);
            border-color: rgba(5, 40, 242, 0.1);
        }
        
        /* Hero section animations */
        .hero-fade-in {
            animation: heroFadeIn 1s ease-out;
        }
        
        @keyframes heroFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Section headers */
        .section-header {
            animation: slideInLeft 0.8s ease-out;
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes cardFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Micro-interações para botões */
        .btn-primary {
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
        }
        
        .btn-primary:active::after {
            width: 300px;
            height: 300px;
        }
        
        /* Ícones com animação suave */
        .icon-bounce {
            display: inline-block;
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover .icon-bounce {
            transform: scale(1.1) rotate(5deg);
        }
        
        /* Templates com efeito hover melhorado */
        .template-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 1px solid transparent;
        }
        
        .template-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(5, 40, 242, 0.12);
            border-color: rgba(5, 40, 242, 0.2);
        }
        
        .template-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(5, 40, 242, 0.1);
        }
        
        /* Bounce animation */
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0,0,0);
            }
            40%, 43% {
                transform: translate3d(0,-8px,0);
            }
            70% {
                transform: translate3d(0,-4px,0);
            }
            90% {
                transform: translate3d(0,-2px,0);
            }
        }
        
        /* Quick tips card special styling */
        .tips-card {
            background: linear-gradient(135deg, #f8faff 0%, #f1f5ff 100%);
            border: 1px solid #e0e7ff;
        }
        
        /* Lista de planos com animação */
        .plan-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 3px solid transparent;
        }
        
        .plan-item:hover {
            border-left-color: var(--editaliza-blue);
            transform: translateX(4px);
            background: linear-gradient(90deg, rgba(5, 40, 242, 0.02), transparent);
        }
        
        /* Preview de tempo com efeito especial */
        #timePreview {
            transform: translateY(-10px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #timePreview:not(.hidden) {
            transform: translateY(0);
            opacity: 1;
            animation: pulseGlow 2s ease-in-out;
        }
        
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
        }
        
        /* Form inputs com feedback visual */
        .form-input {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .form-input:focus {
            transform: translateY(-2px);
        }
        
        /* Motivational card com gradiente sutil */
        .motivational-card {
            background: linear-gradient(135deg, rgba(5, 40, 242, 0.08), rgba(59, 130, 246, 0.04));
            border: 1px solid rgba(5, 40, 242, 0.1);
            position: relative;
        }
        
        .motivational-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--editaliza-blue), #3b82f6);
            border-radius: 12px 12px 0 0;
        }
        
        /* Form improvements */
        .form-input:focus {
            outline: none;
            ring: 2px;
            ring-color: rgba(5, 40, 242, 0.2);
            border-color: var(--editaliza-blue);
            transform: translateY(-1px);
        }
        
        /* Loading state improvements */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Empty state styling */
        .empty-state {
            animation: fadeInUp 0.8s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* FIX: Forçar aparência dos checkboxes de email com !important */
        input[type="checkbox"]#email_daily_schedule,
        input[type="checkbox"]#email_weekly_summary,
        input[type="checkbox"]#email_study_reminders {
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            width: 20px !important;
            height: 20px !important;
            border: 2px solid #d1d5db !important; /* gray-300 */
            border-radius: 0.25rem !important;
            background-color: white !important;
            cursor: pointer !important;
            position: relative !important;
            flex-shrink: 0 !important;
            transition: all 0.2s ease !important;
            display: inline-block !important;
            vertical-align: middle !important;
        }
        
        /* Checkbox checked state */
        input[type="checkbox"]#email_daily_schedule:checked,
        input[type="checkbox"]#email_weekly_summary:checked,
        input[type="checkbox"]#email_study_reminders:checked {
            background-color: #3b82f6 !important; /* blue-500 */
            border-color: #3b82f6 !important;
        }
        
        /* Checkmark usando SVG inline */
        input[type="checkbox"]#email_daily_schedule:checked::before,
        input[type="checkbox"]#email_weekly_summary:checked::before,
        input[type="checkbox"]#email_study_reminders:checked::before {
            content: '' !important;
            position: absolute !important;
            top: 2px !important;
            left: 5px !important;
            width: 6px !important;
            height: 10px !important;
            border: solid white !important;
            border-width: 0 2px 2px 0 !important;
            transform: rotate(45deg) !important;
        }
        
        /* Hover state */
        input[type="checkbox"]#email_daily_schedule:hover:not(:checked),
        input[type="checkbox"]#email_weekly_summary:hover:not(:checked),
        input[type="checkbox"]#email_study_reminders:hover:not(:checked) {
            border-color: #93c5fd !important; /* blue-300 */
            background-color: #f0f9ff !important; /* blue-50 */
        }
        
        /* Focus state */
        input[type="checkbox"]#email_daily_schedule:focus,
        input[type="checkbox"]#email_weekly_summary:focus,
        input[type="checkbox"]#email_study_reminders:focus {
            outline: none !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2) !important;
        }
        
        /* Disabled state (caso precise no futuro) */
        input[type="checkbox"]#email_daily_schedule:disabled,
        input[type="checkbox"]#email_weekly_summary:disabled,
        input[type="checkbox"]#email_study_reminders:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">
    <!-- NAVEGAÇÃO PRINCIPAL (GERADA PELO JS) -->
    <div id="main-nav-container" style="position: relative; z-index: 1000;"></div>
    
    <!-- Main content wrapper with flex-1 to push footer to bottom -->
    <div class="flex-1">

    <!-- Modal de Confirmação para Exclusão -->
    <div id="deleteConfirmationModal" class="modal-overlay hidden fixed inset-0 bg-editaliza-black bg-opacity-70 z-50 flex items-center justify-center p-4 opacity-0">
        <div class="modal-container bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md transform scale-95">
            <h2 class="text-2xl font-bold text-editaliza-black">Confirmar Exclusão</h2>
            <p class="mt-2 text-gray-600">Você tem certeza que deseja apagar o plano "<strong id="planNameToDelete"></strong>"?</p>
            <p class="mt-4 text-sm font-semibold text-red-700 bg-red-50 p-3 rounded-lg border border-red-200">
                Atenção: Todos os dados associados serão permanentemente removidos. Esta ação não pode ser desfeita.
            </p>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancelDeleteButton" class="px-6 py-2 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 font-semibold transition-colors">Cancelar</button>
                <button id="confirmDeleteButton" class="btn-danger px-6 py-2">Apagar</button>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Hero Section -->
        <section class="mb-12">
            <div class="text-center max-w-3xl mx-auto">
                <h1 class="text-4xl sm:text-5xl font-bold text-editaliza-black mb-4">
                    Seus Planos de <span class="text-editaliza-blue">Estudo</span>
                </h1>
                <p class="text-lg text-editaliza-gray leading-relaxed">
                    Organize seus estudos, acompanhe seu progresso e conquiste a aprovação com planejamento estratégico.
                </p>
            </div>
        </section>

        <!-- Layout Principal -->
        <div class="space-y-12">
            <!-- Seção: Meus Planos Ativos -->
            <section>
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <span class="text-3xl mr-3 icon-bounce">📚</span>
                        <span>Meus Planos Ativos</span>
                    </h2>
                    <div class="hidden sm:flex items-center text-sm text-gray-500">
                        <span class="mr-2">💡</span>
                        <span>Clique em um plano para configurar</span>
                    </div>
                </div>
                
                <div class="dashboard-card bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                    <div id="planList" class="space-y-3">
                            <div class="flex items-center justify-center py-12">
                            <div class="loading-spinner rounded-full h-8 w-8 border-4 border-gray-200 border-t-editaliza-blue"></div>
                            <span class="ml-3 text-gray-500 animate-pulse">Carregando seus planos...</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Seção: Criar Novo Plano -->
            <section>
                <div class="flex items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <span class="text-3xl mr-3 icon-bounce">✨</span>
                        <span>Criar Novo Plano</span>
                    </h2>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Card Principal: Formulário -->
                    <div class="lg:col-span-2">
                        <div class="dashboard-card bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                            <!-- Orientação Motivacional -->
                            <div class="motivational-card bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl mb-8 border border-blue-100">
                                <div class="flex items-start">
                                    <span class="text-3xl mr-4 icon-bounce">🎯</span>
                                    <div>
                                        <h3 class="text-xl font-bold text-editaliza-blue mb-2">Primeiro passo rumo à aprovação!</h3>
                                        <p class="text-gray-700 leading-relaxed">Vamos criar um plano personalizado e estratégico para você. Depois te guio passo a passo na configuração completa.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="newPlanForm" class="space-y-6">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                    <div class="sm:col-span-2">
                                        <label for="plan_name" class="block text-sm font-semibold text-gray-700 mb-3">
                                            Nome do Plano
                                            <span class="text-red-500 ml-1">*</span>
                                        </label>
                                        <input type="text" id="plan_name" 
                                               class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-editaliza-blue focus:border-transparent transition-all" 
                                               placeholder="Ex: Concurso TJCE 2025, ENEM 2025, OAB 1ª Fase" 
                                               required>
                                        <p class="text-xs text-gray-500 mt-2 flex items-center">
                                            <span class="mr-1">💡</span>
                                            <span>Use o nome do concurso e o ano para organização</span>
                                        </p>
                                    </div>
                                    
                                    <div class="sm:col-span-1">
                                        <label for="exam_date" class="block text-sm font-semibold text-gray-700 mb-3">
                                            Data da Prova
                                            <span class="text-red-500 ml-1">*</span>
                                        </label>
                                        <input type="date" id="exam_date" 
                                               class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-editaliza-blue focus:border-transparent transition-all" 
                                               required>
                                        <p class="text-xs text-gray-500 mt-2 flex items-center">
                                            <span class="mr-1">📅</span>
                                            <span>Calculo automático do tempo</span>
                                        </p>
                                    </div>
                                    
                                    <div class="sm:col-span-1">
                                        <!-- Preview do Tempo Disponível -->
                                        <div id="timePreview" class="hidden">
                                            <label class="block text-sm font-semibold text-gray-700 mb-3">Tempo Disponível</label>
                                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                                <div class="flex items-center text-green-700">
                                                    <span class="mr-2 text-lg">⏰</span>
                                                    <span id="timePreviewText" class="text-sm font-medium"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Preferências de Email -->
                                <div class="border-t pt-6">
                                    <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                        <span class="mr-3">📧</span> Notificações por Email
                                    </h3>
                                    
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                        <label class="flex items-start cursor-pointer p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                            <input type="checkbox" id="email_daily_schedule" class="mt-1 mr-3 rounded border-gray-300 text-editaliza-blue focus:ring-editaliza-blue" checked>
                                            <div>
                                                <div class="font-medium text-sm text-gray-700">Cronograma Diário</div>
                                                <div class="text-xs text-gray-500 mt-1">6h da manhã</div>
                                            </div>
                                        </label>
                                        
                                        <label class="flex items-start cursor-pointer p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                            <input type="checkbox" id="email_weekly_summary" class="mt-1 mr-3 rounded border-gray-300 text-editaliza-blue focus:ring-editaliza-blue" checked>
                                            <div>
                                                <div class="font-medium text-sm text-gray-700">Resumo Semanal</div>
                                                <div class="text-xs text-gray-500 mt-1">Domingo</div>
                                            </div>
                                        </label>
                                        
                                        <label class="flex items-start cursor-pointer p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                            <input type="checkbox" id="email_study_reminders" class="mt-1 mr-3 rounded border-gray-300 text-editaliza-blue focus:ring-editaliza-blue" checked>
                                            <div>
                                                <div class="font-medium text-sm text-gray-700">Lembretes</div>
                                                <div class="text-xs text-gray-500 mt-1">Personalizados</div>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <p class="text-xs text-gray-500 mt-4 flex items-center">
                                        <span class="mr-2">🔒</span>
                                        <span>Você pode alterar essas preferências a qualquer momento</span>
                                    </p>
                                </div>
                                
                                <button type="submit" id="createPlanButton" 
                                        class="btn-primary w-full py-4 text-lg font-semibold group">
                                    <span class="flex items-center justify-center">
                                        <span class="mr-3">✨</span>
                                        Criar Meu Plano!
                                        <span class="ml-3 transform group-hover:translate-x-1 transition-transform">→</span>
                                    </span>
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Sidebar: Templates e Dicas -->
                    <div class="space-y-6">
                        <!-- Templates Populares -->
                        <div class="dashboard-card bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                <span class="mr-3 icon-bounce">🚀</span>
                                <span>Templates Rápidos</span>
                            </h3>
                            <div class="space-y-3">
                                <button type="button" 
                                        class="template-btn w-full text-left p-4 bg-gray-50 hover:bg-blue-50 rounded-lg transition-all border border-transparent hover:border-blue-200" 
                                        data-name="Concurso Público Federal" 
                                        data-months="6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="mr-3 text-lg">⚖️</span>
                                            <div>
                                                <div class="font-medium text-sm text-gray-700">Concurso Federal</div>
                                                <div class="text-xs text-gray-500">6 meses</div>
                                            </div>
                                        </div>
                                        <span class="text-gray-400 group-hover:text-blue-500 transition-colors">→</span>
                                    </div>
                                </button>
                                
                                <button type="button" 
                                        class="template-btn w-full text-left p-4 bg-gray-50 hover:bg-blue-50 rounded-lg transition-all border border-transparent hover:border-blue-200" 
                                        data-name="OAB" 
                                        data-months="3">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="mr-3 text-lg">🏛️</span>
                                            <div>
                                                <div class="font-medium text-sm text-gray-700">Exame da OAB</div>
                                                <div class="text-xs text-gray-500">3 meses</div>
                                            </div>
                                        </div>
                                        <span class="text-gray-400 group-hover:text-blue-500 transition-colors">→</span>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Dicas Rápidas -->
                        <div class="dashboard-card bg-gradient-to-br from-indigo-50 to-blue-50 border border-indigo-200 rounded-xl p-6 shadow-sm">
                            <h3 class="text-lg font-semibold text-indigo-800 mb-4 flex items-center">
                                <span class="mr-3">💡</span>
                                <span>Dicas para Sucesso</span>
                            </h3>
                            <ul class="space-y-3 text-sm text-indigo-700">
                                <li class="flex items-start">
                                    <span class="mr-2 mt-0.5 w-2 h-2 bg-indigo-400 rounded-full flex-shrink-0"></span>
                                    <span>Seja específico no nome do plano</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="mr-2 mt-0.5 w-2 h-2 bg-indigo-400 rounded-full flex-shrink-0"></span>
                                    <span>Configure a data da prova corretamente</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="mr-2 mt-0.5 w-2 h-2 bg-indigo-400 rounded-full flex-shrink-0"></span>
                                    <span>Ative notificações para não perder prazos</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        const deleteModal = document.getElementById('deleteConfirmationModal');
        let planIdToDelete = null;

        function openDeleteModal(planId, planName) {
            planIdToDelete = planId;
            document.getElementById('planNameToDelete').textContent = planName;
            deleteModal.classList.remove('hidden');
            setTimeout(() => {
                deleteModal.classList.remove('opacity-0');
                deleteModal.querySelector('.modal-container').classList.remove('scale-95');
            }, 10);
        }

        function closeDeleteModal() {
            deleteModal.classList.add('opacity-0');
            deleteModal.querySelector('.modal-container').classList.add('scale-95');
            setTimeout(() => {
                deleteModal.classList.add('hidden');
                planIdToDelete = null;
            }, 300);
        }

        async function fetchAndDisplayPlans() {
            app.showSpinner();
            try {
                const plans = await app.apiFetch("/api/plans"); 
                const planList = document.getElementById('planList');
                planList.innerHTML = '';

                if (plans.length === 0) {
                    planList.innerHTML = `
                        <div class="empty-state text-center py-16">
                            <div class="mb-6">
                                <div class="mx-auto w-24 h-24 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-full flex items-center justify-center mb-4">
                                    <span class="text-4xl icon-bounce">🎆</span>
                                </div>
                                <h3 class="text-xl font-semibold text-gray-800 mb-2">Seu primeiro plano te espera!</h3>
                                <p class="text-gray-600 max-w-md mx-auto">
                                    Começe criando um plano personalizado para sua jornada rumo à aprovação. 
                                    Vou te guiar em cada passo!
                                </p>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-3 justify-center items-center">
                                <div class="flex items-center text-sm text-gray-500">
                                    <span class="mr-2">⬇️</span>
                                    <span>Use o formulário abaixo para começar</span>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }

                plans.forEach((plan, index) => {
                    const planElement = document.createElement('div');
                    planElement.className = 'plan-item flex justify-between items-center p-6 border border-gray-200 rounded-xl hover:bg-slate-50 hover:shadow-md hover:border-blue-200 transition-all duration-300 group';
                    planElement.style.animationDelay = `${index * 0.1}s`;
                    planElement.style.animation = 'fadeInUp 0.6s ease-out forwards';
                    planElement.style.opacity = '0';
                    // Corrigir parsing de data para evitar Invalid Date
                    let examDate;

                    
                    if (plan.exam_date) {
                        // Verificar diferentes formatos de data
                        if (plan.exam_date.includes('/')) {
                            // Formato brasileiro dd/mm/aaaa
                            const [dia, mes, ano] = plan.exam_date.split('/');
                            examDate = new Date(ano, mes - 1, dia, 12, 0, 0);
                        } else if (plan.exam_date.includes('T') || plan.exam_date.includes(' ')) {
                            // Formato ISO com hora
                            examDate = new Date(plan.exam_date);
                        } else if (plan.exam_date.includes('-')) {
                            // Formato ISO sem hora (YYYY-MM-DD)
                            examDate = new Date(plan.exam_date + 'T12:00:00');
                        } else {
                            // Tentar parsing direto
                            examDate = new Date(plan.exam_date);
                        }
                    }
                    
                    // Validar se a data é válida
                    if (!examDate || isNaN(examDate.getTime())) {
                        console.warn('Data inválida para plano:', plan.id, plan.exam_date);
                        examDate = new Date(); // Fallback para hoje
                    }


                    planElement.innerHTML = `
                        <a href="plan_settings.html?id=${plan.id}" class="flex-grow flex items-center group-hover:translate-x-2 transition-transform">
                            <div class="p-3 bg-blue-50 rounded-xl mr-4 group-hover:bg-blue-100 transition-colors">
                                <span class="text-xl icon-bounce">📚</span>
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-bold text-lg text-gray-900 group-hover:text-editaliza-blue transition-colors">
                                    ${plan.plan_name}
                                </h3>
                                <p class="text-sm text-gray-600 flex items-center mt-1">
                                    <span class="mr-2">📅</span>
                                    <span>Prova em ${examDate.toLocaleDateString('pt-BR')}</span>
                                    <span class="ml-3 text-xs bg-gray-100 px-2 py-1 rounded-full">
                                        🎯 Ativo
                                    </span>
                                </p>
                            </div>
                            <div class="text-gray-400 group-hover:text-editaliza-blue transition-colors ml-4">
                                <span class="text-lg">→</span>
                            </div>
                        </a>
                        <button onclick="openDeleteModal(${plan.id}, '${plan.plan_name.replace(/'/g, "\'")}')" 
                                class="ml-4 p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all duration-200">
                            <span class="text-lg">🗑️</span>
                        </button>
                    `;
                    planList.appendChild(planElement);
                });
            } catch (error) {
                app.showToast(error.message, 'error');
                document.getElementById('planList').innerHTML = '<p class="text-red-500 text-center py-4">Não foi possível carregar os planos.</p>';
            } finally {
                app.hideSpinner();
            }
        }

        async function confirmDelete() {
            if (!planIdToDelete) return;
            
            app.showSpinner();
            closeDeleteModal();

            try {
                const data = await app.apiFetch(`/api/plans/${planIdToDelete}`, { method: 'DELETE' });
                app.showToast(data.message, 'success');
                await fetchAndDisplayPlans();
            } catch (error) {
                app.showToast(error.message, 'error');
            } finally {
                app.hideSpinner();
            }
        }

        async function initialize() {
            await components.renderMainNavigation('dashboard.html');
            
            // Add hero animation class
            document.querySelector('main section').classList.add('hero-fade-in');
            
            fetchAndDisplayPlans();
            
            const examDateInput = document.getElementById('exam_date');
            const timePreview = document.getElementById('timePreview');
            const timePreviewText = document.getElementById('timePreviewText');
            
            // Define data mínima como hoje
            examDateInput.min = new Date().toISOString().split("T")[0];
            
            // Preview de tempo em tempo real
            examDateInput.addEventListener('change', function() {
                const selectedDate = new Date(this.value);
                const today = new Date();
                const timeDiff = selectedDate - today;
                const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                
                if (daysDiff > 0) {
                    timePreview.classList.remove('hidden');
                    const months = Math.floor(daysDiff / 30);
                    const remainingDays = daysDiff % 30;
                    
                    let timeText = `Você tem ${daysDiff} dias para estudar`;
                    if (months > 0) {
                        timeText = `${months} ${months === 1 ? 'mês' : 'meses'}`;
                        if (remainingDays > 0) {
                            timeText += ` e ${remainingDays} ${remainingDays === 1 ? 'dia' : 'dias'}`;
                        }
                        timeText = `Você tem ${timeText} para estudar – vamos aproveitar cada dia! 💪`;
                    } else if (daysDiff < 30) {
                        timeText += ` – preparação intensiva! 🔥`;
                    }
                    
                    timePreviewText.textContent = timeText;
                } else {
                    timePreview.classList.add('hidden');
                }
            });
            
            // Templates rápidos
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const name = this.dataset.name;
                    const months = parseInt(this.dataset.months);
                    
                    document.getElementById('plan_name').value = name;
                    
                    // Calcula data baseada nos meses
                    const futureDate = new Date();
                    futureDate.setMonth(futureDate.getMonth() + months);
                    document.getElementById('exam_date').value = futureDate.toISOString().split('T')[0];
                    
                    // Trigger do evento de preview
                    examDateInput.dispatchEvent(new Event('change'));
                    
                    // Feedback visual melhorado
                    this.classList.add('bg-blue-100', 'border-blue-300', 'shadow-lg');
                    this.style.transform = 'scale(1.02)';
                    
                    // Animação de pulso no ícone
                    const icon = this.querySelector('span:first-child');
                    icon.style.animation = 'bounce 0.6s ease-in-out';
                    
                    setTimeout(() => {
                        this.classList.remove('bg-blue-100', 'border-blue-300', 'shadow-lg');
                        this.style.transform = '';
                        icon.style.animation = '';
                    }, 1200);
                });
            });
            
            document.getElementById('newPlanForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const button = document.getElementById('createPlanButton');
                const plan_name = document.getElementById('plan_name').value;
                const exam_date = document.getElementById('exam_date').value;
                
                // Capturar preferências de email como booleanos
                const email_daily_schedule = document.getElementById('email_daily_schedule').checked;
                const email_weekly_summary = document.getElementById('email_weekly_summary').checked;
                const email_study_reminders = document.getElementById('email_study_reminders').checked;

                button.disabled = true;
                button.innerHTML = '<span class="flex items-center justify-center"><div class="loading-spinner rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-3"></div>Criando seu plano...</span>';
                app.showSpinner();

                try {
                    const data = await app.apiFetch('/api/plans', {
                        method: 'POST',
                        body: JSON.stringify({
                            plan_name, 
                            exam_date,
                            email_daily_schedule: email_daily_schedule ? 1 : 0,
                            email_weekly_summary: email_weekly_summary ? 1 : 0,
                            email_study_reminders: email_study_reminders ? 1 : 0,
                            has_essay: 0,
                            reta_final_mode: 0
                        })
                    });
                    
                    // Feedback de sucesso antes da transição
                    button.innerHTML = '<span class="flex items-center justify-center text-white"><span class="mr-3">✓</span>✨ Plano criado! Redirecionando...</span>';
                    button.classList.add('bg-green-500', 'hover:bg-green-600');
                    button.style.transform = 'scale(1.02)';
                    
                    setTimeout(() => {
                        window.location.href = `plan_settings.html?id=${data.newPlanId}&new=true&guide=true`;
                    }, 1200);
                } catch (error) {
                    app.showToast(error.message, 'error');
                    button.disabled = false;
                    button.innerHTML = '<span class="flex items-center justify-center"><span class="mr-3">✨</span>Criar Meu Plano!<span class="ml-3 transform group-hover:translate-x-1 transition-transform">→</span></span>';
                    button.classList.remove('bg-green-500', 'hover:bg-green-600');
                    app.hideSpinner();
                }
            });
            
            document.getElementById('cancelDeleteButton').addEventListener('click', closeDeleteModal);
            document.getElementById('confirmDeleteButton').addEventListener('click', confirmDelete);
            deleteModal.addEventListener('click', (event) => {
                if (event.target === deleteModal) closeDeleteModal();
            });
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
    
    </div> <!-- End main content wrapper -->
    
    <!-- Script de preferências de email -->
    <script src="js/email-preferences.js"></script>
    
    <!-- Script do rodapé modular -->
    <script src="js/footer.js"></script>
    <!-- O rodapé será inserido automaticamente aqui pelo footer.js -->
</body>
</html>