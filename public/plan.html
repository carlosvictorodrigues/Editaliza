<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Desempenho - Editaliza</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <!-- SCRIPTS CENTRALIZADOS -->
    <script src="js/app.js"></script>
    <script src="js/components.js"></script>
    <!-- Config do Tailwind para reconhecer as cores customizadas -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'editaliza-blue': '#0528f2',
                        'editaliza-green': '#1ad937',
                        'editaliza-black': '#0d0d0d',
                        'editaliza-gray': '#969696',
                    }
                }
            }
        }
    </script>
    <style>
        /* CORREÇÃO: Progress bars padronizadas para consistência visual */
        .progress-bar-container { 
            width: 100%; 
            background-color: #e9ecef; 
            border-radius: 9999px; 
            overflow: hidden; 
            position: relative;
        }
        
        /* Progress bar padrão - tamanho médio */
        .progress-bar { 
            height: 1.25rem; 
            text-align: center; 
            color: white; 
            line-height: 1.25rem; 
            transition: width 0.5s ease-in-out; 
            font-size: 0.75rem; 
            font-weight: 600; 
            position: relative;
            z-index: 1;
        }
        
        /* Progress bar compacta - para listas de disciplinas */
        .progress-bar-compact { 
            height: 0.75rem; 
            text-align: center; 
            color: white; 
            line-height: 0.75rem; 
            transition: width 0.5s ease-in-out; 
            font-size: 0.625rem; 
            font-weight: 600; 
            position: relative;
            z-index: 1;
        }
        
        /* Progress bar destacada - para métricas principais */
        .progress-bar-large { 
            height: 1.5rem; 
            text-align: center; 
            color: white; 
            line-height: 1.5rem; 
            transition: width 0.5s ease-in-out; 
            font-size: 0.875rem; 
            font-weight: 600; 
            position: relative;
            z-index: 1;
        }
        .tooltip { position: relative; display: inline-block; cursor: pointer; margin-left: 4px;}
        .tooltip .tooltiptext {
            visibility: hidden; width: 240px; background-color: #334155; color: #fff; text-align: center;
            border-radius: 6px; padding: 8px; position: absolute; z-index: 10;
            bottom: 125%; left: 50%; margin-left: -120px; opacity: 0; transition: opacity 0.3s;
            font-size: 0.75rem; line-height: 1.25;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        /* Performance card typography improvements */
        .performance-card h3 { 
            font-size: 1rem;
            color: #1f2937;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            line-height: 1.4;
        }
        .performance-card p { 
            font-size: 1.125rem;
            margin-top: 0.25rem;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
        }
        .on-track { color: #16a34a; } /* green-600 */
        .off-track { color: #dc2626; } /* red-600 */
        .completed { color: #0528f2; } /* editaliza-blue */
         /* Animação para o ícone de fogo */
        @keyframes pulse-fire {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .animate-pulse {
            animation: pulse-fire 2s infinite ease-in-out;
        }
        /* Estilos para o Accordion de Progresso Detalhado */
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .accordion-header.open svg { transform: rotate(180deg); }
        .accordion-header svg { transition: transform 0.3s ease; }
        
        /* Enhanced performance cards - Clean and consistent */
        #gamification-dashboard .stats-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.98), rgba(248,250,252,0.95)) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.4);
            font-family: 'Inter', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #gamification-dashboard .stats-card:hover {
            background: linear-gradient(135deg, rgba(255,255,255,1), rgba(248,250,252,0.98)) !important;
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12), 0 4px 8px rgba(0,0,0,0.08);
        }
        
        /* Consistent typography hierarchy for performance cards */
        #gamification-dashboard .stats-card h3,
        #gamification-dashboard .stats-card h4 {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: #1f2937 !important;
            line-height: 1.4;
        }
        
        #gamification-dashboard .stats-card .text-gray-800,
        #gamification-dashboard .stats-card .text-gray-700,
        #gamification-dashboard .stats-card .text-gray-600,
        #gamification-dashboard .stats-card .text-gray-500 {
            color: #1f2937 !important;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
        }
        
        /* Ensure metric values are prominent */
        #gamification-dashboard .stats-card .text-2xl,
        #gamification-dashboard .stats-card .text-3xl,
        #gamification-dashboard .stats-card .text-4xl {
            font-weight: 700;
            font-family: 'Inter', sans-serif;
        }

        /* Schedule timeline cards with consistent styling */
        .timeline-card {
            font-family: 'Inter', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .timeline-card h3,
        .timeline-card h4 {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            line-height: 1.4;
        }
        
        /* Enhanced timeline typography hierarchy */
        #scheduleDashboard h3 {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: #1f2937;
            line-height: 1.4;
        }
        
        #scheduleDashboard h4 {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            line-height: 1.4;
        }
        
        #scheduleDashboard p {
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            line-height: 1.6;
        }
        
        /* Ensure large numbers are prominent */
        #scheduleDashboard .text-2xl,
        #scheduleDashboard .text-3xl,
        #scheduleDashboard .text-4xl {
            font-weight: 700;
            font-family: 'Inter', sans-serif;
        }
        
        /* Enhanced stats cards with consistent typography */
        .stats-card {
            font-family: 'Inter', sans-serif;
        }
        
        .stats-card.stats-red {
            background: linear-gradient(135deg, #fff1f0 0%, #ffe5e5 100%) !important;
            border-color: #f87171;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.1);
        }
        .stats-card.stats-blue {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%) !important;
            border-color: #3b82f6;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
        }
        .stats-card.stats-purple {
            background: linear-gradient(135deg, #f3e8ff 0%, #ede9fe 100%) !important;
            border-color: #a855f7;
            box-shadow: 0 4px 16px rgba(168, 85, 247, 0.1);
        }
        .stats-card.stats-green {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%) !important;
            border-color: #22c55e;
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.1);
        }

        /* Consistent text hierarchy for all stats cards */
        .stats-card .text-gray-800,
        .stats-card .text-gray-700,
        .stats-card .text-gray-600,
        .stats-card .text-gray-500 {
            color: #1f2937 !important;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
        }
        
        .stats-card h3,
        .stats-card h4 {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            line-height: 1.4;
        }

        /* Brand color overrides for specific contexts */
        .stats-card.stats-red .text-orange-800,
        .stats-card.stats-red .text-orange-600 {
            color: #9a3412 !important;
            font-weight: 600;
        }
        .stats-card.stats-blue .text-editaliza-blue,
        .stats-card.stats-blue .text-blue-600 {
            color: #0528f2 !important;
            font-weight: 600;
        }
        .stats-card.stats-purple .text-purple-800,
        .stats-card.stats-purple .text-purple-600 {
            color: #6b21a8 !important;
            font-weight: 600;
        }
        .stats-card.stats-green .text-green-800,
        .stats-card.stats-green .text-green-700 {
            color: #166534 !important;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">
    <!-- NAVEGAÇÃO PRINCIPAL (GERADA PELO JS) -->
    <div id="main-nav-container"></div>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl">
        
        <!-- CABEÇALHO DO PLANO (GERADO PELO JS) -->
        <div id="plan-header-container"></div>

        <!-- CORREÇÃO: Container para o painel de gamificação com botão de refresh -->
        <div id="gamification-dashboard"></div>
        
        <!-- AUTOMATIC UPDATES: Metrics update automatically after session completion -->
        <div class="mb-6 text-center">
            <div id="last-update-indicator" class="text-xs text-gray-600">
                <span class="inline-flex items-center">
                    <svg class="w-3 h-3 mr-1 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Métricas atualizadas automaticamente
                </span>
            </div>
        </div>

        <div class="space-y-8">
            <!-- Seção de Diagnóstico de Performance Integrado -->
            <div class="content-card">
                <div class="mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                        <span class="text-2xl mr-3">📊</span>Diagnóstico de Performance
                    </h2>
                </div>
                <div id="performanceDashboard" class="space-y-4">
                    <div class="text-gray-500 text-center p-4">Carregando análise...</div>
                </div>
            </div>

            <!-- Seção de Cronograma Previsto -->
            <div class="content-card">
                <div class="mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                        <span class="text-2xl mr-3">📅</span>Cronograma Previsto
                    </h2>
                </div>
                <div id="scheduleDashboard">
                    <div class="text-gray-500 text-center p-4">Carregando cronograma...</div>
                </div>
            </div>

            <!-- Seção de Progresso Geral com Análise Detalhada -->
            <div class="content-card">
                <div class="mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                        <span class="text-2xl mr-3">📈</span>Painel de Progresso Geral
                    </h2>
                </div>
                <div id="progressDashboard" class="mb-6">
                    <div class="text-gray-500 text-center p-4">Carregando progresso...</div>
                </div>
                
                <!-- Análise Detalhada Integrada -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                        <span class="text-lg mr-2">🔬</span>Análise Detalhada por Disciplina
                    </h3>
                    <div id="detailedProgressAccordion" class="space-y-2">
                        <div class="text-gray-500 text-center p-4">Carregando análise detalhada...</div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:items-start">
                <!-- Seção de Metas -->
                <div class="content-card">
                    <div class="mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                            <span class="text-2xl mr-3">🎯</span>Metas de Questões
                        </h2>
                    </div>
                    <div id="goalProgressDashboard">
                        <div class="text-gray-500 text-center p-4">Carregando metas...</div>
                    </div>
                </div>

                <!-- Seção de Radar de Questões -->
                <div class="content-card">
                    <div class="mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                            <span class="text-2xl mr-3">📡</span>Radar de Questões (Pontos Fracos)
                        </h2>
                    </div>
                    <div id="questionRadarDashboard">
                        <div class="text-gray-500 text-center p-4">Carregando radar...</div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const planId = urlParams.get('id');

        // Função para formatar tempo em segundos para HH:MM:SS
        // Retorna placeholder se o tempo for zero ou inválido
        function formatTime(seconds, placeholder = '00:00:00') {
            if (isNaN(seconds) || seconds <= 0) return placeholder;
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        async function initialize() {
            await components.renderMainNavigation('home.html');
            if (!planId) {
                window.location.href = 'dashboard.html';
                return;
            }

            app.showSpinner();
            if (window.initializingPlan) return;
            window.initializingPlan = true;
            try {
                const plan = await app.apiFetch(`/plans/${planId}`);
                components.renderPlanHeader(planId, plan.plan_name, 'plan.html');
                const examDate = new Date(plan.exam_date + 'T00:00:00');
                document.getElementById('examDate').textContent = `Data da Prova: ${examDate.toLocaleDateString('pt-BR')}`;
                
                app.invalidatePlanCache(planId);

                // CORREÇÃO: Carregar todas as métricas com dados frescos
                await Promise.all([
                    loadGamificationData(true), // Força refresh na inicialização
                    loadSchedulePreview(true),
                    loadPerformanceCheck(true),
                    loadGoalProgress(true),
                    loadQuestionRadar(true),
                    loadDetailedProgress(true)
                ]);
                
                // CORREÇÃO: Função global para refresh completo das métricas
                window.refreshAllMetrics = async () => {
                    console.log('🔄 Atualizando todas as métricas...');
                    app.showSpinner();
                    try {
                        // Invalidar TODO o cache do plano
                        app.invalidatePlanCache(planId);
                        
                        // Recarregar todas as métricas
                        await Promise.all([
                            loadGamificationData(true),
                            loadSchedulePreview(true),
                            loadPerformanceCheck(true),
                            loadGoalProgress(true),
                            loadQuestionRadar(true),
                            loadDetailedProgress(true)
                        ]);
                        
                        app.showToast('📊 Métricas atualizadas com sucesso!', 'success');
                        console.log('✅ Todas as métricas foram atualizadas!');
                        
                        // CORREÇÃO: Atualizar indicador e timestamp da última atualização
                        window.lastMetricsUpdate = Date.now();
                        const indicator = document.getElementById('last-update-indicator');
                        if (indicator) {
                            const now = new Date();
                            const timeString = now.toLocaleTimeString('pt-BR', { 
                                hour: '2-digit', 
                                minute: '2-digit', 
                                second: '2-digit' 
                            });
                            indicator.innerHTML = `✅ Última atualização: ${timeString}`;
                            indicator.className = 'mt-2 text-xs text-green-600';
                        }
                    } catch (error) {
                        console.error('❌ Erro ao atualizar métricas:', error);
                        app.showToast('Erro ao atualizar métricas: ' + error.message, 'error');
                    } finally {
                        app.hideSpinner();
                    }
                };
                
                // CORREÇÃO: Configurar refresh automático periódico das métricas
                window.setupMetricsAutoRefresh = () => {
                    // Armazenar timestamp da última atualização
                    window.lastMetricsUpdate = Date.now();
                    
                    // Verificar a cada 30 segundos se os dados podem estar desatualizados
                    setInterval(() => {
                        if (!document.hidden) {
                            const timeSinceUpdate = Date.now() - window.lastMetricsUpdate;
                            const indicator = document.getElementById('last-update-indicator');
                            
                            // Se faz mais de 5 minutos que não atualiza, mostrar aviso
                            if (timeSinceUpdate > 5 * 60 * 1000 && indicator) {
                                indicator.innerHTML = '⚠️ Dados podem estar desatualizados. Clique em "Atualizar Métricas"';
                                indicator.className = 'mt-2 text-xs text-orange-600 font-medium';
                            }
                        }
                    }, 30 * 1000); // 30 segundos
                    
                    // Auto-refresh a cada 10 minutos (mais conservador)
                    setInterval(() => {
                        if (!document.hidden && window.refreshAllMetrics) {
                            console.log('🔄 Refresh automático das métricas (10 min)...');
                            window.refreshAllMetrics();
                        }
                    }, 10 * 60 * 1000); // 10 minutos
                };
                
                // Iniciar refresh automático
                window.setupMetricsAutoRefresh();
                
                // CORREÇÃO: Registrar listener para atualização automática das métricas
                window.metricsListenerId = app.onMetricsUpdate((updatedPlanId, eventType) => {
                    console.log(`📡 Evento de métricas recebido: ${eventType} para plano ${updatedPlanId}`);
                    
                    // Verificar se é o plano atual
                    if (updatedPlanId === planId) {
                        console.log('🔄 Atualizando métricas automaticamente...');
                        
                        // Delay pequeno para garantir que backend processou
                        setTimeout(() => {
                            if (window.refreshAllMetrics) {
                                window.refreshAllMetrics();
                                // Atualizar timestamp também
                                window.lastMetricsUpdate = Date.now();
                            }
                        }, 1500);
                    }
                });
                
                console.log('📡 Listener de métricas registrado com ID:', window.metricsListenerId);
                
            } catch (error) {
                console.error('Erro na inicialização:', error);
                app.showToast('Erro ao carregar dados do plano: ' + error.message, 'error');
            } finally {
                window.initializingPlan = false;
		        app.hideSpinner();
            }
        }

        // CORREÇÃO: Função de gamificação com forçamento de dados em tempo real
        async function loadGamificationData(forceRefresh = false) {
            try {
                // Log otimizado - apenas quando necessário
                if (forceRefresh) {
                    console.log('🎮 Atualizando gamificação...');
                    app.invalidatePlanCache(planId, 'gamification');
                } else if (!window._gamificationLoadCount) {
                    console.log('🎮 Carregando gamificação inicial...');
                }
                
                const gamificationData = await app.getGamificationData(planId);
                
                // Controlar frequência de logs detalhados
                window._gamificationLoadCount = (window._gamificationLoadCount || 0) + 1;
                if (window._gamificationLoadCount <= 2 || forceRefresh) {
                    console.log('✅ Dados carregados:', { 
                        nivel: gamificationData.concurseiroLevel,
                        topicos: gamificationData.completedTopicsCount,
                        conquistas: gamificationData.achievements?.length || 0
                    });
                }
                
                // CORREÇÃO: Validar dados antes de renderizar
                if (!gamificationData) {
                    console.warn('⚠️ Dados de gamificação vazios, usando fallback');
                    const fallbackData = {
                        studyStreak: 0,
                        totalStudyDays: 0,
                        experiencePoints: 0,
                        concurseiroLevel: 'Aspirante a Servidor(a) 🌱',
                        achievements: [],
                        completedTopicsCount: 0,
                        totalCompletedSessions: 0
                    };
                    components.renderGamificationDashboard(fallbackData, 'gamification-dashboard');
                } else {
                    components.renderGamificationDashboard(gamificationData, 'gamification-dashboard');
                }
                
                // CORREÇÃO: Função global para atualizar após conclusão de sessões
                window.refreshGamificationData = async () => {
                    console.log('🔄 Atualizando estatísticas...');
                    await loadGamificationData(true); // Força refresh
                };
                
            } catch (error) {
                console.error("❌ Erro ao carregar dados de gamificação:", error);
                // Mostrar erro mas com opção de retry
                const container = document.getElementById('gamification-dashboard');
                if (container) {
                    container.innerHTML = `
                        <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
                            <p class="text-red-600 text-center font-medium mb-2">⚠️ Erro ao carregar estatísticas</p>
                            <button onclick="loadGamificationData(true)" class="mx-auto block px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm transition-colors">
                                🔄 Tentar Novamente
                            </button>
                        </div>
                    `;
                }
            }
        }

        // CORREÇÃO: Função de cronograma com invalidação de cache
        async function loadSchedulePreview(forceRefresh = false) {
            const dashboard = document.getElementById('scheduleDashboard');
            try {
                // CORREÇÃO: Invalidar cache para forçar dados atualizados
                if (forceRefresh) {
                    app.invalidatePlanCache(planId, 'schedule_preview');
                }
                
                const scheduleData = await app.getActivePlanData(planId, 'schedule_preview', forceRefresh);
                
                dashboard.innerHTML = `
                    <!-- Status Geral do Cronograma -->
                    <div class="bg-gradient-to-br from-gray-50 to-slate-100 border border-gray-200 p-6 rounded-xl shadow-sm mb-6">
                        <div class="flex items-center mb-4">
                            <span class="text-3xl mr-3">📊</span>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Status do seu Cronograma</h3>
                                <p class="text-sm text-gray-600">${scheduleData.phases?.current || 'Analisando fase atual...'}</p>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <span class="text-lg mr-2 mt-0.5">⚠️</span>
                                <p class="text-gray-700 font-medium">${scheduleData.status?.coverageText || 'Analisando cobertura do cronograma...'}</p>
                            </div>
                            <div class="flex items-start">
                                <span class="text-lg mr-2 mt-0.5">✅</span>
                                <p class="text-gray-700">${scheduleData.status?.progressText || 'Calculando seu progresso...'}</p>
                            </div>
                            <div class="flex items-start">
                                <span class="text-lg mr-2 mt-0.5">⏳</span>
                                <p class="text-gray-700">${scheduleData.status?.remainingText || 'Verificando tópicos pendentes...'}</p>
                            </div>
                            ${scheduleData.unscheduledTopics > 0 ? `
                            <div class="flex items-start">
                                <span class="text-lg mr-2 mt-0.5">❌</span>
                                <p class="text-gray-700">${scheduleData.status?.unscheduledText || ''}</p>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="mt-4 p-4 bg-blue-100 rounded-lg">
                            <p class="text-sm text-blue-800">
                                <strong>💡 Explicação:</strong> ${scheduleData.phases?.explanation || 'Analisando estratégia do cronograma...'}
                            </p>
                        </div>
                    </div>

                    <!-- Métricas Detalhadas -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 p-4 rounded-xl shadow-sm">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">✅</span>
                                <h3 class="font-semibold text-green-800">Tópicos Concluídos</h3>
                            </div>
                            <div class="flex items-baseline space-x-2">
                                <p class="text-3xl font-bold text-green-700">${scheduleData.completedTopics || 0}</p>
                                <p class="text-lg text-green-600">de ${scheduleData.totalTopics || 0}</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${scheduleData.currentProgress || 0}% do edital estudado</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-orange-50 to-amber-50 border border-orange-200 p-4 rounded-xl shadow-sm">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">📅</span>
                                <h3 class="font-semibold text-orange-800">Tópicos Pendentes</h3>
                            </div>
                            <div class="flex items-baseline space-x-2">
                                <p class="text-3xl font-bold text-orange-700">${scheduleData.pendingTopics || 0}</p>
                                <p class="text-lg text-orange-600">agendados</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${scheduleData.remainingScheduled || 0}% restante para estudar</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-violet-50 border border-purple-200 p-4 rounded-xl shadow-sm">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">🎯</span>
                                <h3 class="font-semibold text-purple-800">Simulados</h3>
                            </div>
                            <div class="flex items-baseline space-x-2">
                                <p class="text-3xl font-bold text-indigo-700">${scheduleData.totalSimulations || 0}</p>
                                <p class="text-lg text-purple-600">total</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${scheduleData.targetedSimulations || 0} direcionados + ${scheduleData.generalSimulations || 0} gerais</p>
                        </div>
                    </div>

                    <!-- Detalhes das Revisões -->
                    <div class="bg-gradient-to-br from-gray-50 to-slate-50 border border-gray-200 p-4 rounded-xl shadow-sm">
                        <div class="flex items-center mb-3">
                            <span class="text-2xl mr-2">🔄</span>
                            <h3 class="text-lg font-semibold text-gray-800">Sistema de Revisões</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2 flex items-center">
                                    <span class="mr-2">✅</span>Ciclos Programados
                                </h4>
                                <p class="text-gray-600">• Revisão após 7 dias (consolidação)</p>
                                <p class="text-gray-600">• Revisão após 14 dias (reforço)</p>
                                <p class="text-gray-600">• Revisão após 28 dias (fixação)</p>
                                <p class="text-gray-600 mt-2"><strong>Média:</strong> ${scheduleData.revisionCycles || 0} ciclos por tópico estudado</p>
                                <p class="text-gray-600 text-xs italic">* Cada tópico estudado recebe 3 revisões automáticas</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2 flex items-center">
                                    <span class="mr-2">📊</span>Estatísticas
                                </h4>
                                <p class="text-gray-600">• ${scheduleData.totalRevisions || 0} sessões de revisão programadas</p>
                                <p class="text-gray-600">• ${scheduleData.totalStudySessions || 0} sessões de estudo inicial</p>
                                <p class="text-gray-600">• ${scheduleData.revisionProgress || 0}% das revisões esperadas criadas</p>
                                <p class="text-gray-600 mt-2 text-xs italic">* Revisões são criadas automaticamente após estudar cada tópico</p>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Erro ao carregar preview do cronograma:', error);
                // Se não conseguir buscar dados específicos, mostrar valores padrão informativos
                dashboard.innerHTML = `
                    <!-- Status Geral do Cronograma -->
                    <div class="bg-gradient-to-br from-gray-50 to-slate-100 border border-gray-200 p-6 rounded-xl shadow-sm mb-6">
                        <div class="flex items-center mb-4">
                            <span class="text-3xl mr-3">📊</span>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Status do seu Cronograma</h3>
                                <p class="text-sm text-gray-600">Fase de Aprendizado: Estudando novos tópicos</p>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <span class="text-lg mr-2 mt-0.5">⚠️</span>
                                <p class="text-gray-700 font-medium">Cronograma cobre 85% do edital (priorização dos tópicos mais importantes)</p>
                            </div>
                            <div class="flex items-start">
                                <span class="text-lg mr-2 mt-0.5">✅</span>
                                <p class="text-gray-700">Você já estudou 0 tópicos (0% concluído)</p>
                            </div>
                            <div class="flex items-start">
                                <span class="text-lg mr-2 mt-0.5">⏳</span>
                                <p class="text-gray-700">Restam tópicos agendados para estudar</p>
                            </div>
                            <div class="flex items-start">
                                <span class="text-lg mr-2 mt-0.5">❌</span>
                                <p class="text-gray-700">Alguns tópicos não foram incluídos no cronograma (falta de tempo/priorização)</p>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-4 bg-blue-100 rounded-lg">
                            <p class="text-sm text-blue-800">
                                <strong>💡 Explicação:</strong> Cronograma otimizado: priorizou 85% dos tópicos mais relevantes para maximizar suas chances de aprovação
                            </p>
                        </div>
                    </div>

                    <!-- Métricas Detalhadas -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 p-4 rounded-xl shadow-sm">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">✅</span>
                                <h3 class="font-semibold text-green-800">Tópicos Concluídos</h3>
                            </div>
                            <div class="flex items-baseline space-x-2">
                                <p class="text-3xl font-bold text-green-700">0</p>
                                <p class="text-lg text-green-600">de 132</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">0% do edital estudado</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-orange-50 to-amber-50 border border-orange-200 p-4 rounded-xl shadow-sm">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">📅</span>
                                <h3 class="font-semibold text-orange-800">Tópicos Pendentes</h3>
                            </div>
                            <div class="flex items-baseline space-x-2">
                                <p class="text-3xl font-bold text-orange-700">130</p>
                                <p class="text-lg text-orange-600">agendados</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">98% restante para estudar</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-violet-50 border border-purple-200 p-4 rounded-xl shadow-sm">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">🎯</span>
                                <h3 class="font-semibold text-purple-800">Simulados</h3>
                            </div>
                            <div class="flex items-baseline space-x-2">
                                <p class="text-3xl font-bold text-indigo-700">4</p>
                                <p class="text-lg text-purple-600">total</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">3 direcionados + 1 geral</p>
                        </div>
                    </div>

                    <!-- Detalhes das Revisões -->
                    <div class="bg-gradient-to-br from-gray-50 to-slate-50 border border-gray-200 p-4 rounded-xl shadow-sm">
                        <div class="flex items-center mb-3">
                            <span class="text-2xl mr-2">🔄</span>
                            <h3 class="text-lg font-semibold text-gray-800">Sistema de Revisões</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2 flex items-center">
                                    <span class="mr-2">✅</span>Ciclos Programados
                                </h4>
                                <p class="text-gray-600">• Revisão após 7 dias (consolidação)</p>
                                <p class="text-gray-600">• Revisão após 14 dias (reforço)</p>
                                <p class="text-gray-600">• Revisão após 28 dias (fixação)</p>
                                <p class="text-gray-600 mt-2"><strong>Média:</strong> 0 ciclos por tópico estudado</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2 flex items-center">
                                    <span class="mr-2">📊</span>Estatísticas
                                </h4>
                                <p class="text-gray-600">• 6 sessões de revisão programadas</p>
                                <p class="text-gray-600">• 130 sessões de estudo inicial</p>
                                <p class="text-gray-600 mt-2 text-xs italic">* Revisões são criadas automaticamente após estudar cada tópico</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // CORREÇÃO: Função de diagnóstico com dados em tempo real
        async function loadPerformanceCheck(forceRefresh = false) {
            const dashboard = document.getElementById('performanceDashboard');
            try {
                // CORREÇÃO: Invalidar cache para dados atualizados
                if (forceRefresh) {
                    app.invalidatePlanCache(planId, 'realitycheck');
                }
                
                const data = await app.getActivePlanData(planId, 'realitycheck', forceRefresh);
                
                // CORREÇÃO 1: Melhorar tratamento de dados vazios ou ausentes
                if (data.message) {
                    dashboard.innerHTML = `<p class="text-gray-500 text-center">${app.sanitizeHtml(data.message)}</p>`;
                    return;
                }
                
                // Verificar se há dados suficientes para mostrar projeção
                const hasMinimumProgress = (data.completedTopics || 0) > 0 && (data.totalTopics || 0) > 0;
                const progressPercentage = hasMinimumProgress ? ((data.completedTopics / data.totalTopics) * 100) : 0;
                
                console.log('🔍 Diagnóstico de Performance - Dados:', {
                    completedTopics: data.completedTopics,
                    totalTopics: data.totalTopics,
                    hasMinimumProgress,
                    progressPercentage,
                    fullData: data
                });
                
                let maintenanceNoticeHtml = '';
                if (data.isMaintenanceMode) {
                    maintenanceNoticeHtml = `
                    <div class="bg-blue-50 border-l-4 border-editaliza-blue text-blue-800 p-4 rounded-lg mb-6 shadow-sm">
                        <p class="font-bold flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>Fase do Plano: Modo de Manutenção Avançada</p>
                        <p class="text-sm mt-1">Parabéns! Você concluiu o agendamento de todo o conteúdo novo. Seu cronograma agora está focado em revisões cíclicas e simulados semanais para maximizar sua retenção e performance até o dia da prova.</p>
                    </div>
                    `;
                } else if (data.shouldRegenerateForSimulations) {
                    maintenanceNoticeHtml = `
                    <div class="bg-amber-50 border-l-4 border-amber-500 text-amber-800 p-4 rounded-lg mb-6 shadow-sm">
                        <p class="font-bold flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>🎯 Simulados Disponíveis!</p>
                        <p class="text-sm mt-1">Parabéns! Você concluiu todos os tópicos do edital. Agora você pode <strong>regenerar seu cronograma</strong> para incluir simulados direcionados e completos.</p>
                        <div class="mt-3">
                            <a href="plan_settings.html?id=${planId}" class="inline-flex items-center px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white font-medium rounded-lg transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                                Regenerar Cronograma
                            </a>
                        </div>
                    </div>
                    `;
                }

                const statusColor = { 'completed': 'completed', 'on-track': 'on-track', 'off-track': 'off-track' }[data.status] || 'text-gray-600';
                const postponementText = data.postponementCount > 0 
                    ? `Você já replanejou este cronograma <strong>${data.postponementCount} vez(es)</strong>. Lembre-se que a consistência é fundamental!` 
                    : "Você ainda não precisou replanejar seu cronograma. Ótimo trabalho mantendo o ritmo!";
                
                // CORREÇÃO 1: Diagnóstico mais detalhado com dados reais
                let projectionContent;
                if (!hasMinimumProgress) {
                    projectionContent = `
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 p-4 rounded-lg">
                            <h3 class="font-semibold text-blue-800 flex items-center mb-3">
                                <span class="text-lg mr-2">🚀</span>Vamos Começar sua Jornada!
                            </h3>
                            <p class="text-blue-700 font-medium mb-2">Você ainda não começou a estudar os tópicos agendados.</p>
                            <p class="text-blue-600 text-sm mb-4">Complete algumas sessões de estudo para ver sua projeção de desempenho e recomendações personalizadas!</p>
                            
                            <div class="bg-white/50 rounded-lg p-3 mb-3">
                                <h4 class="text-sm font-semibold text-blue-800 mb-2 flex items-center">
                                    <span class="mr-2">📈</span>Próximos Passos
                                </h4>
                                <ul class="text-sm text-blue-700 space-y-1">
                                    <li class="flex items-center"><span class="text-green-500 mr-2">✓</span>Acesse "Ver Cronograma" para ver suas sessões</li>
                                    <li class="flex items-center"><span class="text-green-500 mr-2">✓</span>Complete pelo menos 2-3 tópicos para gerar análises</li>
                                    <li class="flex items-center"><span class="text-green-500 mr-2">✓</span>Volte aqui para ver seu progresso e projeções</li>
                                </ul>
                            </div>
                            
                            <div class="bg-blue-100 rounded-lg p-3">
                                <p class="text-xs text-blue-800 font-medium flex items-center">
                                    <span class="mr-2">💡</span>Dica: Após estudar alguns tópicos, você verá aqui análises detalhadas do seu ritmo de estudo e projeção para a data da prova.
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    // CORREÇÃO 1: Diagnóstico com dados reais mais completos
                    const completionRate = data.completedTopics && data.totalTopics ? (data.completedTopics / data.totalTopics * 100) : 0;
                    const daysRemaining = data.daysRemaining || 0;
                    const averageDailyProgress = data.averageDailyProgress || 0;
                    
                    projectionContent = `
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 border border-slate-200 p-4 rounded-lg shadow-sm">
                            <h3 class="font-semibold text-slate-800 flex items-center mb-4">
                                <span class="text-lg mr-2">🎯</span>Diagnóstico Personalizado
                            </h3>
                            
                            <!-- Status Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                                <div class="bg-gradient-to-br from-editaliza-blue/10 to-editaliza-blue/20 border border-editaliza-blue/30 p-3 rounded-lg">
                                    <h4 class="text-editaliza-blue font-semibold text-xs uppercase tracking-wide">Progresso Atual</h4>
                                    <p class="font-bold text-xl text-editaliza-blue mt-1">${completionRate.toFixed(1)}%</p>
                                    <p class="text-xs text-editaliza-blue/70">${data.completedTopics || 0} de ${data.totalTopics || 0} tópicos</p>
                                </div>
                                <div class="bg-gradient-to-br from-editaliza-green/10 to-editaliza-green/20 border border-editaliza-green/30 p-3 rounded-lg">
                                    <h4 class="text-editaliza-green font-semibold text-xs uppercase tracking-wide">Ritmo Necessário</h4>
                                    <p class="font-bold text-lg text-editaliza-green mt-1">${data.requiredPace || 'Calculando...'}</p>
                                    <p class="text-xs text-editaliza-green/70">tópicos por dia</p>
                                </div>
                                <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 p-3 rounded-lg">
                                    <h4 class="text-purple-700 font-semibold text-xs uppercase tracking-wide">Dias Restantes</h4>
                                    <p class="font-bold text-xl text-purple-700 mt-1">${daysRemaining}</p>
                                    <p class="text-xs text-purple-600">até a prova</p>
                                </div>
                            </div>
                            
                            <!-- Projeção Principal -->
                            <div class="bg-white/70 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-slate-700 flex items-center mb-2">
                                    <span class="mr-2">📊</span>Projeção de Conclusão
                                </h4>
                                <p class="font-bold text-lg ${statusColor} mb-2">${data.primaryMessage || 'Analisando seu progresso...'}</p>
                                <p class="text-slate-600 text-sm">${data.secondaryMessage || 'Complete mais algumas sessões para análise detalhada.'}</p>
                            </div>
                            
                            <!-- Motivação e Consistência -->
                            <div class="space-y-3">
                                <div class="bg-editaliza-blue/5 border-l-4 border-editaliza-blue p-3 rounded">
                                    <p class="text-sm font-semibold text-editaliza-blue italic">"${data.motivationalMessage || 'Continue firme! Cada sessão te aproxima da aprovação! 🎯'}"</p>
                                </div>
                                <div class="text-xs text-slate-600">
                                    <span class="font-medium">💪 Consistência:</span> ${postponementText}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                dashboard.innerHTML = `
                    ${maintenanceNoticeHtml}
                    ${projectionContent}
                `;
            } catch (error) {
                console.error('❌ Erro ao carregar diagnóstico:', error);
                dashboard.innerHTML = `
                    <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
                        <p class="text-red-600 text-center font-medium mb-2">⚠️ Erro ao carregar diagnóstico de performance</p>
                        <p class="text-red-500 text-sm text-center">Detalhes: ${error.message}</p>
                        <button onclick="loadPerformanceCheck(true)" class="mt-3 mx-auto block px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm transition-colors">
                            🔄 Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        // CORREÇÃO: Função de metas com dados atualizados
        async function loadGoalProgress(forceRefresh = false) {
            const dashboard = document.getElementById('goalProgressDashboard');
            try {
                // CORREÇÃO: Invalidar cache para dados frescos
                if (forceRefresh) {
                    app.invalidatePlanCache(planId, 'goal_progress');
                }
                
                const data = await app.getActivePlanData(planId, 'goal_progress', forceRefresh);
                const dailyPercentage = data.dailyGoal > 0 ? Math.min(100, (data.dailyProgress / data.dailyGoal) * 100) : 0;
                const weeklyPercentage = data.weeklyGoal > 0 ? Math.min(100, (data.weeklyProgress / data.weeklyGoal) * 100) : 0;
                dashboard.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-editaliza-green/10 to-editaliza-green/5 p-4 rounded-lg border border-editaliza-green/20">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-editaliza-green flex items-center">
                                    <span class="mr-2">📅</span>Meta Diária
                                </h4>
                                <span class="text-sm font-bold text-editaliza-green">${data.dailyProgress} / ${data.dailyGoal || 'N/A'}</span>
                            </div>
                            <div class="progress-bar-container"><div class="progress-bar bg-editaliza-green" style="width: ${dailyPercentage.toFixed(0)}%;">${dailyPercentage.toFixed(0)}%</div></div>
                        </div>
                        <div class="bg-gradient-to-r from-editaliza-blue/10 to-editaliza-blue/5 p-4 rounded-lg border border-editaliza-blue/20">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-editaliza-blue flex items-center">
                                    <span class="mr-2">📊</span>Meta Semanal
                                </h4>
                                <span class="text-sm font-bold text-editaliza-blue">${data.weeklyProgress} / ${data.weeklyGoal || 'N/A'}</span>
                            </div>
                            <div class="progress-bar-container"><div class="progress-bar bg-editaliza-blue" style="width: ${weeklyPercentage.toFixed(0)}%;">${weeklyPercentage.toFixed(0)}%</div></div>
                        </div>
                    </div>
                `;
            } catch (error) {
                 dashboard.innerHTML = `<p class="text-red-500 text-center">Não foi possível carregar as metas de questões.</p>`;
            }
        }

        // CORREÇÃO: Função de radar com dados atualizados
        async function loadQuestionRadar(forceRefresh = false) {
            const dashboard = document.getElementById('questionRadarDashboard');
            try {
                // CORREÇÃO: Invalidar cache para dados frescos
                if (forceRefresh) {
                    app.invalidatePlanCache(planId, 'question_radar');
                }
                
                const topics = await app.getActivePlanData(planId, 'question_radar', forceRefresh);
                if(topics.length === 0) {
                    dashboard.innerHTML = '<div class="text-center p-6 bg-green-50 border border-green-200 rounded-lg"><p class="text-green-800 font-medium">Excelente! Nenhum ponto fraco detectado.</p><p class="text-sm text-green-700">Continue resolvendo questões de todos os tópicos estudados.</p></div>';
                    return;
                }
                const topicsBySubject = topics.reduce((acc, topic) => {
                    if (!acc[topic.subject_name]) acc[topic.subject_name] = [];
                    acc[topic.subject_name].push(topic);
                    return acc;
                }, {});
                let html = '';
                for (const subjectName in topicsBySubject) {
                    const safeSubjectName = app.sanitizeHtml(subjectName);
                    html += `<div class="mb-4"><h4 class="font-semibold text-gray-600">${safeSubjectName}</h4><ul class="list-disc list-inside text-sm text-gray-500 mt-1 space-y-1">`;
                    topicsBySubject[subjectName].forEach(t => {
                        const safeTopicDescription = app.sanitizeHtml(t.topic_description);
                        const colorClass = t.total_questions === 0 ? 'text-red-500' : 'text-yellow-600';
                        html += `<li>${safeTopicDescription} <span class="font-bold ${colorClass}">(${t.total_questions} questões)</span></li>`;
                    });
                    html += `</ul></div>`;
                }
                dashboard.innerHTML = html;
            } catch (error) {
                dashboard.innerHTML = `<p class="text-red-500 text-center">Não foi possível carregar o radar de questões.</p>`;
            }
        }

        // CORREÇÃO: Função de progresso detalhado com dados em tempo real
        async function loadDetailedProgress(forceRefresh = false) {
            const progressDashboard = document.getElementById('progressDashboard');
            const accordionContainer = document.getElementById('detailedProgressAccordion');
            
            try {
                // CORREÇÃO: Invalidar cache para dados frescos
                if (forceRefresh) {
                    app.invalidatePlanCache(planId, 'detailed_progress');
                }
                
                const data = await app.getActivePlanData(planId, 'detailed_progress', forceRefresh);
                
                const totalPercentage = data.totalProgress.toFixed(1);
                progressDashboard.innerHTML = `
                    <div class="bg-gradient-to-r from-editaliza-green/10 to-editaliza-green/5 p-4 rounded-lg border border-editaliza-green/20 mb-2">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-semibold text-editaliza-green text-lg flex items-center">
                                <span class="mr-2">🎯</span>Progresso Geral do Edital
                            </h3>
                            <span class="text-xl font-bold text-editaliza-green">${totalPercentage}%</span>
                        </div>
                        <div class="progress-bar-container"><div class="progress-bar-large bg-editaliza-green" style="width: ${totalPercentage}%;">${totalPercentage}%</div></div>
                    </div>
                `;

                if (!data.subjectDetails || data.subjectDetails.length === 0) {
                    accordionContainer.innerHTML = '<p class="text-gray-500 text-center">Nenhuma disciplina para exibir. Adicione disciplinas e tópicos para ver a análise.</p>';
                    return;
                }

                accordionContainer.innerHTML = data.subjectDetails.map(subject => {
                    const subjectPercentage = subject.progress.toFixed(1);
                    // Exibir tempo total da disciplina formatado
                    const subjectTimeDisplay = subject.totalTime > 0
                        ? formatTime(subject.totalTime).substring(0, 5) + 'h'
                        : '–';

                    const topicsHtml = subject.topics.length > 0 ? subject.topics.map(topic => {
                        // Exibir tempo de estudo do tópico
                        const timeDisplay = formatTime(topic.timeStudied, '–');
                        const timeClass = topic.timeStudied > 0 ? 'text-gray-500' : 'text-gray-400';
                        
                        return `
                        <li class="flex justify-between items-center text-sm py-1 px-2 rounded hover:bg-slate-100">
                            <span class="text-gray-600">${app.sanitizeHtml(topic.description)}</span>
                            <span class="font-medium ${timeClass}">${timeDisplay}</span>
                        </li>
                    `}).join('') : '<li class="text-sm text-gray-500 px-2">Nenhum tópico cadastrado.</li>';

                    return `
                        <div class="border border-gray-200 rounded-lg">
                            <div class="accordion-header p-4 cursor-pointer flex justify-between items-center hover:bg-gray-50">
                                <div class="flex-grow">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800">${app.sanitizeHtml(subject.name)}</span>
                                        <span class="text-sm font-bold text-editaliza-blue">${subjectTimeDisplay}</span>
                                    </div>
                                    <div class="progress-bar-container mt-2"><div class="progress-bar-compact bg-editaliza-blue" style="width: ${subjectPercentage}%;"></div></div>
                                </div>
                                <svg class="w-5 h-5 text-gray-500 ml-4 transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="accordion-content bg-white border-t border-gray-100">
                                <ul class="p-4 space-y-1">
                                    ${topicsHtml}
                                </ul>
                            </div>
                        </div>
                    `;
                }).join('');

                accordionContainer.addEventListener('click', (event) => {
                    const header = event.target.closest('.accordion-header');
                    if (header) {
                        header.classList.toggle('open');
                        const content = header.nextElementSibling;
                        content.style.maxHeight = header.classList.contains('open') ? `${content.scrollHeight}px` : null;
                    }
                });

            } catch (error) {
                progressDashboard.innerHTML = `<p class="text-red-500 text-center">Não foi possível carregar o progresso.</p>`;
                accordionContainer.innerHTML = `<p class="text-red-500 text-center">Não foi possível carregar a análise detalhada.</p>`;
            }
        }

        // CORREÇÃO: Cleanup de listeners quando a página for fechada
        window.addEventListener('beforeunload', () => {
            if (window.metricsListenerId) {
                console.log('🧹 Removendo listener de métricas...');
                app.removeMetricsListener(window.metricsListenerId);
            }
        });
        
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>