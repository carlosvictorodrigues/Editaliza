<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Rotas de Estat√≠sticas - Editaliza</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #333; margin-bottom: 30px; }
        .route-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .route-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }
        .route-card.success { border-color: #28a745; background: #d4edda; }
        .route-card.error { border-color: #dc3545; background: #f8d7da; }
        .route-card.pending { border-color: #ffc107; background: #fff3cd; }
        .route-header {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-badge.success { background: #28a745; color: white; }
        .status-badge.error { background: #dc3545; color: white; }
        .status-badge.pending { background: #ffc107; color: #333; }
        .response-box {
            background: #1a1a1a;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover { background: #5567d8; }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Teste Completo de Rotas de Estat√≠sticas</h1>
        
        <div class="info-box">
            <strong>Instru√ß√µes:</strong> Este teste verifica todas as rotas de estat√≠sticas e dados do sistema.
            <ol style="margin-top: 10px; margin-left: 20px;">
                <li>Fa√ßa login primeiro para obter o token de autentica√ß√£o</li>
                <li>O sistema tentar√° buscar um plano existente ou criar um novo</li>
                <li>Todas as rotas ser√£o testadas automaticamente</li>
            </ol>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button onclick="startTest()" id="startBtn">üöÄ Iniciar Teste Completo</button>
            <button onclick="clearResults()">üóëÔ∏è Limpar Resultados</button>
        </div>

        <div id="status" style="text-align: center; margin: 20px 0; font-size: 18px; font-weight: bold;"></div>

        <div class="route-grid" id="routes-container"></div>
    </div>

    <script>
        let token = null;
        let planId = null;
        const API_URL = 'http://localhost:3000';

        // Lista completa de rotas de estat√≠sticas
        const routes = [
            {
                name: 'Estat√≠sticas Gerais',
                path: '/api/plans/:planId/statistics',
                description: 'Total de dias, sequ√™ncia, progresso geral'
            },
            {
                name: 'Progresso do Plano',
                path: '/api/plans/:planId/progress',
                description: 'Porcentagem de conclus√£o, t√≥picos completados'
            },
            {
                name: 'Progresso da Meta',
                path: '/api/plans/:planId/goal_progress',
                description: 'Progresso em rela√ß√£o √†s metas estabelecidas'
            },
            {
                name: 'Progresso Detalhado',
                path: '/api/plans/:planId/detailed_progress',
                description: 'An√°lise detalhada por disciplina e t√≥pico'
            },
            {
                name: 'Resumo de Atividades',
                path: '/api/plans/:planId/activity_summary',
                description: 'Resumo das atividades de estudo'
            },
            {
                name: 'Verifica√ß√£o de Atrasos',
                path: '/api/plans/:planId/overdue_check',
                description: 'Tarefas atrasadas e pendentes'
            },
            {
                name: 'Dados de Gamifica√ß√£o',
                path: '/api/plans/:planId/gamification',
                description: 'N√≠vel, pontos, conquistas'
            },
            {
                name: 'Cronograma',
                path: '/api/plans/:planId/schedule',
                description: 'Sess√µes de estudo agendadas'
            },
            {
                name: 'Disciplinas',
                path: '/api/plans/:planId/subjects',
                description: 'Lista de disciplinas do plano'
            },
            {
                name: 'Progresso de Compartilhamento',
                path: '/api/plans/:planId/share-progress',
                description: 'Dados para compartilhar progresso'
            }
        ];

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            const colors = {
                info: '#2196f3',
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107'
            };
            statusEl.style.color = colors[type] || '#333';
            statusEl.textContent = message;
        }

        function clearResults() {
            document.getElementById('routes-container').innerHTML = '';
            updateStatus('Resultados limpos', 'info');
        }

        async function startTest() {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            clearResults();
            
            try {
                updateStatus('1Ô∏è‚É£ Fazendo login...', 'info');
                await login();
                
                updateStatus('2Ô∏è‚É£ Buscando ou criando plano...', 'info');
                await getPlan();
                
                updateStatus('3Ô∏è‚É£ Testando todas as rotas...', 'info');
                await testAllRoutes();
                
                updateStatus('‚úÖ Teste completo!', 'success');
            } catch (error) {
                updateStatus(`‚ùå Erro: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function login() {
            const response = await fetch(`${API_URL}/api/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: 'teste@teste.com',
                    password: 'teste123'
                })
            });

            if (!response.ok) {
                throw new Error('Falha no login. Verifique as credenciais.');
            }

            const data = await response.json();
            token = data.token;
        }

        async function getPlan() {
            // Buscar planos existentes
            const response = await fetch(`${API_URL}/api/plans`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const plans = await response.json();
                if (plans.length > 0) {
                    planId = plans[0].id;
                    updateStatus(`Usando plano existente: ID ${planId}`, 'info');
                    return;
                }
            }

            // Criar novo plano se n√£o existir
            const createResponse = await fetch(`${API_URL}/api/plans`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    plan_name: `Teste Estat√≠sticas ${Date.now()}`,
                    exam_date: '2025-12-31',
                    hours_per_day: 4
                })
            });

            if (!createResponse.ok) {
                throw new Error('N√£o foi poss√≠vel criar um plano de teste');
            }

            const data = await createResponse.json();
            planId = data.newPlanId;
            updateStatus(`Novo plano criado: ID ${planId}`, 'success');
        }

        async function testAllRoutes() {
            const container = document.getElementById('routes-container');
            
            for (const route of routes) {
                const card = createRouteCard(route);
                container.appendChild(card);
                await testRoute(route, card);
                await sleep(200); // Pequeno delay entre testes
            }
        }

        function createRouteCard(route) {
            const card = document.createElement('div');
            card.className = 'route-card pending';
            card.innerHTML = `
                <div class="route-header">
                    <span>${route.name}</span>
                    <span class="status-badge pending">TESTANDO...</span>
                </div>
                <div style="margin: 10px 0;">
                    <strong>Rota:</strong> ${route.path.replace(':planId', planId || '[planId]')}<br>
                    <strong>Descri√ß√£o:</strong> ${route.description}
                </div>
                <div class="response-box" style="display: none;"></div>
            `;
            return card;
        }

        async function testRoute(route, card) {
            const statusBadge = card.querySelector('.status-badge');
            const responseBox = card.querySelector('.response-box');
            const path = route.path.replace(':planId', planId);

            try {
                const startTime = Date.now();
                const response = await fetch(`${API_URL}${path}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const elapsed = Date.now() - startTime;

                if (response.ok) {
                    const data = await response.json();
                    card.className = 'route-card success';
                    statusBadge.className = 'status-badge success';
                    statusBadge.textContent = `‚úÖ OK (${elapsed}ms)`;
                    
                    responseBox.style.display = 'block';
                    responseBox.innerHTML = formatJson(data);
                } else {
                    const error = await response.text();
                    card.className = 'route-card error';
                    statusBadge.className = 'status-badge error';
                    statusBadge.textContent = `‚ùå ${response.status}`;
                    
                    responseBox.style.display = 'block';
                    responseBox.innerHTML = `<span style="color: #f66;">Erro: ${error}</span>`;
                }
            } catch (error) {
                card.className = 'route-card error';
                statusBadge.className = 'status-badge error';
                statusBadge.textContent = '‚ùå ERRO';
                
                responseBox.style.display = 'block';
                responseBox.innerHTML = `<span style="color: #f66;">Erro de rede: ${error.message}</span>`;
            }
        }

        function formatJson(data) {
            const json = JSON.stringify(data, null, 2);
            // Limitar tamanho da resposta mostrada
            if (json.length > 500) {
                const preview = json.substring(0, 500);
                const keys = Object.keys(data);
                return `${preview}...\n\n<span style="color: #ff9;">üìä Dados recebidos: ${keys.length} campos</span>`;
            }
            return json;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>