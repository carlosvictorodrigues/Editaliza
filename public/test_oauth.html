<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste OAuth - Editaliza</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background: #357ae8;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Teste de OAuth - Editaliza</h1>
    
    <div class="test-section">
        <h2>Informações do Ambiente</h2>
        <div id="env-info" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>Teste de Login OAuth</h2>
        <button onclick="testOAuthDirect()">Testar OAuth Direto (editaliza.com.br)</button>
        <button onclick="testOAuthCross()">Testar OAuth Cross-Domain (app.editaliza.com.br)</button>
        <div id="oauth-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>Verificar Token</h2>
        <button onclick="checkToken()">Verificar Token Atual</button>
        <div id="token-log" class="log"></div>
    </div>
    
    <script>
        // Mostrar informações do ambiente
        document.getElementById('env-info').innerHTML = `
            <strong>URL Atual:</strong> ${window.location.href}<br>
            <strong>Hostname:</strong> ${window.location.hostname}<br>
            <strong>Protocolo:</strong> ${window.location.protocol}<br>
            <strong>User Agent:</strong> ${navigator.userAgent}<br>
            <strong>Token no LocalStorage:</strong> ${localStorage.getItem('editaliza_token') ? 'Presente' : 'Ausente'}
        `;
        
        // Verificar se há parâmetros de retorno OAuth
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('auth_success')) {
            const token = urlParams.get('token');
            if (token) {
                localStorage.setItem('editaliza_token', token);
                document.getElementById('oauth-log').innerHTML += `
                    <div class="success">✓ OAuth concluído com sucesso!</div>
                    <div>Token recebido: ${token.substring(0, 20)}...</div>
                `;
                // Limpar URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        if (urlParams.has('error')) {
            document.getElementById('oauth-log').innerHTML += `
                <div class="error">✗ Erro no OAuth: ${urlParams.get('error')}</div>
            `;
        }
        
        function testOAuthDirect() {
            const log = document.getElementById('oauth-log');
            log.innerHTML += '<div>Iniciando OAuth direto...</div>';
            
            // Determinar URL base
            const baseUrl = window.location.hostname === 'localhost' 
                ? 'http://localhost:3000' 
                : 'https://editaliza.com.br';
            
            log.innerHTML += `<div>Redirecionando para: ${baseUrl}${baseUrl.includes('localhost') ? '/api' : ''}/auth/google</div>`;
            
            // Redirecionar para OAuth
            window.location.href = `${baseUrl}${baseUrl.includes('localhost') ? '/api' : ''}/auth/google`;
        }
        
        function testOAuthCross() {
            const log = document.getElementById('oauth-log');
            log.innerHTML += '<div>Iniciando OAuth cross-domain...</div>';
            
            // Sempre usar editaliza.com.br para OAuth
            const oauthUrl = 'https://editaliza.com.br/auth/google';
            
            log.innerHTML += `<div>Redirecionando para: ${oauthUrl}</div>`;
            
            // Redirecionar para OAuth
            window.location.href = oauthUrl;
        }
        
        async function checkToken() {
            const log = document.getElementById('token-log');
            const token = localStorage.getItem('editaliza_token');
            
            if (!token) {
                log.innerHTML = '<div class="error">Nenhum token encontrado no localStorage</div>';
                return;
            }
            
            log.innerHTML = '<div>Verificando token...</div>';
            
            try {
                // Decodificar token JWT (sem verificar assinatura)
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Token JWT inválido');
                }
                
                const payload = JSON.parse(atob(parts[1]));
                
                log.innerHTML += `
                    <div class="success">Token válido!</div>
                    <div><strong>ID do usuário:</strong> ${payload.id}</div>
                    <div><strong>Email:</strong> ${payload.email}</div>
                    <div><strong>Emissor:</strong> ${payload.iss}</div>
                    <div><strong>Expira em:</strong> ${new Date(payload.exp * 1000).toLocaleString()}</div>
                `;
                
                // Testar token com API
                const baseUrl = window.location.hostname === 'localhost' 
                    ? 'http://localhost:3000' 
                    : 'https://editaliza.com.br';
                
                const response = await fetch(`${baseUrl}/auth/verify`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log.innerHTML += '<div class="success">✓ Token verificado com sucesso pela API!</div>';
                } else {
                    log.innerHTML += `<div class="error">✗ API rejeitou o token: ${response.status}</div>`;
                }
                
            } catch (error) {
                log.innerHTML += `<div class="error">Erro ao verificar token: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>