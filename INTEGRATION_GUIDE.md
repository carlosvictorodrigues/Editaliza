# üöÄ GUIA DE INTEGRA√á√ÉO - SISTEMA MODULAR EDITALIZA\n\n## üìã OVERVIEW\n\nEste guia descreve como integrar a nova arquitetura modular com o server.js monol√≠tico existente, PRESERVANDO toda funcionalidade e seguran√ßa.\n\n## üèóÔ∏è ESTRUTURA CRIADA\n\n```\n/src\n  /config\n    - app.config.js          ‚úÖ CRIADO - Configura√ß√µes centralizadas\n    - environment.js         ‚úÖ EXISTIA - Mantido para compatibilidade\n    - logger-config.js       ‚úÖ EXISTIA - Mantido\n    - passport.js           ‚úÖ EXISTIA - Mantido\n  \n  /utils\n    - logger.js             ‚úÖ ATUALIZADO - Sistema robusto + backward compatibility\n  \n  /middleware\n    - auth.middleware.js    ‚úÖ CRIADO - Autentica√ß√£o robusta\n    - validation.middleware.js ‚úÖ CRIADO - Valida√ß√£o e sanitiza√ß√£o\n    - metrics.js            ‚úÖ EXISTIA - Mantido\n  \n  /routes\n    - auth.routes.js        ‚úÖ CRIADO - Rotas de autentica√ß√£o padronizadas\n  \n  /controllers\n    - auth.controller.js    ‚úÖ CRIADO - L√≥gica de neg√≥cio de autentica√ß√£o\n```\n\n## üîß DEPEND√äNCIAS NECESS√ÅRIAS\n\n### Instalar novas depend√™ncias:\n```bash\nnpm install winston winston-daily-rotate-file xss\n```\n\n### Depend√™ncias j√° existentes (verificar):\n- express-validator ‚úÖ\n- bcryptjs ‚úÖ\n- jsonwebtoken ‚úÖ\n- express-rate-limit ‚úÖ\n- passport ‚úÖ\n- helmet ‚úÖ\n- cors ‚úÖ\n\n## üìù ETAPAS DE INTEGRA√á√ÉO\n\n### 1Ô∏è‚É£ FASE 1 - PREPARA√á√ÉO (SEM BREAKING CHANGES)\n\n```javascript\n// NO TOPO DO server.js, ADICIONAR:\nconst appConfig = require('./src/config/app.config');\nconst { createLogger, httpLoggingMiddleware } = require('./src/utils/logger');\nconst { sanitizeMiddleware } = require('./src/middleware/validation.middleware');\n\n// SUBSTITUIR logger existente por:\nconst logger = createLogger('server');\n\n// ADICIONAR ap√≥s middlewares existentes:\napp.use(httpLoggingMiddleware());\napp.use(sanitizeMiddleware);\n```\n\n### 2Ô∏è‚É£ FASE 2 - INTEGRA√á√ÉO DAS ROTAS DE AUTH\n\n```javascript\n// ADICIONAR no server.js AP√ìS middlewares de seguran√ßa:\nconst authRoutes = require('./src/routes/auth.routes');\n\n// USAR as novas rotas:\napp.use('/api/auth', authRoutes);\n\n// COMENTAR/REMOVER as rotas antigas:\n// app.post('/api/login', ...)\n// app.post('/api/register', ...)\n// app.post('/api/logout', ...)\n// etc.\n```\n\n### 3Ô∏è‚É£ FASE 3 - SUBSTITUI√á√ÉO DO MIDDLEWARE DE AUTH\n\n```javascript\n// SUBSTITUIR fun√ß√£o authenticateToken existente por:\nconst { authenticateToken, requireAdmin, requireUser } = require('./src/middleware/auth.middleware');\n\n// USAR nos endpoints:\napp.get('/api/profile', authenticateToken(), (req, res) => {\n    // c√≥digo existente\n});\n\napp.get('/admin/*', requireAdmin, (req, res) => {\n    // c√≥digo admin\n});\n```\n\n### 4Ô∏è‚É£ FASE 4 - MIGRA√á√ÉO GRADUAL DOS CONTROLLERS\n\nCriar controllers para:\n- Plans (src/controllers/plans.controller.js)\n- Schedules (src/controllers/schedules.controller.js)  \n- Statistics (src/controllers/statistics.controller.js)\n\n## üîí SEGURAN√áA PRESERVADA\n\n### ‚úÖ Funcionalidades mantidas:\n- [x] CSRF protection\n- [x] Rate limiting diferenciado\n- [x] JWT + Refresh tokens\n- [x] Session management\n- [x] Password hashing (bcrypt)\n- [x] Input sanitization (XSS)\n- [x] SQL injection prevention\n- [x] CORS configurado\n- [x] Helmet security headers\n- [x] Google OAuth\n\n### üÜï Melhorias adicionadas:\n- [x] Logging estruturado com Winston\n- [x] Token blacklist\n- [x] Session concurrency control\n- [x] Advanced rate limiting por usu√°rio\n- [x] Malicious pattern detection\n- [x] IP blacklisting autom√°tico\n- [x] Request context tracking\n- [x] Health checks\n\n## üöß ROTAS PADRONIZADAS\n\n### Antigas ‚Üí Novas\n```\n‚ùå POST /api/login          ‚Üí ‚úÖ POST /api/auth/login\n‚ùå POST /api/register       ‚Üí ‚úÖ POST /api/auth/register\n‚ùå POST /api/logout         ‚Üí ‚úÖ POST /api/auth/logout\n‚ùå GET /api/csrf-token      ‚Üí ‚úÖ GET /api/auth/csrf-token\n‚ùå POST /api/request-password-reset ‚Üí ‚úÖ POST /api/auth/password/request\n‚ùå POST /api/reset-password ‚Üí ‚úÖ POST /api/auth/password/reset\n‚ùå GET /auth/google         ‚Üí ‚úÖ GET /api/auth/google\n‚ùå GET /auth/google/callback ‚Üí ‚úÖ GET /api/auth/google/callback\n```\n\n## üîÑ PROCESSO DE MIGRA√á√ÉO SEGURA\n\n### Estrat√©gia \"Blue-Green\" para rotas:\n\n1. **Manter rotas antigas funcionando**\n2. **Adicionar rotas novas em paralelo**\n3. **Testar funcionalidade completa**\n4. **Migrar frontend gradualmente**\n5. **Remover rotas antigas ap√≥s confirma√ß√£o**\n\n### Exemplo de coexist√™ncia:\n```javascript\n// server.js\n// ‚úÖ Rotas novas (preferidas)\napp.use('/api/auth', authRoutes);\n\n// ‚ö†Ô∏è Rotas antigas (deprecated, mas funcionando)\napp.post('/api/login', (req, res) => {\n    logger.warn('Deprecated route used: /api/login. Use /api/auth/login instead');\n    // Redirecionar para nova rota ou manter funcionando\n});\n```\n\n## üìä LOGGING E MONITORAMENTO\n\n### Logs estruturados dispon√≠veis:\n```javascript\n// No controller/middleware:\nconst logger = createLogger('auth'); // categoria\n\nlogger.info('User login attempt', { email, ip: req.ip });\nlogger.security('Suspicious activity detected', { userId, pattern });\nlogger.performance('Database query', duration);\nlogger.database('SELECT * FROM users', params, duration);\n```\n\n### Logs ser√£o salvos em:\n- `logs/app-YYYY-MM-DD.log` - Logs gerais\n- `logs/error-YYYY-MM-DD.log` - Apenas erros\n- `logs/access-YYYY-MM-DD.log` - Logs de acesso (produ√ß√£o)\n\n## üß™ TESTES DE INTEGRA√á√ÉO\n\n### 1. Testar autentica√ß√£o:\n```bash\n# Login\ncurl -X POST http://localhost:3000/api/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"test@test.com\",\"password\":\"Test123!@#\"}'\n\n# Profile\ncurl -X GET http://localhost:3000/api/auth/me \\\n  -H \"Authorization: Bearer YOUR_TOKEN\"\n```\n\n### 2. Verificar logs:\n```bash\ntail -f logs/app-$(date +%Y-%m-%d).log\n```\n\n### 3. Health checks:\n```bash\ncurl http://localhost:3000/api/auth/health\n```\n\n## ‚ö†Ô∏è PONTOS DE ATEN√á√ÉO\n\n### üî¥ CR√çTICO - N√ÉO ESQUECER:\n1. **Vari√°veis de ambiente** - Verificar se todas est√£o definidas\n2. **Banco de dados** - As rotas assumem PostgreSQL, ajustar conforme necess√°rio\n3. **Frontend** - Atualizar URLs das chamadas API\n4. **CORS** - Verificar se origins est√£o corretos\n5. **Cookies** - Verificar dom√≠nios em produ√ß√£o\n\n### üü° ATEN√á√ÉO - CONFIGURAR:\n1. **Email service** - Para password reset funcionar\n2. **Redis** - Para produ√ß√£o (cache e blacklists)\n3. **Winston** - Logs em arquivo (instalar winston-daily-rotate-file)\n4. **Rate limiting** - Ajustar limites por ambiente\n\n## üîß TROUBLESHOOTING\n\n### Erro: \"Cannot find module 'winston-daily-rotate-file'\"\n```bash\nnpm install winston-daily-rotate-file\n```\n\n### Erro: \"JWT_SECRET is required in production\"\n```bash\n# Adicionar no .env\nJWT_SECRET=your-super-secret-key-here\nSESSION_SECRET=your-session-secret-here\n```\n\n### Logs n√£o aparecem:\n```bash\n# Criar diret√≥rio de logs\nmkdir logs\n# Verificar permiss√µes\nchmod 755 logs\n```\n\n### CORS errors:\n```javascript\n// Verificar configura√ß√£o no app.config.js\ncors: {\n    origin: ['http://localhost:3000', 'https://app.editaliza.com.br'],\n    credentials: true\n}\n```\n\n## üéØ PR√ìXIMOS PASSOS\n\n### Ap√≥s integra√ß√£o do Auth:\n1. **Criar plans.controller.js** - Migrar l√≥gica de planos\n2. **Criar schedules.controller.js** - Migrar cronogramas\n3. **Criar statistics.controller.js** - Migrar estat√≠sticas\n4. **Criar database.service.js** - Centralizar queries\n5. **Criar email.service.js** - Centralizar emails\n6. **Implementar testes automatizados**\n7. **Setup CI/CD pipeline**\n\n### Performance optimizations:\n1. **Redis integration** para cache\n2. **Database connection pooling**\n3. **Query optimization**\n4. **CDN para assets est√°ticos**\n5. **Gzip compression**\n\n## üèÜ BENEF√çCIOS ALCAN√áADOS\n\n- ‚úÖ **C√≥digo mais limpo e organizado**\n- ‚úÖ **Melhor testabilidade**\n- ‚úÖ **Logs estruturados e profissionais**\n- ‚úÖ **Seguran√ßa aprimorada**\n- ‚úÖ **Maior facilidade de manuten√ß√£o**\n- ‚úÖ **Preparado para escalonamento**\n- ‚úÖ **Documenta√ß√£o clara**\n- ‚úÖ **Padr√µes da ind√∫stria**\n\n---\n\n**üí° DICA**: Integre uma funcionalidade por vez e teste completamente antes de prosseguir para a pr√≥xima!\n\n**üö® IMPORTANTE**: Sempre fa√ßa backup do server.js antes de fazer modifica√ß√µes!